/*! cornerstone-tools - 6.0.6-a - 2022-03-11 | (c) 2017 Chris Hafey | https://github.com/cornerstonejs/cornerstoneTools */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cornerstone-tools",[],t):"object"==typeof exports?exports["cornerstone-tools"]=t():e.cornerstoneTools=t()}(window,(function(){return function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=25)}([function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}e.exports=function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}},function(e,t,n){var a=n(14);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}},function(e,t,n){var a=n(8),o=n(5);e.exports=function(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?o(e):t}},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var a=n(16),o=n(17),r=n(18);e.exports=function(e){return a(e)||o(e)||r()}},function(e,t,n){var a=n(20),o=n(21),r=n(22);e.exports=function(e,t){return a(e)||o(e,t)||r()}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=a=function(e){return n(e)}:e.exports=a=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},a(t)}e.exports=a},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){"use strict";(function(e){var a=n(12),o={formatArgs:function(e){if(e[0]="".concat((this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" "),"+").concat(r.humanize(this.diff)),!this.useColors)return;var t="color: ".concat(this.color);e.splice(1,0,t,"color: inherit");var n=0,a=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(n++,"%c"===e&&(a=n))})),e.splice(a,0,t)},save:function(e){try{e?o.storage.setItem("debug",e):o.storage.removeItem("debug")}catch(e){}},load:function(){var t;try{t=o.storage.getItem("debug")}catch(e){}!t&&void 0!==e&&"env"in e&&(t=e.env.DEBUG);return t},useColors:function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},storage:function(){try{return localStorage}catch(e){}}()};o.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],o.log=console.debug||console.log||function(){};var r=Object(a.a)(o);r.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: ".concat(e.message)}},t.a=r}).call(this,n(15))},function(e,t,n){e.exports=n(23)},function(e,t,n){"use strict";var a=n(6),o=n.n(a);t.a=function(e){function t(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return a.colors[Math.abs(t)%a.colors.length]}function a(e){var n;function o(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(o.enabled){var i=o,l=Number(new Date),s=l-(n||l);i.diff=s,i.prev=n,i.curr=l,n=l,t[0]=a.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");var c=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,(function(e,n){if("%%"===e)return e;c++;var o=a.formatters[n];if("function"==typeof o){var r=t[c];e=o.call(i,r),t.splice(c,1),c--}return e})),a.formatArgs.call(i,t);var u=i.log||a.log;u.apply(i,t)}}return o.namespace=e,o.enabled=a.enabled(e),o.useColors=a.useColors(),o.color=t(e),o.destroy=r,o.extend=i,"function"==typeof a.init&&a.init(o),a.instances.push(o),o}function r(){var e=a.instances.indexOf(this);return-1!==e&&(a.instances.splice(e,1),!0)}function i(e,t){var n=a(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function l(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return a.debug=a,a.default=a,a.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},a.disable=function(){var e=[].concat(o()(a.names.map(l)),o()(a.skips.map(l).map((function(e){return"-".concat(e)})))).join(",");return a.enable(""),e},a.enable=function(e){var t;a.save(e),a.names=[],a.skips=[];var n=("string"==typeof e?e:"").split(/[\s,]+/),o=n.length;for(t=0;t<o;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?a.skips.push(new RegExp("^".concat(e.substr(1),"$"))):a.names.push(new RegExp("^".concat(e,"$"))));for(t=0;t<a.instances.length;t++){var r=a.instances[t];r.enabled=a.enabled(r.namespace)}},a.enabled=function(e){if("*"===e[e.length-1])return!0;var t,n;for(t=0,n=a.skips.length;t<n;t++)if(a.skips[t].test(e))return!1;for(t=0,n=a.names.length;t<n;t++)if(a.names[t].test(e))return!0;return!1},a.humanize=n(19),Object.keys(e).forEach((function(t){a[t]=e[t]})),a.instances=[],a.names=[],a.skips=[],a.formatters={},a.selectColor=t,a.enable(a.load()),a}},function(e,t){function n(e,t,n,a,o,r,i){try{var l=e[r](i),s=l.value}catch(e){return void n(e)}l.done?t(s):Promise.resolve(s).then(a,o)}e.exports=function(e){return function(){var t=this,a=arguments;return new Promise((function(o,r){var i=e.apply(t,a);function l(e){n(i,o,r,l,s,"next",e)}function s(e){n(i,o,r,l,s,"throw",e)}l(void 0)}))}}},function(e,t){function n(t,a){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,a)}e.exports=n},function(e,t){var n,a,o=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===r||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:r}catch(e){n=r}try{a="function"==typeof clearTimeout?clearTimeout:i}catch(e){a=i}}();var s,c=[],u=!1,d=-1;function f(){u&&s&&(u=!1,s.length?c=s.concat(c):d=-1,c.length&&h())}function h(){if(!u){var e=l(f);u=!0;for(var t=c.length;t;){for(s=c,c=[];++d<t;)s&&s[d].run();d=-1,t=c.length}s=null,u=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===i||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function g(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new v(e,t)),1!==c.length||u||l(h)},v.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=g,o.addListener=g,o.once=g,o.off=g,o.removeListener=g,o.removeAllListeners=g,o.emit=g,o.prependListener=g,o.prependOnceListener=g,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t){e.exports=function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}},function(e,t){e.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(e,t){var n=1e3,a=6e4,o=60*a,r=24*o;function i(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}e.exports=function(e,t){t=t||{};var l,s=typeof e;if("string"===s&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"days":case"day":case"d":return i*r;case"hours":case"hour":case"hrs":case"hr":case"h":return i*o;case"minutes":case"minute":case"mins":case"min":case"m":return i*a;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===s&&!1===isNaN(e))return t.long?i(l=e,r,"day")||i(l,o,"hour")||i(l,a,"minute")||i(l,n,"second")||l+" ms":function(e){if(e>=r)return Math.round(e/r)+"d";if(e>=o)return Math.round(e/o)+"h";if(e>=a)return Math.round(e/a)+"m";if(e>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){var n=[],a=!0,o=!1,r=void 0;try{for(var i,l=e[Symbol.iterator]();!(a=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(e){o=!0,r=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw r}}return n}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,n){var a=function(){return this||"object"==typeof self&&self}()||Function("return this")(),o=a.regeneratorRuntime&&Object.getOwnPropertyNames(a).indexOf("regeneratorRuntime")>=0,r=o&&a.regeneratorRuntime;if(a.regeneratorRuntime=void 0,e.exports=n(24),o)a.regeneratorRuntime=r;else try{delete a.regeneratorRuntime}catch(e){a.regeneratorRuntime=void 0}},function(e,t){!function(t){"use strict";var n=Object.prototype,a=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},r=o.iterator||"@@iterator",i=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag",s="object"==typeof e,c=t.regeneratorRuntime;if(c)s&&(e.exports=c);else{(c=t.regeneratorRuntime=s?e.exports:{}).wrap=g;var u={},d={};d[r]=function(){return this};var f=Object.getPrototypeOf,h=f&&f(f(I([])));h&&h!==n&&a.call(h,r)&&(d=h);var v=x.prototype=p.prototype=Object.create(d);y.prototype=v.constructor=x,x.constructor=y,x[l]=y.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l in e||(e[l]="GeneratorFunction")),e.prototype=Object.create(v),e},c.awrap=function(e){return{__await:e}},T(b.prototype),b.prototype[i]=function(){return this},c.AsyncIterator=b,c.async=function(e,t,n,a){var o=new b(g(e,t,n,a));return c.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},T(v),v[l]="Generator",v[r]=function(){return this},v.toString=function(){return"[object Generator]"},c.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},c.values=I,w.prototype={constructor:w,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,a){return i.type="throw",i.arg=e,t.next=n,a&&(t.method="next",t.arg=void 0),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var r=this.tryEntries[o],i=r.completion;if("root"===r.tryLoc)return n("end");if(r.tryLoc<=this.prev){var l=a.call(r,"catchLoc"),s=a.call(r,"finallyLoc");if(l&&s){if(this.prev<r.catchLoc)return n(r.catchLoc,!0);if(this.prev<r.finallyLoc)return n(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return n(r.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return n(r.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&a.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var r=o;break}}r&&("break"===e||"continue"===e)&&r.tryLoc<=t&&t<=r.finallyLoc&&(r=null);var i=r?r.completion:{};return i.type=e,i.arg=t,r?(this.method="next",this.next=r.finallyLoc,u):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),E(n),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var o=a.arg;E(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),u}}}function g(e,t,n,a){var o=t&&t.prototype instanceof p?t:p,r=Object.create(o.prototype),i=new w(a||[]);return r._invoke=function(e,t,n){var a="suspendedStart";return function(o,r){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===o)throw r;return S()}for(n.method=o,n.arg=r;;){var i=n.delegate;if(i){var l=C(i,n);if(l){if(l===u)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===a)throw a="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a="executing";var s=m(e,t,n);if("normal"===s.type){if(a=n.done?"completed":"suspendedYield",s.arg===u)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(a="completed",n.method="throw",n.arg=s.arg)}}}(e,n,i),r}function m(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function p(){}function y(){}function x(){}function T(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function b(e){var t;this._invoke=function(n,o){function r(){return new Promise((function(t,r){!function t(n,o,r,i){var l=m(e[n],e,o);if("throw"!==l.type){var s=l.arg,c=s.value;return c&&"object"==typeof c&&a.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,r,i)}),(function(e){t("throw",e,r,i)})):Promise.resolve(c).then((function(e){s.value=e,r(s)}),(function(e){return t("throw",e,r,i)}))}i(l.arg)}(n,o,t,r)}))}return t=t?t.then(r,r):r()}}function C(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,C(e,t),"throw"===t.method))return u;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return u}var a=m(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,u;var o=a.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function M(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function w(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(M,this),this.reset(!0)}function I(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(a.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:S}}function S(){return{value:void 0,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())},function(e,t,n){"use strict";n.r(t),n.d(t,"AngleTool",(function(){return fr})),n.d(t,"ArrowAnnotateTool",(function(){return mr})),n.d(t,"BidirectionalTool",(function(){return ti})),n.d(t,"CircleRoiTool",(function(){return di})),n.d(t,"CobbAngleTool",(function(){return mi})),n.d(t,"EllipticalRoiTool",(function(){return xi})),n.d(t,"FreehandRoiTool",(function(){return Yi})),n.d(t,"LengthTool",(function(){return $i})),n.d(t,"ProbeTool",(function(){return tl})),n.d(t,"RectangleRoiTool",(function(){return ol})),n.d(t,"TextMarkerTool",(function(){return ul})),n.d(t,"BrushTool",(function(){return vl})),n.d(t,"SphericalBrushTool",(function(){return yl})),n.d(t,"RectangleScissorsTool",(function(){return Jl})),n.d(t,"FreehandScissorsTool",(function(){return Zl})),n.d(t,"CircleScissorsTool",(function(){return es})),n.d(t,"CorrectionScissorsTool",(function(){return ns})),n.d(t,"CrosshairsTool",(function(){return fs})),n.d(t,"DoubleTapFitToWindowTool",(function(){return vs})),n.d(t,"DragProbeTool",(function(){return ms})),n.d(t,"EraserTool",(function(){return Ts})),n.d(t,"FreehandRoiSculptorTool",(function(){return Ms})),n.d(t,"MagnifyTool",(function(){return Is})),n.d(t,"OverlayTool",(function(){return _s})),n.d(t,"OrientationMarkersTool",(function(){return Os})),n.d(t,"PanMultiTouchTool",(function(){return Bs})),n.d(t,"PanTool",(function(){return Fs})),n.d(t,"ReferenceLinesTool",(function(){return Zs})),n.d(t,"RotateTool",(function(){return Qs})),n.d(t,"RotateTouchTool",(function(){return oc})),n.d(t,"ScaleOverlayTool",(function(){return lc})),n.d(t,"StackScrollMouseWheelTool",(function(){return gc})),n.d(t,"StackScrollMultiTouchTool",(function(){return pc})),n.d(t,"StackScrollTool",(function(){return xc})),n.d(t,"WwwcRegionTool",(function(){return Cc})),n.d(t,"WwwcTool",(function(){return Sc})),n.d(t,"ZoomMouseWheelTool",(function(){return Oc})),n.d(t,"ZoomTool",(function(){return Hc})),n.d(t,"ZoomTouchPinchTool",(function(){return jc})),n.d(t,"init",(function(){return Jd})),n.d(t,"stackPrefetch",(function(){return cf})),n.d(t,"stackRenderers",(function(){return ff})),n.d(t,"playClip",(function(){return vf})),n.d(t,"stopClip",(function(){return gf})),n.d(t,"store",(function(){return bt})),n.d(t,"getModule",(function(){return Tt})),n.d(t,"getToolForElement",(function(){return Ct})),n.d(t,"addTool",(function(){return Ud})),n.d(t,"addToolForElement",(function(){return Hd})),n.d(t,"removeTool",(function(){return pf})),n.d(t,"removeToolForElement",(function(){return mf})),n.d(t,"setToolOptions",(function(){return Tf})),n.d(t,"setToolOptionsForElement",(function(){return xf})),n.d(t,"isToolActiveForElement",(function(){return Ia})),n.d(t,"setToolActive",(function(){return Pt})),n.d(t,"setToolActiveForElement",(function(){return _t})),n.d(t,"setToolEnabled",(function(){return Rt})),n.d(t,"setToolEnabledForElement",(function(){return Lt})),n.d(t,"setToolDisabled",(function(){return Ot})),n.d(t,"setToolDisabledForElement",(function(){return Dt})),n.d(t,"setToolPassive",(function(){return Ht})),n.d(t,"setToolPassiveForElement",(function(){return At})),n.d(t,"addToolState",(function(){return D})),n.d(t,"getToolState",(function(){return O})),n.d(t,"removeToolState",(function(){return L})),n.d(t,"clearToolState",(function(){return R})),n.d(t,"setElementToolStateManager",(function(){return A})),n.d(t,"getElementToolStateManager",(function(){return P})),n.d(t,"textStyle",(function(){return pn})),n.d(t,"toolStyle",(function(){return Xt})),n.d(t,"toolColors",(function(){return un})),n.d(t,"toolCoordinates",(function(){return Pr})),n.d(t,"stackSpecificStateManager",(function(){return Ef})),n.d(t,"newStackSpecificToolStateManager",(function(){return bf})),n.d(t,"addStackStateManager",(function(){return Mf})),n.d(t,"loadHandlerManager",(function(){return ls})),n.d(t,"newImageIdSpecificToolStateManager",(function(){return k})),n.d(t,"globalImageIdSpecificToolStateManager",(function(){return _})),n.d(t,"newFrameOfReferenceSpecificToolStateManager",(function(){return wf})),n.d(t,"globalFrameOfReferenceSpecificToolStateManager",(function(){return If})),n.d(t,"forceEnabledElementResize",(function(){return Zd})),n.d(t,"orientation",(function(){return Ps})),n.d(t,"SaveAs",(function(){return Sf})),n.d(t,"enableLogger",(function(){return N})),n.d(t,"disableLogger",(function(){return F})),n.d(t,"register",(function(){return Ff})),n.d(t,"registerSome",(function(){return qf})),n.d(t,"wwwcSynchronizer",(function(){return jf})),n.d(t,"updateImageSynchronizer",(function(){return zf})),n.d(t,"Synchronizer",(function(){return Gf})),n.d(t,"stackScrollSynchronizer",(function(){return Yf})),n.d(t,"stackImagePositionSynchronizer",(function(){return Xf})),n.d(t,"stackImagePositionOffsetSynchronizer",(function(){return Kf})),n.d(t,"stackImageIndexSynchronizer",(function(){return Zf})),n.d(t,"panZoomSynchronizer",(function(){return $f})),n.d(t,"importInternal",(function(){return Qf})),n.d(t,"external",(function(){return y})),n.d(t,"EVENTS",(function(){return b})),n.d(t,"version",(function(){return Jf})),n.d(t,"import",(function(){return Qf}));var a={};n.r(a),n.d(a,"drawBrushPixels",(function(){return te})),n.d(a,"eraseIfSegmentIndex",(function(){return ee})),n.d(a,"eraseOutsideBoundingBox",(function(){return ne})),n.d(a,"eraseInsideShape",(function(){return le})),n.d(a,"eraseOutsideShape",(function(){return se})),n.d(a,"fillOutsideBoundingBox",(function(){return ce})),n.d(a,"fillInsideShape",(function(){return fe})),n.d(a,"fillOutsideShape",(function(){return he})),n.d(a,"floodFill",(function(){return ve})),n.d(a,"getBoundingBoxAroundCircle",(function(){return xe})),n.d(a,"getBoundingBoxAroundPolygon",(function(){return Te})),n.d(a,"getCircle",(function(){return be})),n.d(a,"getPixelPathBetweenPixels",(function(){return Ee})),n.d(a,"isSameSegment",(function(){return re})),n.d(a,"triggerLabelmapModifiedEvent",(function(){return Oe})),n.d(a,"getDiffBetweenPixelData",(function(){return Le}));var o={};n.r(o),n.d(o,"angleCursor",(function(){return Co})),n.d(o,"arrowAnnotateCursor",(function(){return Mo})),n.d(o,"bidirectionalCursor",(function(){return Eo})),n.d(o,"cobbAngleCursor",(function(){return wo})),n.d(o,"circleRoiCursor",(function(){return Io})),n.d(o,"ellipticalRoiCursor",(function(){return So})),n.d(o,"freehandRoiCursor",(function(){return ko})),n.d(o,"freehandRoiSculptorCursor",(function(){return _o})),n.d(o,"lengthCursor",(function(){return Po})),n.d(o,"probeCursor",(function(){return Do})),n.d(o,"rectangleRoiCursor",(function(){return Oo})),n.d(o,"textMarkerCursor",(function(){return Lo})),n.d(o,"crosshairsCursor",(function(){return Ro})),n.d(o,"eraserCursor",(function(){return Ao})),n.d(o,"magnifyCursor",(function(){return Ho})),n.d(o,"panCursor",(function(){return Uo})),n.d(o,"rotateCursor",(function(){return Bo})),n.d(o,"stackScrollCursor",(function(){return No})),n.d(o,"wwwcRegionCursor",(function(){return Fo})),n.d(o,"wwwcCursor",(function(){return Vo})),n.d(o,"zoomCursor",(function(){return qo})),n.d(o,"freehandEraseInsideCursor",(function(){return Ko})),n.d(o,"freehandFillInsideCursor",(function(){return Zo})),n.d(o,"freehandEraseOutsideCursor",(function(){return $o})),n.d(o,"freehandFillOutsideCursor",(function(){return Jo})),n.d(o,"segRectangleEraseInsideCursor",(function(){return Qo})),n.d(o,"segRectangleFillInsideCursor",(function(){return er})),n.d(o,"segRectangleEraseOutsideCursor",(function(){return tr})),n.d(o,"segRectangleFillOutsideCursor",(function(){return nr})),n.d(o,"segCircleEraseInsideCursor",(function(){return ar})),n.d(o,"segCircleFillInsideCursor",(function(){return or})),n.d(o,"segCircleEraseOutsideCursor",(function(){return rr})),n.d(o,"segCircleFillOutsideCursor",(function(){return ir}));var r=n(1),i=n.n(r),l=n(2),s=n.n(l),c=n(3),u=n.n(c),d=n(4),f=n.n(d),h=n(0),v=n.n(h),g=window.cornerstone,m=window.cornerstoneMath,p=window.Hammer,y={set cornerstone(e){g=e},get cornerstone(){return g},set cornerstoneMath(e){m=e},get cornerstoneMath(){return m},set Hammer(e){p=e},get Hammer(){return p}},x=n(8),T=n.n(x),b={MOUSE_DOWN:"cornerstonetoolsmousedown",MOUSE_UP:"cornerstonetoolsmouseup",MOUSE_DOWN_ACTIVATE:"cornerstonetoolsmousedownactivate",MOUSE_DRAG:"cornerstonetoolsmousedrag",MOUSE_MOVE:"cornerstonetoolsmousemove",MOUSE_CLICK:"cornerstonetoolsmouseclick",MOUSE_DOUBLE_CLICK:"cornerstonetoolsmousedoubleclick",MOUSE_WHEEL:"cornerstonetoolsmousewheel",TOUCH_START:"cornerstonetoolstouchstart",TOUCH_START_ACTIVE:"cornerstonetoolstouchstartactive",TOUCH_END:"cornerstonetoolstouchend",TOUCH_DRAG:"cornerstonetoolstouchdrag",TOUCH_DRAG_END:"cornerstonetoolstouchdragend",TOUCH_PINCH:"cornerstonetoolstouchpinch",TOUCH_ROTATE:"cornerstonetoolstouchrotate",TOUCH_PRESS:"cornerstonetoolstouchpress",TAP:"cornerstonetoolstap",DOUBLE_TAP:"cornerstonetoolsdoubletap",MULTI_TOUCH_START:"cornerstonetoolsmultitouchstart",MULTI_TOUCH_START_ACTIVE:"cornerstonetoolsmultitouchstartactive",MULTI_TOUCH_DRAG:"cornerstonetoolsmultitouchdrag",KEY_DOWN:"cornerstonetoolskeydown",KEY_UP:"cornerstonetoolskeyup",KEY_PRESS:"cornerstonetoolskeypress",MEASUREMENT_ADDED:"cornerstonetoolsmeasurementadded",MEASUREMENT_MODIFIED:"cornerstonetoolsmeasurementmodified",MEASUREMENT_COMPLETED:"cornerstonetoolsmeasurementcompleted",MEASUREMENT_REMOVED:"cornerstonetoolsmeasurementremoved",TOOL_DEACTIVATED:"cornerstonetoolstooldeactivated",CLIP_STOPPED:"cornerstonetoolsclipstopped",STACK_SCROLL:"cornerstonetoolsstackscroll",STACK_PREFETCH_IMAGE_LOADED:"cornerstonetoolsstackprefetchimageloaded",STACK_PREFETCH_DONE:"cornerstonetoolsstackprefetchdone",LABELMAP_MODIFIED:"cornersontetoolslabelmapmodified"};function C(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return"function"==typeof window.CustomEvent?n=new CustomEvent(t,{detail:a,cancelable:!0}):(n=document.createEvent("CustomEvent")).initCustomEvent(t,!0,!0,a),e.dispatchEvent(n)}function M(e){return e instanceof HTMLElement?e:yt.enabledElementByUID(e)}var E={UINT_16_ARRAY:0,FLOAT_32_ARRAY:1},w=E.UINT_16_ARRAY,I=E.FLOAT_32_ARRAY;function S(e,t,n){var a,o=Tt("segmentation").configuration;switch(o.arrayType){case w:a=2;break;case I:a=4;break;default:throw new Error("Unsupported Array Type ".concat(o.arrayType))}e.labelmaps3D[t]={buffer:new ArrayBuffer(n*a),labelmaps2D:[],metadata:[],activeSegmentIndex:1,colorLUTIndex:0,segmentsHidden:[],undo:[],redo:[]}}function k(){var e={};function t(t,n,a){!1===e.hasOwnProperty(t)&&(e[t]={});var o=e[t];!1===o.hasOwnProperty(n)&&(o[n]={data:[]}),o[n].data.push(a)}function n(t,n){if(!1!==e.hasOwnProperty(t)){var a=e[t];if(!1!==a.hasOwnProperty(n))return a[n]}}function a(t,n,a){e[t][n]=a}function o(t){!1!==e.hasOwnProperty(t)&&delete e[t]}return{get:function(e,t){var a=y.cornerstone.getEnabledElement(e);if(a.image)return n(a.image.imageId,t)},add:function(e,n,a){var o=y.cornerstone.getEnabledElement(e);o.image&&t(o.image.imageId,n,a)},set:function(e,t,n){var o=y.cornerstone.getEnabledElement(e);o.image&&a(o.image.imageId,t,n)},clear:function(e){var t=y.cornerstone.getEnabledElement(e);t.image&&o(t.image.imageId)},getImageIdToolState:n,addImageIdToolState:t,setImageIdToolState:a,clearImageIdToolState:o,saveImageIdToolState:function(t){return e[t]},restoreImageIdToolState:function(t,n){e[t]=n},saveToolState:function(){return e},restoreToolState:function(t){e=t},toolState:e}}var _=k();function P(e){var t=y.cornerstone.getEnabledElement(e);return void 0===t.toolStateManager&&(t.toolStateManager=_),t.toolStateManager}function D(e,t,n){var a=P(e);n.uuid=n.uuid||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),a.add(e,t,n),C(e,b.MEASUREMENT_ADDED,{toolName:t,toolType:t,element:e,measurementData:n})}function O(e,t){return P(e).get(e,t)}function L(e,t,n){var a=P(e).get(e,t);if(a&&a.data&&a.data.length){for(var o=-1,r=0;r<a.data.length;r++)a.data[r]===n&&(o=r);if(-1!==o)a.data.splice(o,1),C(e,b.MEASUREMENT_REMOVED,{toolName:t,toolType:t,element:e,measurementData:n})}}function R(e,t){var n=P(e).get(e,t);void 0!==n&&(n.data=[])}function A(e,t){y.cornerstone.getEnabledElement(e).toolStateManager=t}var H=n(10),U=Object(H.a)("cornerstoneTools");var B=function(e){var t=U.extend(e);return{log:t,warn:t,error:void 0}},N=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"".concat("cornerstoneTools",":*");return H.a.enable(e)},F=function(){return H.a.disable()},V={series:{},colorLutTables:[]},q=B("store:modules:segmentationModule:metadata");function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"increase",n=Tt("segmentation"),a=n.configuration,o=O(e,"stack"),r=o.data[0],i=r.imageIds[0],l=V.series[i];if(l){var s=l.activeLabelmapIndex,c=l.labelmaps3D[s];switch(t){case"increase":c.activeSegmentIndex++,c.activeSegmentIndex>a.segmentsPerLabelmap&&(c.activeSegmentIndex=1);break;case"decrease":c.activeSegmentIndex--,c.activeSegmentIndex<=0&&(c.activeSegmentIndex=a.segmentsPerLabelmap)}}}var z=B("store:modules:segmentationModule:segmentVisibility");var W=B("store:modules:segmentationModule:getLabelmaps3D");function G(e){var t=M(e);if(t){var n=O(t,"stack");if(n){var a,o,r=n.data[0],i=r.imageIds[0],l=V.series[i];return l&&(a=l.labelmaps3D,o=l.activeLabelmapIndex),{labelmaps3D:a,activeLabelmapIndex:o,currentImageIdIndex:r.currentImageIdIndex}}W.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.")}}function Y(e,t){var n=G(e),a=n.labelmaps3D,o=n.activeLabelmapIndex;return a[t=void 0!==t?t:o]}var X=E.UINT_16_ARRAY,K=E.FLOAT_32_ARRAY;function Z(e,t){var n=M(e);if(n){var a=G(n).labelmaps3D;if(!a)return[];var o,r,i=Tt("segmentation").configuration;switch(i.arrayType){case X:o="Uint16Array",r="2";break;case K:o="Float32Array",r="4";break;default:throw new Error("Unsupported Array Type ".concat(i.arrayType))}var l=V.colorLutTables;if(void 0!==t){var s=a[t];return s?{labelmapIndex:t,bytesPerVoxel:r,type:o,buffer:s.buffer,colorLUT:l[s.colorLUTIndex]}:void 0}for(var c=[],u=0;u<a.length;u++){var d=a[u];d&&c.push({labelmapIndex:u,bytesPerVoxel:2,buffer:d.buffer,colorLUT:l[d.colorLUTIndex]})}return c}}var $=n(6),J=n.n($);function Q(e){return J()(new Set(e))}function ee(e,t,n){t[e]===n&&(t[e]=0)}function te(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=function(e,t){return t*a+e};e.forEach((function(e){var a=r.apply(void 0,J()(e));o?ee(a,t,n):t[a]=n}))}function ne(e,t,n,a){for(var o=e.detail,r=t.pixelData,i=t.segmentIndex,l=o.image,s=l.width,c=l.height,u=0;u<s;u++)for(var d=0;d<n[1];d++)ee(d*s+u,r,i);for(var f=0;f<n[0];f++)for(var h=n[1];h<a[1];h++)ee(h*s+f,r,i);for(var v=a[0];v<s;v++)for(var g=n[1];g<a[1];g++)ee(g*s+v,r,i);for(var m=0;m<s;m++)for(var p=a[1];p<c;p++)ee(p*s+m,r,i)}var ae=n(7),oe=n.n(ae);function re(e,t,n){return t[e]===n}B("util:segmentation:operations:eraseOutsideCircle");function ie(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inside",i=e.detail.image.width,l=t.pixelData,s=t.segmentIndex,c=oe()(a,2),u=c[0],d=c[1],f=oe()(o,2),h=f[0],v=f[1];"outside"===r&&ne(e,t,a,o);for(var g=u;g<h;g++)for(var m=d;m<v;m++){var p=m*i+g;re(p,l,s)&&n({x:g,y:m})&&(l[p]=0)}}function le(e,t,n,a,o){ie(e,t,n,a,o,"inside")}function se(e,t,n,a,o){ie(e,t,(function(e){return!n(e)}),a,o,"outside")}function ce(e,t,n,a){for(var o=t.pixelData,r=t.segmentIndex,i=e.detail.image,l=i.width,s=i.height,c=0;c<l;c++)for(var u=0;u<n[1];u++)o[u*l+c]=r;for(var d=0;d<n[0];d++)for(var f=n[1];f<a[1];f++)o[f*l+d]=r;for(var h=a[0];h<l;h++)for(var v=n[1];v<a[1];v++)o[v*l+h]=r;for(var g=0;g<l;g++)for(var m=a[1];m<s;m++)o[m*l+g]=r}var ue=B("util:segmentation:operations:helpers:fillShape");function de(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"inside",i=t.pixelData,l=t.segmentIndex;if(void 0!==i&&void 0!==l){var s=e.detail.image.width,c=oe()(a,2),u=c[0],d=c[1],f=oe()(o,2),h=f[0],v=f[1];"outside"===r&&ce(e,t,a,o);for(var g=u;g<h;g++)for(var m=d;m<v;m++){var p=m*s+g;n({x:g,y:m})&&(i[p]=l)}}else ue.error("fillInsideShape requires operationData to contain pixelData and segmentIndex")}function fe(e,t,n,a,o){de(e,t,n,a,o,"inside")}function he(e,t,n,a,o){de(e,t,(function(e){return!n(e)}),a,o,"outside")}var ve=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=n.onFlood||function(){},o=n.onBoundary||function(){},r=n.equals||ge,i=n.diagonals||!1,l=T(t),s=C(),c=[],u=[],d={},f={};for(c.push({currentArgs:t});c.length>0;)h(c.pop());return{flooded:u,boundaries:E()};function h(e){var t=e.currentArgs,n=e.previousArgs;v(t)||(g(t),m(t)?(p(t),x(t)):y(n))}function v(e){return!0===d[e]}function g(e){d[e]=!0}function m(e){var t=b(T,[e]);return b(r,[t,l])}function p(e){u.push(e),a.apply(void 0,J()(e))}function y(e){f[e]=e,o.apply(void 0,J()(e))}function x(e){for(var t=0;t<s.length;t+=1){for(var n=s[t],a=e.slice(0),o=0;o<e.length;o+=1)a[o]+=n[o];c.push({currentArgs:a,previousArgs:e})}}function T(t){return e.apply(void 0,J()(t))}function b(e,t){try{return e.apply(void 0,J()(t))}catch(e){return}}function C(){return M(t.length).filter((function(e){var t=me(e);return 0!==t&&(1===t||i)}))}function M(e){for(var t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))},a=0;a<Math.pow(3,e);a+=1){var o=pe(a.toString(3),"0",e);t.push(n(o))}return t}function E(){var e=[];for(var t in f)f.hasOwnProperty(t)&&e.unshift(f[t]);return e}};function ge(e,t){return e===t}function me(e){for(var t=0,n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}function pe(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}function ye(e,t){var n=(0,y.cornerstoneMath.point.distance)(e,t);return{left:Math.floor(Math.min(e.x-n,t.x)),top:Math.floor(Math.min(e.y-n,t.y)),width:2*n,height:2*n}}function xe(e){var t=e.detail.handles,n=e.detail.image,a=n.width,o=n.height,r=ye(t.start,t.end),i=r.width+r.left,l=r.left,s=r.top+r.height,c=r.top;return l=Math.floor(l),c=Math.floor(c),i=Math.floor(i),s=Math.floor(s),i=Math.min(a,i),l=Math.max(0,l),s=Math.min(o,s),[[l,c=Math.max(0,c)],[i,s]]}function Te(e,t){var n=1/0,a=0,o=1/0,r=0,i=t.width,l=t.height;return e.forEach((function(e){n=Math.min(e[0],n),a=Math.max(e[0],a),o=Math.min(e[1],o),r=Math.max(e[1],r)})),n=Math.floor(n),o=Math.floor(o),a=Math.floor(a),r=Math.floor(r),a=Math.min(i,a),n=Math.max(0,n),r=Math.min(l,r),o=Math.max(0,o),[[n,o],[a,r]]}function be(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,r=Math.floor(a),i=Math.floor(o);if(1===e)return[[r,i]];for(var l=[],s=0,c=-e;c<=e;c++){var u=i+c;if(!(u>t||u<0))for(var d=-e;d<=e;d++){var f=r+d;f>=n||f<0||d*d+c*c<e*e&&(l[s++]=[r+d,i+c])}}return l}var Ce=1/Math.sqrt(2),Me={up:{x:0,y:1},upRight:{x:Ce,y:Ce},right:{x:1,y:0},downRight:{x:Ce,y:-Ce},down:{x:0,y:1},downLeft:{x:-Ce,y:-Ce},left:{x:-1,y:0},upLeft:{x:-Ce,y:Ce}},Ee=function(e,t){for(var n={x:e.x,y:e.y},a=[];t.x!==n.x||t.y!==n.y;)t.x===n.x?t.y>n.y?n.y++:n.y--:t.y===n.y?t.x>n.x?n.x++:n.x--:t.y>n.y?t.x>n.x?we(n,t):Ie(n,t):t.x>n.x?Se(n,t):ke(n,t),a.push({x:n.x,y:n.y});return a.pop(),a};function we(e,t){var n=_e(e,t);switch(De([Pe(n,Me.up),Pe(n,Me.right),Pe(n,Me.upRight)])){case 0:e.y++;break;case 1:e.x++;break;case 2:e.y++,e.x++}}function Ie(e,t){var n=_e(e,t);switch(De([Pe(n,Me.up),Pe(n,Me.left),Pe(n,Me.upLeft)])){case 0:e.y++;break;case 1:e.x--;break;case 2:e.y++,e.x--}}function Se(e,t){var n=_e(e,t);switch(De([Pe(n,Me.down),Pe(n,Me.right),Pe(n,Me.downRight)])){case 0:e.y--;break;case 1:e.x++;break;case 2:e.y--,e.x++}}function ke(e,t){var n=_e(e,t);switch(De([Pe(n,Me.down),Pe(n,Me.left),Pe(n,Me.downLeft)])){case 0:e.y--;break;case 1:e.x--;break;case 2:e.y--,e.x--}}function _e(e,t){var n=y.cornerstoneMath.point.distance(e,t);return{x:(t.x-e.x)/n,y:(t.y-e.y)/n}}function Pe(e,t){return e.x*t.x+e.y*t.y}function De(e){var t=e[0]>e[1]?0:1;return e[2]>e[t]&&(t=2),t}function Oe(e,t){var n=Tt("segmentation").getters;t=void 0===t?n.activeLabelmapIndex(e):t,y.cornerstone.triggerEvent(e,b.LABELMAP_MODIFIED,{labelmapIndex:t})}function Le(e,t){for(var n=[],a=0;a<e.length;a++)e[a]!==t[a]&&n.push([a,e[a],t[a]]);return n}var Re=E.UINT_16_ARRAY,Ae=E.FLOAT_32_ARRAY;function He(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4?arguments[4]:void 0,r=arguments.length>5?arguments[5]:void 0,i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=Tt("segmentation"),s=l.configuration,c=V.series[e];c||(V.series[e]={activeLabelmapIndex:n,labelmaps3D:[]},c=V.series[e]),c.labelmaps3D[n]={buffer:t,labelmaps2D:[],metadata:a,activeSegmentIndex:1,colorLUTIndex:i,segmentsHidden:[],undo:[],redo:[]};for(var u=c.labelmaps3D[n].labelmaps2D,d=t.byteLength/o,f=0;f<o;f++){var h=void 0;switch(s.arrayType){case Re:h=new Uint16Array(t,d*f,d/2);break;case Ae:h=new Float32Array(t,d*f,d/4);break;default:throw new Error("Unsupported Array Type ".concat(s.arrayType))}var v=r?r[f]:Q(h);v&&v.some((function(e){return e}))&&(u[f]={pixelData:h,segmentsOnLabelmap:v})}}var Ue=B("store:modules:segmentationModule:getLabelmapStats");function Be(e,t,n){var a=e.length,o=t[n].imagePositionPatient;if(0===n)return Ne(o,t[n+1].imagePositionPatient);if(n===a-1)return Ne(o,t[n-1].imagePositionPatient);var r=t[n-1].imagePositionPatient,i=t[n+1].imagePositionPatient;return(Ne(o,r)+Ne(o,i))/2}function Ne(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}var Fe=E.UINT_16_ARRAY,Ve=E.FLOAT_32_ARRAY;function qe(e,t,n,a,o){var r,i=Tt("segmentation").configuration,l=a*o,s=l*n;switch(i.arrayType){case Fe:r=new Uint16Array(e.labelmaps3D[t].buffer,2*s,l);break;case Ve:r=new Float32Array(e.labelmaps3D[t].buffer,4*s,l);break;default:throw new Error("Unsupported Array Type ".concat(i.arrayType))}e.labelmaps3D[t].labelmaps2D[n]={pixelData:r,segmentsOnLabelmap:[]}}var je=E.UINT_16_ARRAY,ze=E.FLOAT_32_ARRAY,We=B("store:modules:segmentationModule:getLabelmap2D");function Ge(e,t,n){var a=e.x,o=e.y;return a<n&&a>=0&&o<t&&o>=0}var Ye=B("store:modules:segmentationModule:getSegmentOfActiveLabelmapAtEvent");var Xe=B("store:modules:segmentationModule:setColorLUT");function Ke(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=Tt("segmentation"),a=n.configuration,o=a.segmentsPerLabelmap;t?($e(t,o),t.length<o&&(t=[].concat(J()(t),J()(Je(o-t.length))))):t=t||Je(o),t.unshift([0,0,0,0]),V.colorLutTables[e]=t}function Ze(e){return"number"==typeof e?V.colorLutTables[e]:V.colorLutTables[e.colorLUTIndex]}function $e(e,t){e.length<t?Xe.warn("The provided colorLUT only provides ".concat(e.length," labels, whereas segmentsPerLabelmap is set to ").concat(t,". Autogenerating the rest.")):e.length>t&&Xe.warn("segmentsPerLabelmap is set to ".concat(t,", and the provided colorLUT provides ").concat(e.length,". Using the first ").concat(t," colors from the LUT."))}function Je(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:255,t=[],n=0;n<e;n++)t.push(at(et(),nt()));return t}var Qe=222.5;function et(){return(Qe+=137.5)>=360&&(Qe-=360),Qe}var tt=.6;function nt(){(tt+=.07)>.82&&(tt=.3+(tt-.82));return tt}function at(e){var t,n,a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.6,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,l=(1-Math.abs(2*r-1))*o,s=l*(1-Math.abs(e/60%2-1)),c=r-l/2;return e<60?(t=l,n=s,a=0):e<120?(t=s,n=l,a=0):e<180?(t=0,n=l,a=s):e<240?(t=0,n=s,a=l):e<300?(t=s,n=0,a=l):e<360&&(t=l,n=0,a=s),[255*(t+c),255*(n+c),255*(a+c),i]}var ot=B("store:modules:segmentationModule:getBrushColor");var rt={renderOutline:!0,renderFill:!0,shouldRenderInactiveLabelmaps:!0,radius:10,minRadius:1,maxRadius:50,fillAlpha:.2,fillAlphaInactive:.1,outlineAlpha:.7,outlineAlphaInactive:.35,outlineWidth:3,storeHistory:!0,segmentsPerLabelmap:65535,arrayType:E.UINT_16_ARRAY},it=B("util:segmentation:labelmap3DHistory");function lt(e,t,n){var a=e.labelmaps2D;t.forEach((function(e){for(var t=e.imageIdIndex,o=e.diff,r=a[t].pixelData,i=0;i<o.length;i++){var l=o[i];r[l[0]]=l[n]}}))}var st={state:V,configuration:rt,onRegisterCallback:function(){Ke(0)},getters:{metadata:function(e,t,n){var a=M(e);if(a){var o=O(a,"stack").data[0].imageIds[0],r=V.series[o];if(r){if(t=void 0===t?r.activeLabelmapIndex:t,r.labelmaps3D[t]){var i=r.labelmaps3D[t];return void 0===n?i.metadata:i.metadata[n]}q.warn("No labelmap3D of labelmap index ".concat(t," on stack."))}else q.warn("brushStackState is undefined")}},labelmap3D:Y,labelmaps3D:G,activeLabelmapIndex:function(e){var t=M(e);if(t){var n=O(t,"stack").data[0].imageIds[0],a=V.series[n];if(a)return a.activeLabelmapIndex}},activeSegmentIndex:function(e,t){var n=M(e);if(n){var a=O(n,"stack").data[0].imageIds[0],o=V.series[a];if(o){t=void 0===t?o.activeLabelmapIndex:t;var r=o.labelmaps3D[t];if(r)return r.activeSegmentIndex}return 1}},isSegmentVisible:function(e,t,n){if(t){var a=M(e);if(a){var o=O(a,"stack").data[0].imageIds[0],r=V.series[o];if(r){if(n=void 0===n?r.activeLabelmapIndex:n,r.labelmaps3D[n])return!r.labelmaps3D[n].segmentsHidden[t];z.warn("No labelmap3D of labelmap index ".concat(n," on stack."))}else z.warn("brushStackState is undefined")}}},labelmap2D:function(e){var t=M(e);if(t){var n=y.cornerstone,a=O(t,"stack");if(a){var o,r=a.data[0],i=n.getEnabledElement(t),l=r.currentImageIdIndex,s=i.image,c=s.rows,u=s.columns,d=r.imageIds.length,f=r.imageIds[0],h=V.series[f];if(h){if(o=h.activeLabelmapIndex,!h.labelmaps3D[o])S(h,o,c*u*d);h.labelmaps3D[o].labelmaps2D[l]||qe(h,o,l,c,u)}else{o=0,V.series[f]={activeLabelmapIndex:o,labelmaps3D:[]},S(h=V.series[f],o,c*u*d),qe(h,o,l,c,u)}var v=h.labelmaps3D[o];return{labelmap2D:v.labelmaps2D[l],labelmap3D:v,currentImageIdIndex:l,activeLabelmapIndex:o}}We.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.")}},labelmap2DByImageIdIndex:function(e,t,n,a){if(!e.labelmaps2D[t]){var o,r=Tt("segmentation").configuration,i=n*a,l=i*t;switch(r.arrayType){case je:o=new Uint16Array(e.buffer,2*l,i);break;case ze:o=new Float32Array(e.buffer,4*l,i);break;default:throw new Error("Unsupported Array Type ".concat(r.arrayType))}e.labelmaps2D[t]={pixelData:o,segmentsOnLabelmap:Q(o)}}return e.labelmaps2D[t]},labelmapStats:function(e,t,n){var a=y.cornerstone,o=M(e);if(!o)return null;var r=O(o,"stack").data[0].imageIds,i=r[0];return new Promise((function(e){var o=V.series[i];o||e(null);var l=function(e){for(var t=[],n=y.cornerstone.metaData,a=!0,o=0;o<e.length;o++){var r=n.get("imagePlaneModule",e[o]);if(!r){a=!1;break}t.push(r)}return{sufficientMetadata:a,imagePlanes:t}}(r),s=l.sufficientMetadata,c=l.imagePlanes;s||(Ue.warn("Insufficient imagePlaneModule information to calculate volume statistics."),e(null)),n=void 0===n?o.activeLabelmapIndex:n;for(var u=o.labelmaps3D[n],d=[],f=0;f<r.length;f++)d.push(a.loadAndCacheImage(r[f]));Promise.all(d).then((function(n){var a=function(e,t,n,a){for(var o=function(e,t,n,a){for(var o=t[0],r=o.rowPixelSpacing,i=o.columnPixelSpacing,l=e.labelmaps2D,s=[],c=0;c<l.length;c++){var u=l[c];if(u&&u.segmentsOnLabelmap.includes(a)){for(var d=Be(t,n,c)*r*i,f=u.pixelData,h=t[c].getPixelData(),v=[],g=0;g<f.length;g++)f[g]===a&&v.push(h[g]);s.push({voxelInMM3:d,values:v})}}return s}(e,t,n,a),r=0,i=o[0].values[0],l=i,s=0,c=0;c<o.length;c++){var u=o[c],d=u.values,f=u.voxelInMM3;s+=f*d.length;var h=0;d.forEach((function(e){e>i?i=e:e<l&&(l=e),h+=e})),r+=h*f}r/=s;for(var v=0,g=0;g<o.length;g++){var m=o[g],p=m.values,y=m.voxelInMM3,x=0;p.forEach((function(e){x+=Math.pow(e-r,2)})),v+=x*y}return v/=s,v=Math.sqrt(v),{volume:s,mean:r,stdDev:v,max:i,min:l}}(u,n,c,t);e(a)}))}))},segmentOfActiveLabelmapAtEvent:function(e){var t=e.detail,n=t.element,a=t.image,o=t.currentPoints;if(o){var r=a.width,i=a.height;if(n){var l=O(n,"stack").data[0],s=l.currentImageIdIndex,c=l.imageIds[0],u=V.series[c],d=u.activeLabelmapIndex,f=u.labelmaps3D[d];if(f){var h=f.labelmaps2D[s];if(h){var v=h.pixelData,g=o.image,m=g.x,p=g.y;if(Ge({x:m=Math.floor(m),y:p=Math.floor(p)},i,r)){var y=v[p*r+m];if(0===y)return;return{segmentIndex:y,metadata:f.metadata[y]}}}}}}else Ye.warn("Not a cornerstone input event.")},brushColor:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=M(e);if(n){var a=O(n,"stack");if(a){var o,r=a.data[0],i=r.imageIds[0],l=V.series[i];if(l){var s=l.activeLabelmapIndex,c=l.labelmaps3D[s],u=c.activeSegmentIndex;o=V.colorLutTables[c.colorLUTIndex][u]}else o=V.colorLutTables[0][1];return t?"rgba(".concat(o[0],", ").concat(o[1],", ").concat(o[2],", 1.0 )"):"rgba(".concat(o[0],", ").concat(o[1],", ").concat(o[2],", 0.8 )")}ot.error("Consumers must define stacks in their application if using segmentations in cornerstoneTools.")}},labelmapBuffers:Z,activeLabelmapBuffer:function(e){var t=M(e);if(t){var n=O(t,"stack").data[0].imageIds[0],a=V.series[n];if(a)return Z(t,a.activeLabelmapIndex)}},colorLUT:Ze,colorForSegmentIndexColorLUT:function(e,t){return Ze(e)[t]}},setters:{metadata:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,o=M(e);if(o){var r=y.cornerstone,i=O(o,"stack"),l=i.data[0],s=l.imageIds[0],c=V.series[s];if(c||(V.series[s]={labelmapIndex:t,labelmaps3D:[]},c=V.series[s]),!c.labelmaps3D[t]){var u=r.getEnabledElement(o),d=u.image,f=d.rows,h=d.columns,v=l.imageIds.length,g=f*h*v;S(c,t,g)}var m=c.labelmaps3D[t];m.metadata[n]=a}},labelmap3DForElement:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4?arguments[4]:void 0,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,i=M(e);if(i){var l=O(i,"stack"),s=l.data[0].imageIds.length,c=l.data[0].imageIds[0];He(c,t,n,a,s,o,r),Oe(i,n)}},labelmap3DByFirstImageId:He,incrementActiveSegmentIndex:function(e){var t=M(e);t&&j(t,"increase")},decrementActiveSegmentIndex:function(e){var t=M(e);t&&j(t,"decrease")},activeSegmentIndex:function(e,t){var n=M(e);if(n){var a=O(n,"stack").data[0].imageIds[0],o=V.series[a];if(o){var r=o.activeLabelmapIndex,i=o.labelmaps3D[r],l=Tt("segmentation").configuration;t<=0?t=1:t>l.segmentsPerLabelmap&&(t=l.segmentsPerLabelmap),i.activeSegmentIndex=t}}},toggleSegmentVisibility:function(e,t,n){if(t){var a=M(e);if(a){var o=O(a,"stack").data[0].imageIds[0],r=V.series[o];if(r){if(n=void 0===n?r.activeLabelmapIndex:n,r.labelmaps3D[n]){var i=r.labelmaps3D[n].segmentsHidden;return i[t]=!i[t],!i[t]}z.warn("No labelmap3D of labelmap index ".concat(n," on stack."))}else z.warn("brushStackState is undefined")}}},updateSegmentsOnLabelmap2D:function(e){e.segmentsOnLabelmap=Q(e.pixelData)},deleteSegment:function(e,t,n){if(t){var a=M(e);if(a){var o=O(a,"stack").data[0].imageIds[0],r=V.series[o];if(r){n=void 0===n?r.activeLabelmapIndex:n;var i=r.labelmaps3D[n];if(i){delete i.metadata[t];for(var l=i.labelmaps2D,s=0;s<l.length;s++){var c=l[s];if(c&&c.segmentsOnLabelmap.includes(t)){var u=c.pixelData,d=c.segmentsOnLabelmap.indexOf(t);c.segmentsOnLabelmap.splice(d,1);for(var f=0;f<u.length;f++)u[f]===t&&(u[f]=0)}}y.cornerstone.updateImage(a)}}}}},colorLUT:Ke,colorLUTIndexForLabelmap3D:function(e,t){e.colorLUTIndex=t},colorForSegmentIndexOfColorLUT:function(e,t,n){Ze(e)[t]=n},activeLabelmapIndex:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=M(e);if(n){var a=y.cornerstone,o=O(n,"stack"),r=o.data[0],i=a.getEnabledElement(n),l=i.image,s=l.rows,c=l.columns,u=r.imageIds.length,d=s*c*u,f=r.imageIds[0],h=V.series[f];h?(h.activeLabelmapIndex=t,h.labelmaps3D[t]||S(h,t,d)):(V.series[f]={activeLabelmapIndex:t,labelmaps3D:[]},S(h=V.series[f],t,d)),a.updateImage(n)}},radius:function(e){var t=Tt("segmentation").configuration;t.radius=Math.min(Math.max(e,t.minRadius),t.maxRadius)},pushState:function(e,t,n){var a=Y(e,n);a.undo.push(t),a.redo=[]},undo:function(e,t){var n=Y(e,t),a=n.undo,o=n.redo;if(a.length){var r=a.pop();lt(n,r,1),o.push(r),y.cornerstone.updateImage(e)}else it.warn("No undos left.")},redo:function(e,t){var n=Y(e,t),a=n.undo,o=n.redo;if(o.length){var r=o.pop();lt(n,r,2),a.push(r),y.cornerstone.updateImage(e)}else it.warn("No redos left.")}}},ct={activeManipulators:{}};function ut(e){var t=y.cornerstone.getEnabledElement(e).uuid;delete ct.activeManipulators[t]}function dt(e){var t=ct.activeManipulators,n=t[e];"function"==typeof n&&n(),delete t[e]}function ft(e){ut(e.detail.element)}var ht={setters:{addActiveManipulatorForElement:function(e,t){var n=y.cornerstone.getEnabledElement(e).uuid;ct.activeManipulators[n]=t},removeActiveManipulatorForElement:ut,cancelActiveManipulatorsForElement:function(e){dt(y.cornerstone.getEnabledElement(e).uuid)},cancelActiveManipulators:function(){var e=ct.activeManipulators;Object.keys(e).forEach((function(e){return dt(e)}))}},state:ct,enabledElementCallback:function(e){var t=y.cornerstone.EVENTS.NEW_IMAGE;e.removeEventListener(t,ft),e.addEventListener(t,ft)},removeEnabledElementCallback:function(e){var t=y.cornerstone.EVENTS.NEW_IMAGE;e.removeEventListener(t,ft),ut(e)}},vt={iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="ACTIVE_COLOR" d="M8 16L8 0"></path>\n    <path stroke="ACTIVE_COLOR" d="M16 8L0 8"></path>\n  '},gt={configuration:vt,getters:{defaultOptions:function(){return vt}},setters:{defaultOptions:function(e){Object.assign(vt,e)}}},mt={configuration:{mouseEnabled:!0,touchEnabled:!0,globalToolSyncEnabled:!1,showSVGCursors:!1,autoResizeViewports:!0,lineDash:[4,4]}},pt=(B("store:modules:storeLogger"),{globalTools:{},globalToolChangeHistory:[],enabledElements:[],tools:[],isToolLocked:!1,activeMultiPartTool:null,mousePositionImage:{},clickProximity:6,touchProximity:10,handleRadius:6,deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1,preventTextBoxOutsideDisplayedArea:!1,handleTouchOffset:{x:0,y:-57},svgCursorUrl:null}),yt={mouseTools:function(){return pt.tools.filter((function(e){return e.supportedInteractionTypes.includes("Mouse")}))},touchTools:function(){return pt.tools.filter((function(e){return e.supportedInteractionTypes.includes("Touch")}))},enabledElementByUID:function(e){return pt.enabledElements.find((function(t){return y.cornerstone.getEnabledElement(t).uuid===e}))}},xt={segmentation:st,cursor:gt,globalConfiguration:mt,manipulatorState:ht};function Tt(e){return xt[e]}var bt={modules:xt,state:pt,getters:yt},Ct=function(e,t){return pt.tools.find((function(n){return n.element===e&&n.name===t}))},Mt=xt.globalConfiguration;function Et(e,t){if(Mt.configuration.showSVGCursors){var n=t.getIconWithPointerSVG(),a=t.mousePoint,o=window.URL.createObjectURL(n);e.style.cursor="url('".concat(o,"') ").concat(a,", auto"),pt.svgCursorUrl=o}}function wt(e){Mt.configuration.showSVGCursors&&It(e,"none")}function It(e,t){pt.svgCursorUrl&&window.URL.revokeObjectURL(pt.svgCursorUrl),pt.svgCursorUrl=null,e.style.cursor=t}var St=Tt("globalConfiguration"),kt=B("store:setToolMode"),_t=function(e,t,n,a){void 0===a&&Array.isArray(n)&&(a=n,n=null);var o=Ct(e,t);o&&(function(e,t,n,a){t.supportedInteractionTypes.forEach((function(o){if(void 0===a||a.includes(o)){var r=Vt[o];r?r(t,e,n):kt.warn("Unable to resolve input conflicts for type %s",o)}})),bt.state.tools.filter((function(t){return t.element===e&&"active"===t.mode&&t.supportedInteractionTypes.length>0})).forEach((function(t){var n=!1;t.supportedInteractionTypes.forEach((function(e){t.options["is".concat(e,"Active")]&&(n=!0)})),n||(kt.log("Setting tool %s's to PASSIVE",t.name),At(e,t.name))}))}(e,o,n,a),o.supportedInteractionTypes.forEach((function(e){void 0===a||a.includes(e)?n["is".concat(e,"Active")]=!0:n["is".concat(e,"Active")]=!1})),St.configuration.showSVGCursors&&o.supportedInteractionTypes.includes("Mouse")&&function(e,t,n){var a;a="number"==typeof t?[t]:t.mouseButtonMask;a.includes(1)&&(n.svgCursor?Et(n.element,n.svgCursor):n.hideDefaultCursor?wt(e):function(e){It(e,"initial")}(e))}(e,n,o)),Ut("active",null,e,t,n)};var Pt=function(e,t,n){Ft("active",e,t,n),bt.state.enabledElements.forEach((function(a){_t(a,e,t,n)}))},Dt=Ut.bind(null,"disabled",null),Ot=Bt.bind(null,"disabled",null),Lt=Ut.bind(null,"enabled",null),Rt=Bt.bind(null,"enabled",null),At=Ut.bind(null,"passive",b.TOOL_DEACTIVATED),Ht=Bt.bind(null,"passive",b.TOOL_DEACTIVATED);function Ut(e,t,n,a,o){var r,i,l=Ct(n,a);l?(o=qt(o),Array.isArray(o.mouseButtonMask)&&0!==o.mouseButtonMask.length&&Array.isArray(l.options.mouseButtonMask)&&(o.mouseButtonMask=(r=o.mouseButtonMask,i=l.options.mouseButtonMask,r.concat(i).reduce((function(e,t){return-1===e.indexOf(t)&&e.push(t),e}),[]))),l.mode=e,l.mergeOptions(o),l["".concat(e,"Callback")]&&l["".concat(e,"Callback")](n,o),t&&C(n,t,{options:o,toolName:a,toolType:a,type:t})):kt.warn('Unable to find tool "%s" for enabledElement',a)}function Bt(e,t,n,a){Ft(e,n,a),bt.state.enabledElements.forEach((function(o){Ut(e,t,o,n,a)}))}function Nt(e,t,n){var a="is".concat(e,"Active"),o=bt.state.tools.find((function(e){return e.element===n&&"active"===e.mode&&!0===e.options[a]}));o&&(kt.log("Setting tool %s's %s to false",o.name,a),o.options[a]=!1)}function Ft(e,t,n,a){if(St.configuration.globalToolSyncEnabled){var o={mode:e,args:[t,n]};a&&o.push(a),bt.state.globalToolChangeHistory.push(o);bt.state.globalToolChangeHistory.length>50&&bt.state.globalToolChangeHistory.shift();var r=bt.state.globalTools[t];if(r)if("active"===e){var i=function(e,t,n){void 0===n&&Array.isArray(t)&&(n=t,t=null);var a=[],o=bt.state.globalTools[e];if(o){var r=new o.tool(o.props);r.supportedInteractionTypes.forEach((function(e){if(void 0===n||n.includes(e))if("Mouse"===e){var o=qt(t).mouseButtonMask;Array.isArray(o)&&o.length>0?o.forEach((function(t){return a.push("".concat(e,"-").concat(t))})):Array.isArray(o)&&0===o.length&&a.push("".concat(e,"-DELETE"))}else"MultiTouch"===e?a.push("".concat(e,"-").concat(r.configuration.touchPointers)):a.push(e)}))}return a}(t,n,a);Object.keys(bt.state.globalTools).forEach((function(e){var t=bt.state.globalTools[e];t.activeBindings=t.activeBindings.filter((function(e){return!i.includes(e)}))})),i.some((function(e){return e.includes("Mouse-DELETE")}))&&(r.activeBindings=r.activeBindings.filter((function(e){return!e.includes("Mouse")})),i=i.filter((function(e){return!e.includes("Mouse")}))),r.activeBindings=r.activeBindings.concat(i)}else r.activeBindings=[];else kt.warn("setToolMode call for tool not available globally: ".concat(t))}}var Vt={Mouse:function(e,t,n){var a=qt(n).mouseButtonMask;if(Array.isArray(a)&&a.length>0){var o=bt.state.tools.find((function(e){return e.element===t&&"active"===e.mode&&!0===e.options.isMouseActive&&Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.some((function(e){return a.includes(e)}))}));o&&(o.options.mouseButtonMask=o.options.mouseButtonMask.filter((function(e){return!a.includes(e)})),0===o.options.mouseButtonMask.length&&(o.options.isMouseActive=!1))}},MouseWheel:Nt.bind(void 0,"MouseWheel"),Touch:function(e,t){var n=bt.state.tools.find((function(e){return e.element===t&&"active"===e.mode&&!0===e.options.isTouchActive})),a=bt.state.tools.find((function(e){return e.element===t&&"active"===e.mode&&!0===e.options.isMultiTouchActive&&1===e.configuration.touchPointers}));n&&(kt.log("Setting tool %s's isTouchActive to false",n.name),n.options.isTouchActive=!1),a&&(kt.log("Setting tool %s's isTouchActive to false",a.name),a.options.isMultiTouchActive=!1)},TouchPinch:Nt.bind(void 0,"TouchPinch"),TouchRotate:Nt.bind(void 0,"TouchRotate"),DoubleTap:Nt.bind(void 0,"DoubleTap"),MultiTouch:function(e,t){var n,a=bt.state.tools.find((function(n){return n.element===t&&"active"===n.mode&&!0===n.options.isMultiTouchActive&&n.configuration.touchPointers===e.configuration.touchPointers}));1===e.configuration.touchPointers&&(n=bt.state.tools.find((function(e){return e.element===t&&"active"===e.mode&&!0===e.options.isTouchActive}))),a&&(kt.log("Setting tool %s's isMultiTouchActive to false",a.name),a.options.isMultiTouchActive=!1),n&&(kt.log("Setting tool %s's isTouchActive to false",n.name),n.options.isTouchActive=!1)}};function qt(e){return Array.isArray(e)?e={mouseButtonMask:e}:e!==Object(e)&&(e={mouseButtonMask:[e]}),e.hasOwnProperty("mouseButtonMask")||(e.mouseButtonMask=[]),Array.isArray(e.mouseButtonMask)||(e.mouseButtonMask=[e.mouseButtonMask]),e.mouseButtonMask=e.mouseButtonMask.filter((function(e){return"number"==typeof e&&0!==e})),e}var jt={passiveCallback:function(e){Dt(e,this.name)},enabledCallback:function(e){_t(e,this.name)}};var zt={passiveCallback:function(e){Dt(e,this.name)},activeCallback:function(e){Lt(e,this.name)}},Wt=function(e,t){e.save(),t(e),e.restore()},Gt=1,Yt=2;var Xt={setToolWidth:function(e){Gt=e},getToolWidth:function(){return Gt},setActiveWidth:function(e){Yt=e},getActiveWidth:function(){return Yt}},Kt=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=t.color,o=t.lineWidth,r=t.fillStyle,i=t.lineDash,l=t.shouldDrawLines,s=void 0===l||l;e.beginPath(),e.strokeStyle=a||e.strokeStyle,e.lineWidth=o||void 0===o&&Xt.getToolWidth()||e.lineWidth,i&&e.setLineDash(i),n(e),r&&(e.fillStyle=r,e.fill()),s&&e.stroke(),i&&e.setLineDash([])};function Zt(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel";Kt(e,o,(function(e){"pixel"===r&&(n=y.cornerstone.pixelToCanvas(t,n),a=y.cornerstone.pixelToCanvas(t,a)),e.moveTo(n.x,n.y),e.lineTo(a.x,a.y)}))}var $t=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel";Kt(e,o,(function(e){"pixel"===r&&(n=y.cornerstone.pixelToCanvas(t,n),a=a.map((function(e){return y.cornerstone.pixelToCanvas(t,e)}))),e.moveTo(n.x,n.y),a.forEach((function(t){var n=t.x,a=t.y;e.lineTo(n,a)}))}))},Jt=function(e,t,n,a,o,r){var i=Math.atan2(n.y-t.y,n.x-t.x),l={color:a,lineWidth:o};r&&(l.lineDash=r),Zt(e,void 0,t,n,l,"canvas"),l={color:a,lineWidth:o,fillStyle:a};var s=[{x:n.x-10*Math.cos(i-Math.PI/7),y:n.y-10*Math.sin(i-Math.PI/7)},{x:n.x-10*Math.cos(i+Math.PI/7),y:n.y-10*Math.sin(i+Math.PI/7)},n];$t(e,void 0,n,s,l,"canvas")},Qt=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel";"pixel"===r&&(n=y.cornerstone.pixelToCanvas(t,n)),Kt(e,o,(function(e){e.arc(n.x,n.y,a,0,2*Math.PI)}))};function en(e){var t=y.cornerstoneMath;if(e instanceof t.Vector3)return e;var n=Object.keys(e);return n.includes("x")&&n.includes("y")&&n.includes("z")?new t.Vector3(e.x,e.y,e.z):new t.Vector3(e[0],e[1],e[2])}function tn(e,t){var n=en(t.rowCosines),a=en(t.columnCosines),o=en(t.imagePositionPatient),r=e.clone().sub(o);return{x:n.dot(r)/t.columnPixelSpacing,y:a.dot(r)/t.rowPixelSpacing}}function nn(e,t){var n=en(t.rowCosines),a=en(t.columnCosines),o=en(t.imagePositionPatient),r=n.clone().multiplyScalar(e.x);r.multiplyScalar(t.columnPixelSpacing);var i=a.clone().multiplyScalar(e.y);i.multiplyScalar(t.rowPixelSpacing);var l=r.add(i);return l.add(o),l}function an(e,t){var n=en(e.rowCosines),a=en(e.columnCosines),o=en(e.imagePositionPatient),r=en(t.rowCosines),i=en(t.columnCosines),l=en(t.imagePositionPatient),s=n.clone().cross(a),c=new y.cornerstoneMath.Plane;c.setFromNormalAndCoplanarPoint(s,o);var u=r.clone().cross(i),d=new y.cornerstoneMath.Plane;d.setFromNormalAndCoplanarPoint(u,l);var f=d.clone().intersectPlane(c),h=f.origin,v=f.direction,g=nn({x:t.columns,y:t.rows},t),m=l.distanceTo(g),p=new y.cornerstoneMath.Line3;p.start=h,p.end=h.clone().add(v.multiplyScalar(m));var x=function(e,t){var n=[];return Object.keys(t).forEach((function(a){var o=t[a],r=e.intersectLine(o);r&&n.push(r)})),n}(p,function(e){var t=nn({x:0,y:0},e),n=nn({x:e.columns,y:0},e),a=nn({x:0,y:e.rows},e),o=nn({x:e.columns,y:e.rows},e);return{top:new y.cornerstoneMath.Line3(t,n),left:new y.cornerstoneMath.Line3(t,a),right:new y.cornerstoneMath.Line3(n,o),bottom:new y.cornerstoneMath.Line3(a,o)}}(t));if(2===x.length)return{start:x[0],end:x[1]}}function on(e,t,n){var a=n*(Math.PI/180);return{x:Math.cos(a)*(e.x-t.x)-Math.sin(a)*(e.y-t.y)+t.x,y:Math.sin(a)*(e.x-t.x)+Math.cos(a)*(e.y-t.y)+t.y}}var rn=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel",i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;"pixel"===r&&(n=y.cornerstone.pixelToCanvas(t,n),a=y.cornerstone.pixelToCanvas(t,a));var l=y.cornerstone.getViewport(t),s=t.clientWidth,c=t.clientHeight,u=l.scale,d=l.translation,f=l.rotation-i,h={x:s/2+d.x*u,y:c/2+d.y*u};Math.abs(f)>.05&&(n=on(n,h,-f),a=on(a,h,-f));var v=Math.abs(n.x-a.x),g=Math.abs(n.y-a.y),m=Math.min(n.x,a.x),p=Math.min(n.y,a.y),x={x:m+v/2,y:p+g/2};Math.abs(f)>.05&&(x=on(x,h,f));var T=f*Math.PI/180;Kt(e,o,(function(e){e.ellipse(x.x,x.y,v/2,g/2,T,0,2*Math.PI),e.closePath()}))},ln="white",sn="greenyellow",cn="transparent";var un={setFillColor:function(e){cn=e},getFillColor:function(){return cn},setToolColor:function(e){ln=e},getToolColor:function(){return ln},setActiveColor:function(e){sn=e},getActiveColor:function(){return sn},getColorIfActive:function(e){return e.color?e.color:e.active?sn:ln}},dn=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=t.element,r=un.getToolColor();e.strokeStyle=a.color||r;for(var i=Object.keys(n),l=function(t){var r=i[t],l=n[r];if(!0===l.drawnIndependently)return"continue";if(!0===a.drawHandlesIfActive&&!l.active)return"continue";if(a.hideHandlesIfMoving&&l.moving)return"continue";var s={lineWidth:l.active?Xt.getActiveWidth():Xt.getToolWidth(),fillStyle:a.fill};a.lineDash&&(s.lineDash=a.lineDash),Kt(e,s,(function(e){var t=y.cornerstone.pixelToCanvas(o,l),n=l.radius||a.handleRadius||pt.handleRadius;e.arc(t.x,t.y,n,0,2*Math.PI)}))},s=0;s<i.length;s++)l(s)},fn=function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"pixel";Kt(e,a,(function(e){n.forEach((function(n){var a=n.start,r=n.end;if("pixel"===o){var i=y.cornerstone;a=i.pixelToCanvas(t,a),r=i.pixelToCanvas(t,r)}e.moveTo(a.x,a.y),e.lineTo(r.x,r.y)}))}))},hn=function(e,t,n,a,o,r){var i=e.length>0?y.cornerstoneMath.point.findClosestPoint(e,t):t,l=[{x:n.left+n.width/2,y:n.top},{x:n.left,y:n.top+n.height/2},{x:n.left+n.width/2,y:n.top+n.height},{x:n.left+n.width,y:n.top+n.height/2}];Zt(a,void 0,i,y.cornerstoneMath.point.findClosestPoint(l,i),{color:o,lineWidth:r,lineDash:[2,3]},"canvas")},vn={fontSize:15,fontFamily:"Arial",backgroundColor:"transparent"};function gn(e){if("string"!=typeof e)throw new Error("Font family must be a valid string");vn.fontFamily=e}function mn(e){if("number"!=typeof e||isNaN(e)||!isFinite(e))throw new Error("Font size must be a valid number");vn.fontSize=parseFloat(e)}var pn={setFont:function(e){var t=e.split("px ");2===t.length&&(mn(parseFloat(t[0])),gn(t[1]))},getFont:function(){return"".concat(vn.fontSize,"px ").concat(vn.fontFamily)},setFontSize:mn,getFontSize:function(){return vn.fontSize},setFontFamily:gn,getFontFamily:function(){return vn.fontFamily},setBackgroundColor:function(e){vn.backgroundColor=e},getBackgroundColor:function(){return vn.backgroundColor}},yn=function(e,t,n,a,o){var r=pn.getFontSize();e.font=pn.getFont(),e.textBaseline="top",e.fillStyle=a,n.forEach((function(n,a){e.fillText(n,t.left+o,t.top+o+a*(r+o))}))},xn=function(e,t,n){e.fillStyle=n,e.fillRect(t.left,t.top,t.width,t.height)};function Tn(e,t,n){var a=pn.getFont(),o=e.font;a&&a!==o&&(e.font=a);var r=e.measureText(t).width;return a&&a!==o&&(e.font=o),r+2*n}var bn=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]);var i=5,l=pn.getFontSize(),s=pn.getBackgroundColor(),c=0;t.forEach((function(t){var n=Tn(e,t,i);c=Math.max(c,n)}));var u={width:c,height:i+t.length*(l+i)};return Wt(e,(function(e){e.strokeStyle=o,r.centering&&(!0===r.centering.x&&(n-=u.width/2),!0===r.centering.y&&(a-=u.height/2)),u.left=n,u.top=a,"function"==typeof r.displacer&&r.displacer(u),xn(e,u,s),yn(e,u,t,o,i)})),u};function Cn(e,t,n){return Math.min(Math.max(t,e),n)}function Mn(e,t){var n=t.left||0,a=t.top||0;e.x=Cn(e.x,n,n+t.width),e.y=Cn(e.y,a,a+t.height)}var En=function(e,t,n,a,o,r){r-o<a-n?(e[t]+=o-n,e[t]+=(r-o)/2,e[t]-=(a-n)/2):n<o?e[t]+=o-n:a>r&&(e[t]-=a-r)};function wn(e,t){var n=y.cornerstone,a=n.pixelToCanvas,o=n.canvasToPixel,r=n.getViewport,i=n.getEnabledElement,l=n.getDisplayedArea,s=o(e,{x:t.left,y:t.top}),c=function(e,t){var n=function(t){return y.cornerstone.canvasToPixel(e,t)},a=t.top,o=t.left,r=t.width,i=t.height,l=[n({x:o,y:a}),n({x:o+r,y:a}),n({x:o,y:a+i}),n({x:o+r,y:a+i})],s=l.map((function(e){return e.x})),c=l.map((function(e){return e.y}));return{minX:Math.min.apply(Math,J()(s)),minY:Math.min.apply(Math,J()(c)),maxX:Math.max.apply(Math,J()(s)),maxY:Math.max.apply(Math,J()(c))}}(e,t),u=c.minX,d=c.minY,f=c.maxX,h=c.maxY,v=r(e),g=l(i(e).image,v),m=v.displayedArea?v.displayedArea:g,p=m.tlhc,x=m.brhc,T=p.y-1,b=p.x-1,C=x.y,M=x.x;En(s,"y",d,h,T,C),En(s,"x",u,f,b,M);var E=a(e,s);t.top=E.y,t.left=E.x}var In=Cn,Sn=function(e,t,n,a,o,r,i,l,s,c){var u=y.cornerstone.pixelToCanvas,d=u(t,n);s&&(d.x+=s);var f={centering:{x:!1,y:c}};if(pt.preventTextBoxOutsideDisplayedArea&&(f.displacer=function(e){return wn(t,e)}),n.boundingBox=bn(e,a,d.x,d.y,i,f),n.hasMoved){var h=r(o).map((function(e){return u(t,e)}));hn(h,d,n.boundingBox,e,i,l)}},kn=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel",i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if("pixel"===r){var l=y.cornerstone;n=l.pixelToCanvas(t,n),a=l.pixelToCanvas(t,a)}var s=y.cornerstone.getViewport(t),c=t.clientWidth,u=t.clientHeight,d=s.scale,f=s.translation,h=s.rotation-i,v={x:c/2+f.x*d,y:u/2+f.y*d};Math.abs(h)>.05&&(n=on(n,v,-h),a=on(a,v,-h));var g=Math.abs(n.x-a.x),m=Math.abs(n.y-a.y);n={x:Math.min(n.x,a.x),y:Math.min(n.y,a.y)},a={x:n.x+g,y:n.y+m};var p={x:n.x+g,y:n.y},x={x:n.x,y:n.y+m};Math.abs(h)>.05&&(n=on(n,v,h),a=on(a,v,h),p=on(p,v,h),x=on(x,v,h)),Kt(e,o,(function(e){e.moveTo(n.x,n.y),e.lineTo(p.x,p.y),e.lineTo(a.x,a.y),e.lineTo(x.x,x.y),e.lineTo(n.x,n.y)}))},_n=function(e){var t=e.getContext("2d");return t.setTransform(1,0,0,1,0,0),t},Pn=function(e,t){return void 0===e?t:e},Dn=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.shadow&&(e.shadowColor=Pn(t.shadowColor,"#000000"),e.shadowBlur=Pn(t.shadowBlur,0),e.shadowOffsetX=Pn(t.shadowOffsetX,1),e.shadowOffsetY=Pn(t.shadowOffsetY,1))},On=function(e){return 0===Object.keys(e).length&&e.constructor===Object},Ln=Tt("segmentation"),Rn=Ln.getters,An=Ln.setters;function Hn(){this.handles={start:{},end:{}}}function Un(e){var t=e.detail.element,n=e.detail.currentPoints.image;return On(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),y.cornerstone.updateImage(t),!0}function Bn(e){var t=e.detail,n=t.element,a=t.currentPoints.image;this.handles.end=a,y.cornerstone.updateImage(n)}function Nn(e){e.detail.handles=this.handles;var t=e.detail.element,n=Rn.labelmap2D(t),a=n.labelmap2D,o=n.labelmap3D,r=n.currentImageIdIndex,i=a.pixelData,l=i.slice(),s={points:{start:{x:this.handles.start.x,y:this.handles.start.y},end:{x:this.handles.end.x,y:this.handles.end.y}},pixelData:i,segmentIndex:o.activeSegmentIndex,segmentationMixinType:"circleSegmentationMixin"};this.applyActiveStrategy(e,s);var c={imageIdIndex:r,diff:Le(l,i)};An.pushState(this.element,[c]),An.updateSegmentsOnLabelmap2D(a),y.cornerstone.updateImage(t),this._resetHandles()}var Fn={postTouchStartCallback:Un,postMouseDownCallback:Un,mouseClickCallback:Un,touchDragCallback:Bn,mouseDragCallback:Bn,mouseMoveCallback:Bn,touchEndCallback:Nn,mouseUpCallback:Nn,initializeMixin:Hn,renderToolData:function(e){var t=this,n=e.detail,a=n.element,o=Rn.brushColor(a,!0),r=_n(n.canvasContext.canvas),i=y.cornerstoneMath.point.distance;Wt(r,(function(e){if(!t.handles)return null;var n=y.cornerstone.pixelToCanvas(a,t.handles.start),r=y.cornerstone.pixelToCanvas(a,t.handles.end),l=i(n,r);Qt(e,a,t.handles.start,l,{color:o})}))},_resetHandles:Hn,_applyStrategy:Nn},Vn=B("tools:ScissorsTool"),qn=Tt("segmentation"),jn=qn.getters,zn=qn.setters;function Wn(e){var t=e.detail.element,n=e.detail.currentPoints.image,a=this.handles.points;if(!a.length)return Vn.warn("Something went wrong, empty handles detected."),null;a.push({x:n.x,y:n.y,lines:[]}),this.currentHandle+=1,y.cornerstone.updateImage(t)}function Gn(e){var t=e.detail,n=e.detail.element;this._addPoint(t),y.cornerstone.updateImage(n)}function Yn(e){var t=this.handles.points,n=e.detail.element,a=jn.labelmap2D(n),o=a.labelmap2D,r=a.labelmap3D,i=a.currentImageIdIndex,l=o.pixelData,s=l.slice(),c={points:t,pixelData:l,segmentIndex:r.activeSegmentIndex,segmentationMixinType:"freehandSegmentationMixin"};this.applyActiveStrategy(e,c);var u={imageIdIndex:i,diff:Le(s,l)};zn.pushState(this.element,[u]),zn.updateSegmentsOnLabelmap2D(o),y.cornerstone.updateImage(n),this._resetHandles()}function Xn(){this.handles={points:[]},this.currentHandle=0}var Kn={postTouchStartCallback:Wn,postMouseDownCallback:Wn,mouseClickCallback:Wn,touchDragCallback:Gn,mouseDragCallback:Gn,mouseMoveCallback:Gn,touchEndCallback:Yn,mouseUpCallback:Yn,initializeMixin:Xn,renderToolData:function(e){var t=e.detail,n=t.element,a=jn.brushColor(n,!0),o=_n(t.canvasContext.canvas),r=this.handles.points;r.length<2||Wt(o,(function(e){for(var t=0;t<r.length;t++){var o=J()(r[t].lines);t===r.length-1&&o.push(r[0]),$t(e,n,r[t],o,{color:a})}}))},_resetHandles:Xn,_addPoint:function(e){var t=this.handles.points;t.length&&t[this.currentHandle-1].lines.push({x:e.currentPoints.image.x,y:e.currentPoints.image.y,lines:[]}),t.push({x:e.currentPoints.image.x,y:e.currentPoints.image.y,lines:[]}),this.currentHandle+=1,y.cornerstone.updateImage(e.element)},_applyStrategy:Yn},Zn=Tt("segmentation").getters;var $n=Object.assign({},Kn,{renderToolData:function(e){var t=this,n=e.detail,a=n.element,o=Zn.brushColor(a,!0),r=_n(n.canvasContext.canvas),i=this.handles;Wt(r,(function(e){if(i.points.length>1)for(var n=0;n<i.points.length;n++){var r=J()(i.points[n].lines);$t(e,a,t.handles.points[n],r,{color:o})}}))}}),Jn=Tt("segmentation"),Qn=Jn.getters,ea=Jn.setters;function ta(e){var t=e.detail.element,n=e.detail.currentPoints.image;return On(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),y.cornerstone.updateImage(t),!0}function na(e){var t=e.detail,n=t.element,a=t.currentPoints.image;this.handles.end=a,y.cornerstone.updateImage(n)}function aa(e){e.detail.handles=this.handles;var t=e.detail.element,n=Qn.labelmap2D(t),a=n.labelmap2D,o=n.labelmap3D,r=n.currentImageIdIndex,i=a.pixelData,l=i.slice(),s={points:[{x:this.handles.start.x,y:this.handles.start.y},{x:this.handles.end.x,y:this.handles.end.y}],pixelData:i,segmentIndex:o.activeSegmentIndex,segmentationMixinType:"rectangleSegmentationMixin"};this.applyActiveStrategy(e,s);var c={imageIdIndex:r,diff:Le(l,i)};ea.pushState(this.element,[c]),ea.updateSegmentsOnLabelmap2D(a),y.cornerstone.updateImage(t),this._resetHandles()}function oa(){this.handles={start:{},end:{}}}var ra={activeOrDisabledBinaryTool:jt,enabledOrDisabledBinaryTool:zt,circleSegmentationMixin:Fn,polylineSegmentationMixin:$n,freehandSegmentationMixin:Kn,rectangleSegmentationMixin:{postTouchStartCallback:ta,postMouseDownCallback:ta,mouseClickCallback:ta,touchDragCallback:na,mouseDragCallback:na,mouseMoveCallback:na,touchEndCallback:aa,mouseUpCallback:aa,initializeMixin:oa,renderToolData:function(e){var t=this,n=e.detail,a=n.element,o=Qn.brushColor(a,!0),r=_n(n.canvasContext.canvas);Wt(r,(function(e){kn(e,a,t.handles.start,t.handles.end,{color:o})}))},_resetHandles:oa,_applyStrategy:aa},renderBrushMixin:{renderBrush:function(e){var t,n=y.cornerstone,a=Tt("segmentation"),o=a.getters,r=a.configuration,i=e.detail,l=i.viewport;if(this._drawing?t=this._lastImageCoords:this._mouseUpRender?(t=this._lastImageCoords,this._mouseUpRender=!1):t=bt.state.mousePositionImage,t){var s=i.image,c=s.rows,u=s.columns,d=t,f=d.x,h=d.y;if(!(f<0||f>u||h<0||h>c)){var v=r.radius,g=i.canvasContext,m=i.element,p=o.brushColor(m,this._drawing);g.setTransform(1,0,0,1,0,0);var x=v*l.scale,T=n.pixelToCanvas(m,t);g.beginPath(),g.strokeStyle=p,g.ellipse(T.x,T.y,x,x,0,0,2*Math.PI),g.stroke()}}}}},ia=function(e){return e&&"object"===T()(e)&&"[object RegExp]"!==Object.prototype.toString.call(e)&&"[object Date]"!==Object.prototype.toString.call(e)},la=function(e,t){var n;return t&&!0===t.clone&&ia(e)?ua((n=e,Array.isArray(n)?[]:{}),e,t):e},sa=function(e,t,n){var a=e.slice();return t.forEach((function(t,o){void 0===a[o]?a[o]=la(t,n):ia(t)?a[o]=ua(e[o],t,n):-1===e.indexOf(t)&&a.push(la(t,n))})),a},ca=function(e,t,n){var a={};return ia(e)&&Object.keys(e).forEach((function(t){a[t]=la(e[t],n)})),Object.keys(t).forEach((function(o){ia(t[o])&&e[o]?a[o]=ua(e[o],t[o],n):a[o]=la(t[o],n)})),a},ua=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=Array.isArray(t),o=n||{arrayMerge:sa},r=o.arrayMerge||sa;if(a)return Array.isArray(e)?r(e,t,n):la(t,n);var i=ca(e,t,n);return Object.getPrototypeOf(e)!==Object.prototype&&Object.setPrototypeOf(i,Object.getPrototypeOf(e)),i},da=ua,fa=B("tools:base:BaseTool"),ha=Tt("globalConfiguration"),va=function(){function e(t,n){i()(this,e),this.initialConfiguration=da(n,t);var a=this.initialConfiguration,o=a.name,r=a.strategies,l=a.defaultStrategy,s=a.configuration,c=a.supportedInteractionTypes,u=a.mixins,d=a.svgCursor;this.name=o,this.mode="disabled",this.element=void 0,this.supportedInteractionTypes=c||[],this.strategies=r||{},this.defaultStrategy=l||Object.keys(this.strategies)[0]||void 0,this.activeStrategy=this.defaultStrategy,d&&(this.svgCursor=d),this._options={},this._configuration=Object.assign({},s),this.updateOnMouseMove=!1,this.hideDefaultCursor=!1,u&&u.length&&this._applyMixins(u),this._cursors=Object.assign({},this.initialConfiguration.cursors);var f=this.defaultStrategy&&this._cursors[this.activeStrategy];f&&(this.svgCursor=f)}return s()(e,[{key:"configuration",get:function(){return this._configuration},set:function(e){this._configuration=e}},{key:"options",get:function(){return this._options}},{key:"mergeOptions",value:function(e){this._options=Object.assign({},this._options,e)}},{key:"clearOptions",value:function(){this._options={}}},{key:"applyActiveStrategy",value:function(e,t){return this.strategies[this.activeStrategy].call(this,e,t)}},{key:"_applyMixins",value:function(e){for(var t=0;t<e.length;t++){var n=ra["".concat(e[t])];"object"===T()(n)?(Object.assign(this,n),"function"==typeof this.initializeMixin&&this.initializeMixin()):fa.warn("".concat(this.name,": mixin ").concat(ra[t]," does not exist."))}"function"===this.initializeMixin&&delete this.initializeMixin}},{key:"setActiveStrategy",value:function(e){this.activeStrategy=e,ha.configuration.showSVGCursors&&this.changeCursor(this.element,e)}},{key:"changeCursor",value:function(e,t){if(e){var n=this._cursors[t];n&&(this.svgCursor=n,"active"===this.mode&&Et(e,n))}}}],[{key:"configuration",get:function(){}}]),e}(),ga=function(e,t){if(e.boundingBox)return y.cornerstoneMath.point.insideRect(t,e.boundingBox)},ma=function(e,t,n,a){if(e.hasOwnProperty("pointNearHandle")){if(e.pointNearHandle(t,e,n))return!0}else if(!0===e.hasBoundingBox){if(ga(e,n))return!0}else{var o=y.cornerstone.pixelToCanvas(t,e);if(y.cornerstoneMath.point.distance(o,n)<=a)return!0}return!1},pa=function e(t,n,a,o){var r;if(n){if(Array.isArray(n))for(var i=Object.keys(n),l=0;l<i.length;l++){var s=n[i[l]];if(s.hasOwnProperty("x")&&s.hasOwnProperty("y")&&ma(s,t,a,o)){r=s;break}}else if("object"===T()(n))for(var c=Object.keys(n),u=0;u<c.length;u++){var d=c[u];if(Array.isArray(n[d])){if(r=e(t,n[d],a,o))break}else{var f=n[d];if(ma(f,t,a,o)){r=f;break}}}return r}},ya=function(e,t,n,a){a||(a=6);var o=function(e){var t;return Object.keys(e).forEach((function(n){var a=e[n];!0!==a.active||(t=a)})),t}(t),r=pa(e,t,n,a);return o!==r&&(void 0!==r&&(r.active=!0),void 0!==o&&(o.active=!1),!0)};var xa=n(9),Ta=n.n(xa),ba=function(e,t){var n=e.image,a={left:0,top:0,width:n.width,height:n.height},o=!1;return Object.keys(t).forEach((function(e){var n=t[e];!0!==n.allowedOutsideImage&&!1===y.cornerstoneMath.point.insideRect(n,a)&&(o=!0)})),o},Ca=function(e,t){var n=e.currentPoints,a=e.element,o=n.page,r=pt.handleTouchOffset,i=0,l=0;return"touch"===t&&(i=r.x,l=r.y),y.cornerstone.pageToPixel(a,o.x+i,o.y+l)},Ma=function(e,t,n){return t.filter((function(t){return t.element===e&&"active"===t.mode&&(void 0===n||t.options["is".concat(n,"Active")])}))},Ea=n(5),wa=n.n(Ea),Ia=function(e,t){return"active"===Ct(e,t).mode};function Sa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ka=Tt("segmentation"),_a=function(e){u()(n,e);var t=Sa(n);function n(e){var a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return i()(this,n),o.configuration||(o.configuration={alwaysEraseOnClick:!1}),(a=t.call(this,e,o)).updateOnMouseMove=!0,a.hideDefaultCursor=!0,a._drawing=!1,a._drawingMouseUpCallback=a._drawingMouseUpCallback.bind(wa()(a)),a}return s()(n,[{key:"renderBrush",value:function(e){throw new Error("Method renderBrush not implemented for ".concat(this.name,"."))}},{key:"_paint",value:function(e){throw new Error("Method _paint not implemented for ".concat(this.name,"."))}},{key:"mouseDragCallback",value:function(e){var t=e.detail.currentPoints;this._lastImageCoords=t.image,this._drawing&&this._paint(e)}},{key:"preMouseDownCallback",value:function(e){var t=e.detail,n=t.element,a=t.currentPoints;return this._startPainting(e),this._lastImageCoords=a.image,this._drawing=!0,this._startListeningForMouseUp(n),this._paint(e),!0}},{key:"_startPainting",value:function(e){var t=e.detail,n=t.element,a=ka.configuration,o=ka.getters.labelmap2D(n),r=o.labelmap2D,i=o.labelmap3D,l=o.currentImageIdIndex,s=o.activeLabelmapIndex,c=this._isCtrlDown(t)||this.configuration.alwaysEraseOnClick;if(this.paintEventData={labelmap2D:r,labelmap3D:i,currentImageIdIndex:l,activeLabelmapIndex:s,shouldErase:c},a.storeHistory){var u=r.pixelData.slice();this.paintEventData.previousPixelData=u}}},{key:"_endPainting",value:function(e){for(var t=ka.configuration,n=ka.setters,a=this.paintEventData,o=a.labelmap2D,r=a.currentImageIdIndex,i=new Set(o.pixelData).values(),l=[],s=!1;!s;){var c=i.next();(s=c.done)||l.push(c.value)}if(o.segmentsOnLabelmap=l,t.storeHistory){var u={imageIdIndex:r,diff:Le(this.paintEventData.previousPixelData,o.pixelData)};n.pushState(this.element,[u])}Oe(this.element)}},{key:"mouseMoveCallback",value:function(e){var t=e.detail.currentPoints;this._lastImageCoords=t.image}},{key:"renderToolData",value:function(e){var t=e.detail.element;Ia(t,this.name)&&this.renderBrush(e)}},{key:"passiveCallback",value:function(e){try{y.cornerstone.updateImage(this.element)}catch(e){return}}},{key:"_drawingMouseUpCallback",value:function(e){var t=e.detail.element;this._endPainting(e),this._drawing=!1,this._mouseUpRender=!0,this._stopListeningForMouseUp(t)}},{key:"newImageCallback",value:function(e){this._drawing&&(this._endPainting(e),this._startPainting(e))}},{key:"_startListeningForMouseUp",value:function(e){e.removeEventListener(b.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(b.MOUSE_CLICK,this._drawingMouseUpCallback),e.addEventListener(b.MOUSE_UP,this._drawingMouseUpCallback),e.addEventListener(b.MOUSE_CLICK,this._drawingMouseUpCallback),y.cornerstone.updateImage(e)}},{key:"_stopListeningForMouseUp",value:function(e){e.removeEventListener(b.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(b.MOUSE_CLICK,this._drawingMouseUpCallback),y.cornerstone.updateImage(e)}},{key:"increaseBrushSize",value:function(){var e=ka.configuration,t=ka.setters,n=e.radius,a=Math.floor(1.2*n);a===n&&(a+=1),t.radius(a)}},{key:"decreaseBrushSize",value:function(){var e=ka.configuration,t=ka.setters,n=e.radius,a=Math.floor(.8*n);t.radius(a)}},{key:"_isCtrlDown",value:function(e){return e.event&&e.event.ctrlKey||e.ctrlKey}}]),n}(va),Pa=function(e){return e.filter((function(e){return!(e.isMultiPartTool||e instanceof po||e instanceof _a)}))};function Da(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mouse";if("touch"===a?n=(n=Ma(e,yt.touchTools())).filter((function(e){return e.options.isTouchActive})):(n=(n=Ma(e,yt.mouseTools())).filter((function(e){return Array.isArray(e.options.mouseButtonMask)&&t&&e.options.mouseButtonMask.includes(t)&&e.options.isMouseActive})),pt.isMultiPartToolActive&&(n=Pa(n))),0!==n.length)return n[0]}var Oa=B("manipulators:moveAllHandles"),La=Tt("manipulatorState"),Ra={mouse:[b.MOUSE_DRAG],touch:[b.TOUCH_DRAG]},Aa={mouse:[b.MOUSE_UP,b.MOUSE_CLICK],touch:[b.TOUCH_END,b.TOUCH_DRAG_END,b.TOUCH_PINCH,b.TOUCH_PRESS,b.TAP]},Ha=function(e,t,n,a){var o=e.element,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"mouse",l=arguments.length>6?arguments[6]:void 0;r=Object.assign({deleteIfHandleOutsideImage:pt.deleteIfHandleOutsideImage,preventHandleOutsideImage:pt.preventHandleOutsideImage},r);var s=Ua.bind(this,t,n,r,i),c=function e(a){Na(t,n,r,i,{dragHandler:s,upOrEndHandler:e},a,l)};La.setters.addActiveManipulatorForElement(o,Ba.bind(null,n,r,i,{dragHandler:s,upOrEndHandler:c},o,l)),n.active=!0,pt.isToolLocked=!0,Ra[i].forEach((function(e){o.addEventListener(e,s)})),Aa[i].forEach((function(e){o.addEventListener(e,c)}))};function Ua(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,r=o.detail,i=r.element,l=r.image,s=r.buttons,c=o.detail.deltaPoints.image,u=c.x,d=c.y;t.active=!0,t.invalidated=!0;for(var f=Object.keys(t.handles),h=0;h<f.length;h++){var v=f[h],g=t.handles[v];!0!==g.movesIndependently&&g.hasOwnProperty("x")&&g.hasOwnProperty("y")&&(g.x+=u,g.y+=d,n.preventHandleOutsideImage&&Mn(g,l))}y.cornerstone.updateImage(i);var m=Da(i,s,a);m instanceof po&&m.updateCachedStats(l,i,t);var p=b.MEASUREMENT_MODIFIED,x={toolName:e,toolType:e,element:i,measurementData:t};C(i,p,x),o.preventDefault(),o.stopPropagation()}function Ba(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,o=a.dragHandler,r=a.upOrEndHandler,i=arguments.length>4?arguments[4]:void 0,l=arguments.length>5?arguments[5]:void 0;Fa(e,t,n,{dragHandler:o,upOrEndHandler:r},i,l,!1)}function Na(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,r=o.dragHandler,i=o.upOrEndHandler,l=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0,c=l.detail,u=c.element;La.setters.removeActiveManipulatorForElement(u),n.deleteIfHandleOutsideImage&&ba(c,t.handles)&&L(u,e,t),Fa(t,n,a,{dragHandler:r,upOrEndHandler:i},u,s,!0)}function Fa(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,o=a.dragHandler,r=a.upOrEndHandler,i=arguments.length>4?arguments[4]:void 0,l=arguments.length>5?arguments[5]:void 0,s=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];e.active=!1,e.invalidated=!0,pt.isToolLocked=!1,Ra[n].forEach((function(e){i.removeEventListener(e,o)})),Aa[n].forEach((function(e){i.removeEventListener(e,r)})),"function"==typeof t.doneMovingCallback&&(Oa.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),t.doneMovingCallback(s)),"function"==typeof l&&l(s),y.cornerstone.updateImage(i)}var Va=B("manipulators:moveHandle"),qa=Tt("manipulatorState"),ja={value:!1},za={mouse:[b.MOUSE_DRAG],touch:[b.TOUCH_DRAG]},Wa={mouse:[b.MOUSE_UP,b.MOUSE_CLICK],touch:[b.TOUCH_END,b.TOUCH_DRAG_END,b.TOUCH_PINCH,b.TOUCH_PRESS,b.TAP]},Ga=function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"mouse",i=arguments.length>6?arguments[6]:void 0;o=Object.assign({deleteIfHandleOutsideImage:pt.deleteIfHandleOutsideImage,preventHandleOutsideImage:pt.preventHandleOutsideImage},o);var l=e.element,s=Ya.bind(this,t,n,a,o,r),c=function l(){Ka(t,e,n,a,o,r,{dragHandler:s,upOrEndHandler:l},i)};if(qa.setters.addActiveManipulatorForElement(l,Xa.bind(null,t,e,n,a,o,r,{dragHandler:s,upOrEndHandler:c},i)),a.active=!0,a.moving=!0,n.active=!0,pt.isToolLocked=!0,za[r].forEach((function(e){l.addEventListener(e,s)})),Wa[r].forEach((function(e){l.addEventListener(e,c)})),"touch"===r){ja.value=!0;var u=y.cornerstone.getEnabledElement(l),d=Ca(e,r);$a(a,ja,u,d)}};function Ya(e,t,n,a,o,r){var i=r.detail,l=i.image,s=i.element,c=i.buttons,u=Ca(r.detail,o);ja.value=!1,n.active=!0,n.hasMoved=!0,n.x=u.x,n.y=u.y,t.invalidated=!0,a.preventHandleOutsideImage&&Mn(n,l),y.cornerstone.updateImage(s);var d=Da(s,c,o);d instanceof po&&d.updateCachedStats(l,s,t),C(s,b.MEASUREMENT_MODIFIED,{toolName:e,toolType:e,element:s,measurementData:t})}function Xa(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0,l=i.dragHandler,s=i.upOrEndHandler,c=arguments.length>7?arguments[7]:void 0;Za(e,t,n,a,o,r,{dragHandler:l,upOrEndHandler:s},c,!1)}function Ka(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0,l=i.dragHandler,s=i.upOrEndHandler,c=arguments.length>7?arguments[7]:void 0,u=t.element;qa.setters.removeActiveManipulatorForElement(u),Za(e,t,n,a,o,r,{dragHandler:l,upOrEndHandler:s},c,!0)}function Za(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0,l=i.dragHandler,s=i.upOrEndHandler,c=arguments.length>7?arguments[7]:void 0,u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],d=t.element;a.active=!1,a.moving=!1,n.active=!1,n.invalidated=!0,ja.value=!1,pt.isToolLocked=!1,za[r].forEach((function(e){d.removeEventListener(e,l)})),Wa[r].forEach((function(e){d.removeEventListener(e,s)})),o.deleteIfHandleOutsideImage&&ba(t,n.handles)&&L(d,e,n),"function"==typeof o.doneMovingCallback&&(Va.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),o.doneMovingCallback(u)),"function"==typeof c&&c(u),y.cornerstone.updateImage(d)}function $a(e,t,n,a){if(t.value){var o=Math.abs(e.y-a.y),r=o/10;if(o<1)return e.y=a.y,void(t.value=!1);e.y>a.y?e.y-=r:e.y<a.y&&(e.y+=r),y.cornerstone.updateImage(n.element),y.cornerstone.requestAnimationFrame((function(){$a(e,t,n,a)}))}}var Ja=B("manipulators:moveNewHandle"),Qa=Tt("manipulatorState"),eo={mouse:[b.MOUSE_MOVE,b.MOUSE_DRAG],touch:[b.TOUCH_DRAG]},to={mouse:[b.MOUSE_UP,b.MOUSE_CLICK],touch:[b.TOUCH_END,b.TOUCH_PINCH,b.TAP]},no=function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"mouse",i=arguments.length>6?arguments[6]:void 0;(o=Object.assign({deleteIfHandleOutsideImage:pt.deleteIfHandleOutsideImage,preventHandleOutsideImage:pt.preventHandleOutsideImage},o)).hasMoved=!1;var l=e.element;function s(e){ao(t,n,a,o,r,e)}function c(e){ro(t,n,a,o,r,{moveHandler:s,moveEndHandler:c},e,i)}n.active=!0,a.moving=!0,a.active=!0,pt.isToolLocked=!0,eo[r].forEach((function(e){l.addEventListener(e,s)})),l.addEventListener(b.TOUCH_START,lo),to[r].forEach((function(e){l.addEventListener(e,c)})),Qa.setters.addActiveManipulatorForElement(l,io.bind(null,n,a,o,r,{moveHandler:s,moveEndHandler:c},l,i))};function ao(e,t,n,a,o,r){var i=r.detail,l=i.image,s=i.element,c=i.buttons,u=Ca(r.detail,o);a.hasMoved=!0,t.invalidated=!0,n.active=!0,n.x=u.x,n.y=u.y,a&&a.preventHandleOutsideImage&&Mn(n,l),y.cornerstone.updateImage(s);var d=Da(s,c,o);d instanceof po&&d.updateCachedStats(l,s,t),C(s,b.MEASUREMENT_MODIFIED,{toolName:e,toolType:e,element:s,measurementData:t})}function oo(e,t,n,a,o){var r=a.moveHandler,i=a.moveEndHandler,l=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];eo[e].forEach((function(e){n.removeEventListener(e,r)})),to[e].forEach((function(e){n.removeEventListener(e,i)})),n.removeEventListener(b.TOUCH_START,lo),pt.isToolLocked=!1,"function"==typeof o&&o(l),"function"==typeof t.doneMovingCallback&&(Ja.warn("`options.doneMovingCallback` has been depricated. See https://github.com/cornerstonejs/cornerstoneTools/pull/915 for details."),t.doneMovingCallback(l)),y.cornerstone.updateImage(n)}function ro(e,t,n,a,o,r,i,l){var s=r.moveHandler,c=r.moveEndHandler,u=i.detail,d=u.element,f=!0;if(!1!==a.hasMoved){var h=Ca(u,o);t.active=!1,t.invalidated=!0,n.active=!1,n.moving=!1,n.x=h.x,n.y=h.y,Qa.setters.removeActiveManipulatorForElement(d),a.preventHandleOutsideImage&&Mn(n,i.detail.image),a.deleteIfHandleOutsideImage&&ba(i.detail,t.handles)&&(t.cancelled=!0,f=!1,L(d,e,t)),oo(o,a,d,{moveHandler:s,moveEndHandler:c},l,f)}}function io(e,t,n,a,o,r,i){var l=o.moveHandler,s=o.moveEndHandler;e.active=!1,e.invalidated=!0,t.active=!1,oo(a,n,r,{moveHandler:l,moveEndHandler:s},i,!1)}function lo(e){return e.stopImmediatePropagation(),!1}function so(e,t){var n=pt.clickProximity,a=pt.touchProximity,o=pt.tools.find((function(e){return e.name===t}));return o&&o.configuration&&(n=o.configuration.clickProximity||n,a=o.configuration.touchProximity||a),"mouse"===e?n:a}function co(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function uo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?co(Object(n),!0).forEach((function(t){Ta()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):co(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var fo=function(e,t,n,a,o){n.active=!0,pt.isToolLocked=!0;Ga(e.detail,t.name,n,a,t.options,o,(function(t){var a=e.detail.element,o=n.toolType||n.toolName,r={toolName:o,toolType:o,element:a,measurementData:uo(uo({},n),{},{active:!1})};C(a,b.MEASUREMENT_COMPLETED,r)})),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()},ho=function(e,t,n,a){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"mouse",r=0;r<t.data.length;r++){var i=t.data[r],l=pa(e,i.handles,a,so(o,n));if(l)return{handle:l,data:i}}},vo=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";n.active=!0,pt.isToolLocked=!0,Ha(e.detail,t.name,n,null,t.options,a,(function(){n.active=!1,pt.isToolLocked=!1})),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()};function go(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var mo=B("baseAnnotationTool"),po=function(e){u()(n,e);var t=go(n);function n(){return i()(this,n),t.apply(this,arguments)}return s()(n,[{key:"createNewMeasurement",value:function(e){throw new Error("Method createNewMeasurement not implemented for ".concat(this.name,"."))}},{key:"pointNearTool",value:function(e,t,n){throw new Error("Method pointNearTool not implemented for ".concat(this.name,"."))}},{key:"distanceFromPoint",value:function(e,t,n){throw new Error("Method distanceFromPoint not implemented for ".concat(this.name,"."))}},{key:"renderToolData",value:function(e){throw new Error("renderToolData not implemented for ".concat(this.name,"."))}},{key:"mouseMoveCallback",value:function(e){for(var t=e.detail,n=t.element,a=t.currentPoints.canvas,o=O(n,this.name),r=!1,i=0;i<o.data.length;i++){var l=o.data[i];!0===ya(n,l.handles,a)&&(r=!0);var s=this.pointNearTool(n,l,a,"mouse")&&!l.active,c=!this.pointNearTool(n,l,a,"mouse")&&l.active;(s||c)&&(l.active=!l.active,r=!0)}return r}},{key:"handleSelectedCallback",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";fo(e,this,t,n,a)}},{key:"toolSelectedCallback",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mouse";vo(e,this,t,n)}},{key:"updateCachedStats",value:function(e,t,n){mo.warn("updateCachedStats not implemented for ".concat(this.name,"."))}}]),n}(va),yo=function(e,t,n,a){var o=y.cornerstone,r={start:o.pixelToCanvas(e,t),end:o.pixelToCanvas(e,n)};return y.cornerstoneMath.lineSegment.distanceToPoint(r,a)},xo=function(e,t){var n=Math.pow(10,t);return Math.round(e*n)/n},To=xt.cursor,bo=function(){function e(t,n){i()(this,e),this.iconGroupString=t,this.options=Object.assign({},To.getters.defaultOptions(),n)}return s()(e,[{key:"getIconSVG",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._generateIconSVGString(e);return new Blob([t],{type:"image/svg+xml"})}},{key:"getIconSVGString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._generateIconSVGString(e)}},{key:"getIconWithPointerSVG",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._generateIconWithPointerSVGString(e);return new Blob([t],{type:"image/svg+xml"})}},{key:"getIconWithPointerString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._generateIconWithPointerSVGString(e)}},{key:"mousePoint",get:function(){var e=this.options.mousePoint;return"".concat(e.x," ").concat(e.y)}},{key:"_generateIconWithPointerSVGString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},this.options,e),n=t.mousePointerGroupString,a=t.iconSize,o=t.viewBox,r=a/Math.max(o.x,o.y),i=16+a,l='\n        <svg\n        data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n        width="'.concat(i,'" height="').concat(i,'" viewBox="0 0 ').concat(i," ").concat(i,'"\n      >\n        <g>\n          ').concat(n,'\n        </g>\n        <g transform="translate(16, 16) scale(').concat(r,')">\n          ').concat(this.iconGroupString,"\n        </g>\n      </svg>");return this._injectColors(l,t)}},{key:"_generateIconSVGString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},this.options,e),n=t.iconSize,a=t.viewBox,o='\n      <svg\n        data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n        width="'.concat(n,'" height="').concat(n,'" viewBox="0 0\n        ').concat(a.x," ").concat(a.y,'"\n      >\n        ').concat(this.iconGroupString,"\n      </svg>");return this._injectColors(o,t)}},{key:"_injectColors",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.activeColor||un.getActiveColor(),a=t.toolColor||un.getToolColor(),o=t.fillColor||un.getFillColor();return e.replace(/ACTIVE_COLOR/g,"".concat(n)).replace(/TOOL_COLOR/g,"".concat(a)).replace(/FILL_COLOR/g,"".concat(o))}}]),e}(),Co=new bo('<path fill="ACTIVE_COLOR" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n        50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n        10l50 50q10 10 10 23z"\n      />',{viewBox:{x:1792,y:1792}}),Mo=new bo('<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',{viewBox:{x:24,y:24}}),Eo=new bo('<g fill="ACTIVE_COLOR" stroke-width="3" stroke="ACTIVE_COLOR">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',{viewBox:{x:48,y:48}}),wo=new bo('<g stroke="ACTIVE_COLOR" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',{viewBox:{x:32,y:32}}),Io=new bo('<circle stroke="ACTIVE_COLOR" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',{viewBox:{x:32,y:32}}),So=new bo('<path stroke="ACTIVE_COLOR" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z"\n    />',{viewBox:{x:32,y:32}}),ko=new bo('\n  <g fill="ACTIVE_COLOR" stroke="ACTIVE_COLOR" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',{viewBox:{x:18,y:18}}),_o=new bo('<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n      <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n      <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n      <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n      <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n      <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n      <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n      <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n      <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n      <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n      <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n      <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n      <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n      <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n      <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n      <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n      <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n      <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n      <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n      <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n      <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n      <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n      <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n      <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n      <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n      <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n      <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n      <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n      <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n      <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n      <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n      <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n      <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n    </g>',{viewBox:{x:18,y:18}}),Po=new bo('<g id="length-group" fill="none" stroke-width="1" stroke="ACTIVE_COLOR" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',{viewBox:{x:24,y:24}}),Do=new bo('<path fill="ACTIVE_COLOR" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z"\n  />',{viewBox:{x:1792,y:1792}}),Oo=new bo('<path fill="ACTIVE_COLOR" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z"\n  />',{viewBox:{x:1792,y:1792}}),Lo=new bo('<path fill="ACTIVE_COLOR" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z"\n  />',{viewBox:{x:1792,y:1792}}),Ro=new bo('<path fill="ACTIVE_COLOR" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z"\n  />',{viewBox:{x:1792,y:1792}}),Ao=new bo('<path transform="translate(0,1792) scale(1,-1)" fill="ACTIVE_COLOR" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n      34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n      0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n      0 69.5 20.5t47.5 54.5z"\n    />',{viewBox:{x:2048,y:1792}}),Ho=new bo('<path fill="ACTIVE_COLOR" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n      312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n      0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n      0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n      32s176 78.7 176 176-78.7 176-176 176z"\n    />',{viewBox:{x:512,y:512}}),Uo=new bo('<path fill="ACTIVE_COLOR" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n      39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n      355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n      39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n      0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n      144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n      45v448q0 42-39 59-13 5-25 5-26 0-45-19z"\n    />',{viewBox:{x:1792,y:1792}}),Bo=new bo('<path fill="ACTIVE_COLOR" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n      14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n      163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n      225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n      132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n      164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n      39 17 39 59z"\n    />',{viewBox:{x:1792,y:1792}}),No=new bo('<path fill="ACTIVE_COLOR" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n      0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n      0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n      0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n      0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z"\n      />',{viewBox:{x:24,y:28}}),Fo=new bo('<path fill="ACTIVE_COLOR" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z"\n  />',{viewBox:{x:1792,y:1792}}),Vo=new bo('<path fill="ACTIVE_COLOR" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="ACTIVE_COLOR" />',{viewBox:{x:18,y:18}}),qo=new bo('<path fill="ACTIVE_COLOR" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n      312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n      0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n      0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n      32s176 78.7 176 176-78.7 176-176 176z"\n    />\n    <path fill="ACTIVE_COLOR" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n      320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n      19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n      0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z"\n    />',{viewBox:{x:640,y:512}}),jo={x:127,y:60},zo=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ACTIVE_COLOR";return'<rect fill="'.concat(e,'" x="80.19" y="25.03" width="47.14" height="15.85"/>')},Wo=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ACTIVE_COLOR";return'<rect fill="'.concat(e,'" x="80.19" y="25.03" width="47.14" height="15.85"/>\n      <rect fill="').concat(e,'" x="95.84" y="9.38" width="15.85" height="47.14"/>')},Go='<path fill="ACTIVE_COLOR" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',Yo='<path fill="ACTIVE_COLOR" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',Xo='<path fill="ACTIVE_COLOR" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Ko=new bo("".concat(Go," ").concat(zo()),{viewBox:jo}),Zo=new bo("".concat(Go," ").concat(Wo()),{viewBox:jo}),$o=new bo("".concat(Go," ").concat(zo()),{viewBox:jo}),Jo=new bo("".concat(Go," ").concat(Wo()),{viewBox:jo}),Qo=new bo("".concat(Yo," ").concat(zo()),{viewBox:jo}),er=new bo("".concat(Yo," ").concat(Wo()),{viewBox:jo}),tr=new bo("".concat(Yo," ").concat(zo()),{viewBox:jo}),nr=new bo("".concat(Yo," ").concat(Wo()),{viewBox:jo}),ar=new bo("".concat(Xo," ").concat(zo()),{viewBox:jo}),or=new bo("".concat(Xo," ").concat(Wo()),{viewBox:jo}),rr=new bo("".concat(Xo," ").concat(zo()),{viewBox:jo}),ir=new bo("".concat(Xo," ").concat(Wo()),{viewBox:jo});function lr(e){var t=y.cornerstone.metaData.get("imagePlaneModule",e.imageId);return t?{rowPixelSpacing:t.rowPixelSpacing||t.rowImagePixelSpacing,colPixelSpacing:t.columnPixelSpacing||t.colImagePixelSpacing}:{rowPixelSpacing:e.rowPixelSpacing,colPixelSpacing:e.columnPixelSpacing}}var sr=function(e){var t=T()(e);return null!==e&&("object"===t||"function"===t)};var cr=function(e,t,n){var a,o,r,i,l,s,c=0,u=!1,d=!1,f=!0,h=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function v(t){var n=a,r=o;return a=o=void 0,c=t,i=e.apply(r,n)}function g(e,t){return h?window.requestAnimationFrame(e):setTimeout(e,t)}function m(e){return c=e,l=g(y,t),u?v(e):i}function p(e){var n=e-s;return void 0===s||n>=t||n<0||d&&e-c>=r}function y(){var e=Date.now();if(p(e))return x(e);l=g(y,function(e){var n=e-c,a=t-(e-s);return d?Math.min(a,r-n):a}(e))}function x(e){return l=void 0,f&&a?v(e):(a=o=void 0,i)}function T(){for(var e=Date.now(),n=p(e),r=arguments.length,c=new Array(r),u=0;u<r;u++)c[u]=arguments[u];if(a=c,o=this,s=e,n){if(void 0===l)return m(s);if(d)return l=g(y,t),v(s)}return void 0===l&&(l=g(y,t)),i}return t=Number(t)||0,sr(n)&&(u=Boolean(n.leading),r=(d="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):r,f="trailing"in n?Boolean(n.trailing):f),T.cancel=function(){void 0!==l&&function(e){if(h)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),c=0,a=s=o=l=void 0},T.flush=function(){return void 0===l?i:x(Date.now())},T.pending=function(){return void 0!==l},T};var ur=function(e,t,n){var a=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return sr(n)&&(a="leading"in n?Boolean(n.leading):a,o="trailing"in n?Boolean(n.trailing):o),cr(e,t,{leading:a,trailing:o,maxWait:t})};function dr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var fr=function(e){u()(n,e);var t=dr(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Angle",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Co,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1}};return(e=t.call(this,a,o)).preventNewMeasurement=!1,e.throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},middle:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}},{key:"pointNearTool",value:function(e,t,n){return!1!==t.visible&&(yo(e,t.handles.start,t.handles.middle,n)<25||yo(e,t.handles.middle,t.handles.end,n)<25)}},{key:"updateCachedStats",value:function(e,t,n){var a=vr(e,n.handles.middle,n.handles.start),o=vr(e,n.handles.end,n.handles.middle),r=vr(e,n.handles.end,n.handles.start),i=hr(a),l=hr(o),s=hr(r),c=Math.acos((Math.pow(i,2)+Math.pow(l,2)-Math.pow(s,2))/(2*i*l));c*=180/Math.PI,n.rAngle=xo(c,2),n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=n.enabledElement,o=this.configuration,r=o.handleRadius,i=o.drawHandlesOnHover,l=o.hideHandlesIfMoving,s=o.renderDashed,c=O(e.currentTarget,this.name),u=Tt("globalConfiguration").configuration.lineDash;if(c)for(var d=_n(n.canvasContext.canvas),f=n.image,h=n.element,v=lr(f),g=v.rowPixelSpacing,m=v.colPixelSpacing,p=Xt.getToolWidth(),x=function(e){var o=c.data[e];if(!1===o.visible)return"continue";Wt(d,(function(e){Dn(e,t.configuration);var c=un.getColorIfActive(o),d=y.cornerstone.pixelToCanvas(n.element,o.handles.start),v=y.cornerstone.pixelToCanvas(n.element,o.handles.middle),x={color:c};s&&(x.lineDash=u),$t(e,n.element,o.handles.start,[o.handles.middle,o.handles.end],x);var T={color:c,handleRadius:r,drawHandlesIfActive:i,hideHandlesIfMoving:l};if(t.configuration.drawHandles&&dn(e,n,o.handles,T),!0===o.invalidated&&(o.rAngle?t.throttledUpdateCachedStats(f,h,o):t.updateCachedStats(f,h,o)),o.rAngle){var C,M=function(e,t,n){var a=t&&n?"":" (isotropic)";return e.rAngle.toString()+String.fromCharCode(parseInt("00B0",16))+a}(o,g,m);if(!o.handles.textBox.hasMoved){C={x:v.x,y:v.y};var E=Tn(e,M,5);v.x<d.x?C.x-=15+E+10:C.x+=15;var w=y.cornerstone.internal.getTransform(a);w.invert();var I=w.transformPoint(C.x,C.y);o.handles.textBox.x=I.x,o.handles.textBox.y=I.y}Sn(e,n.element,o.handles.textBox,M,o.handles,b,c,p,0,!0)}}))},T=0;T<c.data.length;T++)x(T);function b(e){return[e.start,e.middle,e.end]}}},{key:"addNewMeasurement",value:function(e,t){var n=this;if(!this.preventNewMeasurement){this.preventNewMeasurement=!0,e.preventDefault(),e.stopPropagation();var a=e.detail,o=this.createNewMeasurement(a),r=e.detail.element;D(r,this.name,o),y.cornerstone.updateImage(r),no(a,this.name,o,o.handles.middle,this.options,t,(function(e){if(o.active=!1,!e)return L(r,n.name,o),void(n.preventNewMeasurement=!1);o.handles.end.active=!0,y.cornerstone.updateImage(r),no(a,n.name,o,o.handles.end,n.options,t,(function(e){e?(o.active=!1,y.cornerstone.updateImage(r)):L(r,n.name,o),n.preventNewMeasurement=!1,y.cornerstone.updateImage(r);var t={toolName:n.name,toolType:n.name,element:r,measurementData:o};C(r,b.MEASUREMENT_COMPLETED,t)}))}))}}}]),n}(po);function hr(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))}function vr(e,t,n){var a=lr(e),o=a.rowPixelSpacing,r=a.colPixelSpacing;return{x:(t.x-n.x)*(r||1),y:(t.y-n.y)*(o||1)}}function gr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var mr=function(e){u()(n,e);var t=gr(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"ArrowAnnotate",supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:pr,changeTextCallback:yr,drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,arrowFirst:!0,renderDashed:!1,allowEmptyLabel:!1},svgCursor:Mo};return(e=t.call(this,a,o)).preventNewMeasurement=!1,e}return s()(n,[{key:"createNewMeasurement",value:function(e){return{visible:!0,active:!0,color:void 0,handles:{start:{x:e.detail.currentPoints.image.x,y:e.detail.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.detail.currentPoints.image.x,y:e.detail.currentPoints.image.y,highlight:!0,active:!1},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}},{key:"pointNearTool",value:function(e,t,n){return!1!==t.visible&&yo(e,t.handles.start,t.handles.end,n)<25}},{key:"updateCachedStats",value:function(){}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=n.element,o=n.enabledElement,r=this.configuration,i=r.handleRadius,l=r.drawHandlesOnHover,s=r.hideHandlesIfMoving,c=r.renderDashed,u=O(a,this.name);if(u){var d,f=e.detail.canvasContext.canvas,h=_n(f),v=Xt.getToolWidth();c&&(d=Tt("globalConfiguration").configuration.lineDash);for(var g=function(n){var r=u.data[n];if(!1===r.visible)return"continue";Wt(h,(function(n){Dn(n,t.configuration);var c=un.getColorIfActive(r),u=y.cornerstone.pixelToCanvas(a,r.handles.start),f=y.cornerstone.pixelToCanvas(a,r.handles.end);t.configuration.arrowFirst?Jt(n,f,u,c,v,d):Jt(n,u,f,c,v,d);var h={color:c,handleRadius:i,drawHandlesIfActive:l,hideHandlesIfMoving:s};t.configuration.drawHandles&&dn(n,e.detail,r.handles,h);var g=function(e){return e.text}(r);if(g&&""!==g){var m=Tn(n,g,5),x=pn.getFontSize()+10,T=Math.max(m,x)/2+5;if(f.x<u.x&&(T=-T),!r.handles.textBox.hasMoved){var b;b=t.configuration.arrowFirst?{x:f.x-m/2+T,y:f.y-x/2}:{x:u.x-m/2-T,y:u.y-x/2};var C=y.cornerstone.internal.getTransform(o);C.invert();var M=C.transformPoint(b.x,b.y);r.handles.textBox.x=M.x,r.handles.textBox.y=M.y}Sn(n,a,r.handles.textBox,g,r.handles,p,c,v,0,!1)}}))},m=0;m<u.data.length;m++)g(m)}function p(e){var t={x:(e.start.x+e.end.x)/2,y:(e.start.y+e.end.y)/2};return[e.start,t,e.end]}}},{key:"addNewMeasurement",value:function(e,t){var n=this,a=e.detail.element,o=this.createNewMeasurement(e),r=this.configuration.allowEmptyLabel;D(a,this.name,o),y.cornerstone.updateImage(a),no(e.detail,this.name,o,o.handles.end,this.options,t,(function(t){t?void 0===o.text&&n.configuration.getTextCallback((function(e){if(e||r){o.text=e,o.active=!1;var t={toolName:n.name,toolType:n.name,element:a,measurementData:o};y.cornerstone.updateImage(a),C(a,b.MEASUREMENT_COMPLETED,t)}else L(a,n.name,o)}),e.detail):L(a,n.name,o),y.cornerstone.updateImage(a)}))}},{key:"doubleClickCallback",value:function(e){return this._updateTextForNearbyAnnotation(e)}},{key:"touchPressCallback",value:function(e){return this._updateTextForNearbyAnnotation(e)}},{key:"_updateTextForNearbyAnnotation",value:function(e){var t=e.detail.element,n=e.detail.currentPoints.canvas,a=O(t,this.name);if(!a)return!1;for(var o=0;o<a.data.length;o++){var r=a.data[o];if(this.pointNearTool(t,r,n)||ga(r.handles.textBox,n))return r.active=!0,y.cornerstone.updateImage(t),this.configuration.changeTextCallback(r,e.detail,this._doneChangingTextCallback.bind(this,t,r)),e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation(),!0}}},{key:"_doneChangingTextCallback",value:function(e,t,n,a){!0===a?L(e,this.name,t):t.text=n,t.active=!1,y.cornerstone.updateImage(e),C(e,b.MEASUREMENT_MODIFIED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}}]),n}(po);function pr(e){e(prompt("Enter your annotation:"))}function yr(e,t,n){n(prompt("Change your annotation:"))}var xr=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return Object.assign({x:e,y:t,index:n,drawnIndependently:!1,allowedOutsideImage:!1,highlight:!0,active:!1},a)},Tr=function(e){var t=e.currentPoints.image,n=t.x,a=t.y;return{toolName:this.name,toolType:this.name,isCreating:!0,visible:!0,active:!0,invalidated:!0,handles:{start:xr(n,a,0),end:xr(n,a,1,{active:!0}),perpendicularStart:xr(n,a,2,{locked:!0}),perpendicularEnd:xr(n,a,3),textBox:xr(n-50,a-70,null,{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0})},longestDiameter:0,shortestDiameter:0}},br=function(e,t,n,a){var o=y.cornerstone,r=y.cornerstoneMath,i={start:o.pixelToCanvas(e,t.perpendicularStart),end:o.pixelToCanvas(e,t.perpendicularEnd)};return r.lineSegment.distanceToPoint(i,n)<a},Cr=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o=y.cornerstone,r=y.cornerstoneMath,i=t.handles,l={start:o.pixelToCanvas(e,i.start),end:o.pixelToCanvas(e,i.end)},s=r.lineSegment.distanceToPoint(l,n);if(ga(i.textBox,n))return!0;var c=so(a,"Bidirectional");return!!br(e,i,n,c)||s<c};function Mr(e,t,n,a){var o=(n.x-a.x)*e,r=(n.y-a.y)*t,i=Math.sqrt(o*o+r*r);return{x:o/i,y:r/i,length:i}}function Er(e,t){if(!t.handles.perpendicularStart.locked)return!1;var n,a,o,r,i=t.handles,l=i.start,s=i.end,c=e.image,u=c.columnPixelSpacing,d=void 0===u?1:u,f=c.rowPixelSpacing,h=void 0===f?1:f;if(l.x===s.x&&l.y===s.y)n=l.x,a=l.y,o=s.x,r=s.y;else{var v={x:(l.x+s.x)/2,y:(l.y+s.y)/2},g=Mr(d,h,l,s),m=g.length/2,p=m/(2*h),y=m/(2*d);n=v.x+y*g.y,a=v.y-p*g.x,o=v.x-y*g.y,r=v.y+p*g.x}return t.handles.perpendicularStart.x=n,t.handles.perpendicularStart.y=a,t.handles.perpendicularEnd.x=o,t.handles.perpendicularEnd.y=r,!0}var wr,Ir=function(e){var t=this,n=e.detail,a=n.element,o=n.canvasContext,r=n.image,i=this.configuration,l=i.handleRadius,s=i.drawHandlesOnHover,c=i.hideHandlesIfMoving,u=i.renderDashed,d=Tt("globalConfiguration").configuration.lineDash,f=O(a,this.name);if(f){var h=lr(r),v=h.rowPixelSpacing,g=h.colPixelSpacing;if(v&&g)for(var m,p=_n(o.canvas),y=un.getActiveColor(),x=Xt.getToolWidth(),T=function(e){var o=f.data[e];if(!1===o.visible)return"continue";m=o.active?y:un.getToolColor(),!0===o.invalidated&&(o.longestDiameter&&o.shortestDiameter?t.throttledUpdateCachedStats(r,a,o):t.updateCachedStats(r,a,o)),Wt(p,(function(e){Dn(e,t.configuration);var r=o.handles,i=r.start,f=r.end,h=r.perpendicularStart,p=r.perpendicularEnd,y=r.textBox,T={color:m},b={color:m,strokeWidth:C};u&&(T.lineDash=d,b.lineDash=d),Zt(e,a,i,f,T);var C=x;Er(n,o),Zt(e,a,h,p,b);var M={color:m,handleRadius:l,drawHandlesIfActive:s,hideHandlesIfMoving:c};t.configuration.drawHandles&&dn(e,n,o.handles,M);var E=Sr(o,v,g);Sn(e,a,y,E,o.handles,(function(e){return[e.start,e.end,e.perpendicularStart,e.perpendicularEnd]}),m,x,10,!0)}))},b=0;b<f.data.length;b++)T(b)}},Sr=function(e,t,n){var a=" mm";t&&n||(a=" pixels");var o=" L ".concat(e.longestDiameter).concat(a),r=" W ".concat(e.shortestDiameter).concat(a),i=e.labels;return i&&Array.isArray(i)?[].concat(J()(i),[o,r]):[o,r]},kr=function(e,t){var n=this,a=e.detail,o=a.element,r=a.image,i=a.buttons,l=this.configuration;if(!_r(r)){var s=this.createNewMeasurement(a),c=function(){s.active=!1,y.cornerstone.updateImage(o)};D(o,this.name,s),y.cornerstone.updateImage(o);var u=(new Date).getTime(),d=s.handles,f=d.end,h=d.perpendicularStart;no(a,this.name,s,f,{},t,(function(e){if(e){var d=s.handles,f=s.longestDiameter,v=s.shortestDiameter,g=ba(a,d),m=parseFloat(f)||0,p=parseFloat(v)||0,x=m<1||p<1,T=(new Date).getTime()-u<150;g||x||T?(s.cancelled=!0,L(o,n.name,s)):l.getMeasurementLocationCallback(s,a,c),Er(a,s),h.locked=!1,s.invalidated=!0,y.cornerstone.updateImage(o);var M=Da(o,i,t);M instanceof ti&&M.updateCachedStats(r,o,s);var E={toolName:n.name,toolType:n.name,element:o,measurementData:s};C(o,b.MEASUREMENT_MODIFIED,E),C(o,b.MEASUREMENT_COMPLETED,E)}else L(o,n.name,s)}))}},_r=function(e){var t=y.cornerstone.metaData.get("imagePlaneModule",e.imageId),n=e.rowPixelSpacing,a=e.columnPixelSpacing;return t&&(n=t.rowPixelSpacing||t.rowImagePixelSpacing,a=t.columnPixelSpacing||t.colImagePixelSpacing),!n||!a};var Pr={setCoords:function(e){wr=e.currentPoints.canvas},getCoords:function(){return wr}},Dr=function(e){var t=this,n=e.detail,a=n.element;Pr.setCoords(n);var o=O(a,this.name);if(o){for(var r=!1,i=function(e){var i=n.currentPoints.canvas,l=o.data[e],s=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,o=pa(e,t,n,a),r=!1;return Object.keys(t).forEach((function(e){if("textBox"!==e){var n=t[e],a=n===o;n.active!==a&&(r=!0),n.active=a}})),r}(a,l.handles,i);Object.keys(l.handles).forEach((function(e){if("textBox"!==e){var t=l.handles[e];t.hover=t.active}})),s&&(r=!0);var c=t.pointNearTool(a,l,i,"mouse"),u=c&&!l.active,d=!c&&l.active;(u||d)&&(l.active=!l.active,r=!0)},l=0;l<o.data.length;l++)i(l);!0===r&&y.cornerstone.updateImage(a)}},Or=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";"touch"===a?this.handleSelectedTouchCallback(e):this.handleSelectedMouseCallback(e)};function Lr(e,t,n,a){var o=(n.x-a.x)/t,r=(n.y-a.y)/e;return Math.sqrt(o*o+r*r)}function Rr(e,t){return{start:e,end:t}}function Ar(e,t,n){var a=y.cornerstoneMath.lineSegment,o=e.handles,r=o.start,i=o.end,l=o.perpendicularStart,s=o.perpendicularEnd,c=t.image,u=c.columnPixelSpacing,d=void 0===u?1:u,f=c.rowPixelSpacing,h=void 0===f?1:f,v=Rr(r,i),g=Rr(l,s),m=a.intersectLine(v,g);return{columnPixelSpacing:d,rowPixelSpacing:h,start:r,end:i,perpendicularStart:l,perpendicularEnd:s,longLine:v,intersection:m,distanceToFixed:Lr(d,h,n,m),fixedPoint:n}}function Hr(e,t,n,a){var o=Ar(t,n,a),r=o.columnPixelSpacing,i=o.rowPixelSpacing,l=o.distanceToFixed,s=Lr(r,i,a,e);if(s<=l)return!1;var c=l/s,u=function(e,t){var n=e.columnPixelSpacing,a=e.rowPixelSpacing,o=e.start,r=e.perpendicularStart,i=e.perpendicularEnd,l=e.intersection,s=e.fixedPoint,c=Lr(n,a,r,l),u=Lr(n,a,i,l),d=Mr(n,a,s,t),f=s===o?1:-1,h=f*a,v=f*n;return{start:{x:t.x+d.y*c*h,y:t.y+d.x*c*v*-1},end:{x:t.x+d.y*u*h*-1,y:t.y+d.x*u*v}}}(o,{x:a.x+(e.x-a.x)*c,y:a.y+(e.y-a.y)*c});return t.handles.perpendicularStart.x=u.start.x,t.handles.perpendicularStart.y=u.start.y,t.handles.perpendicularEnd.x=u.end.x,t.handles.perpendicularEnd.y=u.end.y,!0}function Ur(e,t){return e===t}function Br(e,t){return Ur(e,t)?-1:1}function Nr(e,t,n,a){var o,r=e.columnPixelSpacing,i=e.rowPixelSpacing,l=e.fixedPoint,s=e.perpendicularStart,c=e.perpendicularEnd,u=e.distanceToFixed,d=Br(l,c)*u,f=function(e,t,n){return Ur(e,n)?t:n}(l,s,c)===s,h=f?"start":"end",v=f?"end":"start";return o={},Ta()(o,h,{x:n.start.x,y:n.start.y}),Ta()(o,v,{x:t.x+a.y*i*d,y:t.y+a.x*r*d*-1}),o}function Fr(e,t,n,a){var o=y.cornerstoneMath.lineSegment,r=Ar(t,n,a),i=r.columnPixelSpacing,l=r.rowPixelSpacing,s=r.start,c=r.longLine,u=r.intersection;if(!function(e,t,n){return 0!==Lr(e,t,n.start,n.end)}(i,l,c))return!1;var d=Mr(i,l,s,u),f=function(e,t,n){var a=e.columnPixelSpacing,o=e.rowPixelSpacing,r=e.perpendicularEnd,i=e.fixedPoint,l=Number.MAX_SAFE_INTEGER,s=Br(i,r)*l;return{start:t,end:{x:t.x+n.y*o*s,y:t.y+n.x*a*s*-1}}}(r,e,d),h=o.intersectLine(c,f);if(!h)return!1;var v=Nr(r,h,f,d);return t.handles.perpendicularStart.x=v.start.x,t.handles.perpendicularStart.y=v.start.y,t.handles.perpendicularEnd.x=v.end.x,t.handles.perpendicularEnd.y=v.end.y,!0}var Vr=function(e,t,n,a){var o,r,i,l,s={},c={},u={x:t.currentPoints.image.x+a.x,y:t.currentPoints.image.y+a.y};0===e.index?Hr(u,n,t,n.handles.end)?(e.x=u.x,e.y=u.y):(t.currentPoints.image.x=e.x,t.currentPoints.image.y=e.y):1===e.index?Hr(u,n,t,n.handles.start)?(e.x=u.x,e.y=u.y):(t.currentPoints.image.x=e.x,t.currentPoints.image.y=e.y):2===e.index?(o=!1,s.start={x:n.handles.start.x,y:n.handles.start.y},s.end={x:n.handles.end.x,y:n.handles.end.y},c.start={x:n.handles.perpendicularEnd.x,y:n.handles.perpendicularEnd.y},c.end={x:u.x,y:u.y},(r=y.cornerstoneMath.lineSegment.intersectLine(s,c))||(c.end={x:n.handles.perpendicularStart.x,y:n.handles.perpendicularStart.y},r=y.cornerstoneMath.lineSegment.intersectLine(s,c),i=y.cornerstoneMath.point.distance(r,n.handles.start),l=y.cornerstoneMath.point.distance(r,n.handles.end),(!r||i<3||l<3)&&(o=!0)),!1,o||Fr(u,n,t,n.handles.perpendicularEnd)||(t.currentPoints.image.x=n.handles.perpendicularStart.x,t.currentPoints.image.y=n.handles.perpendicularStart.y)):3===e.index&&(o=!1,s.start={x:n.handles.start.x,y:n.handles.start.y},s.end={x:n.handles.end.x,y:n.handles.end.y},c.start={x:n.handles.perpendicularStart.x,y:n.handles.perpendicularStart.y},c.end={x:u.x,y:u.y},(r=y.cornerstoneMath.lineSegment.intersectLine(s,c))||(c.end={x:n.handles.perpendicularEnd.x,y:n.handles.perpendicularEnd.y},r=y.cornerstoneMath.lineSegment.intersectLine(s,c),i=y.cornerstoneMath.point.distance(r,n.handles.start),l=y.cornerstoneMath.point.distance(r,n.handles.end),(!r||i<3||l<3)&&(o=!0)),!1,o||Fr(u,n,t,n.handles.perpendicularStart)||(t.currentPoints.image.x=n.handles.perpendicularEnd.x,t.currentPoints.image.y=n.handles.perpendicularEnd.y))},qr=function(e,t,n){var a=e[n],o=t[n];e[n]=o,t[n]=a},jr=function(e,t){qr(e,t,"x"),qr(e,t,"y"),qr(e,t,"moving"),qr(e,t,"hover"),qr(e,t,"active"),qr(e,t,"selected")};var zr=function(e){var t,n=this,a=e.detail,o=a.element,r=so("mouse",this.name),i=function(e){t.invalidated=!0,ba(a,t.handles)&&L(o,n.name,t),e&&(e.moving=!1,e.selected=!0),Et(n.element,n.svgCursor),y.cornerstone.updateImage(o),o.addEventListener(b.MOUSE_MOVE,n._moveCallback),o.addEventListener(b.TOUCH_START,n._moveCallback)},l=a.startPoints.canvas,s=O(e.currentTarget,this.name);if(s){for(var c=function(c){t=s.data[c];var u=[o,t.handles,l,r],d=pa.apply(void 0,u);if(d)return o.removeEventListener(b.MOUSE_MOVE,n._moveCallback),o.removeEventListener(b.TOUCH_START,n._moveCallback),t.active=!0,Wr(t.handles),d.moving=!0,(d=function(e,t,n){var a=e.image,o=a.rowPixelSpacing,r=a.columnPixelSpacing,i=t.handles,l=i.start,s=i.end,c=i.perpendicularStart,u=i.perpendicularEnd,d=(l.x-s.x)*(r||1),f=(l.y-s.y)*(o||1),h=Math.sqrt(d*d+f*f),v=(c.x-u.x)*(r||1),g=(c.y-u.y)*(o||1);return(Math.sqrt(v*v+g*g)||0)>h?(jr(l,s),jr(l,c),jr(s,u),Object.values(i).find((function(e){return!0===e.moving}))):n}(a,t,d)).hasBoundingBox||wt(n.element),function(e,t,n,a,o,r){var i=e.element,l=e.image,s=e.buttons,c={x:a.x-e.currentPoints.image.x,y:a.y-e.currentPoints.image.y},u=function(e){var o=e.detail;a.hasMoved=!0,void 0===a.index||null===a.index?(a.x=o.currentPoints.image.x+c.x,a.y=o.currentPoints.image.y+c.y):Vr(a,o,n,c),r&&(a.x=Math.max(a.x,0),a.x=Math.min(a.x,o.image.width),a.y=Math.max(a.y,0),a.y=Math.min(a.y,o.image.height)),n.invalidated=!0,y.cornerstone.updateImage(i);var u=Da(i,s,"mouse");u instanceof po&&u.updateCachedStats(l,i,n);var d={toolName:t,toolType:t,element:i,measurementData:n};y.cornerstone.triggerEvent(i,b.MEASUREMENT_MODIFIED,d)};a.active=!0,a.moving=!0,pt.isToolLocked=!0,i.addEventListener(b.MOUSE_DRAG,u),i.addEventListener(b.TOUCH_DRAG,u);var d=y.cornerstone.getImage(i),f=function(){y.cornerstone.getImage(i).imageId!==d.imageId&&h()};i.addEventListener(y.cornerstone.EVENTS.IMAGE_RENDERED,f);var h=function e(){a.active=!1,pt.isToolLocked=!1,i.removeEventListener(y.cornerstone.EVENTS.IMAGE_RENDERED,f),i.removeEventListener(b.MOUSE_DRAG,u),i.removeEventListener(b.MOUSE_UP,e),i.removeEventListener(b.MOUSE_CLICK,e),i.removeEventListener(b.TOUCH_DRAG,u),i.removeEventListener(b.TOUCH_DRAG_END,e),i.removeEventListener(b.TAP,e),y.cornerstone.updateImage(i),"function"==typeof o&&o()};i.addEventListener(b.MOUSE_UP,h),i.addEventListener(b.MOUSE_CLICK,h),i.addEventListener(b.TOUCH_DRAG_END,h),i.addEventListener(b.TAP,h)}(a,n.name,t,d,(function(){return i(d)})),Yr(e),{v:!0}},u=0;u<s.data.length;u++){var d=c(u);if("object"===T()(d))return d.v}for(var f=function(e){return function(){Gr(e,!1),i()}},h=0;h<s.data.length;h++)if(t=s.data[h],this.pointNearTool(o,t,l,"mouse")){o.removeEventListener(b.MOUSE_MOVE,this._moveCallback),o.removeEventListener(b.TOUCH_START,this._moveCallback),t.active=!0,Wr(t.handles),Gr(t.handles,!0);var v=f(t.handles);return Ha(a,this.name,t,null,{deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1},"mouse",v),Yr(e),!0}}},Wr=function(e){var t=!1;return Object.keys(e).forEach((function(n){"textBox"!==n&&(e[n].selected=!1,t=e[n].active||t,e[n].active=!1)})),t},Gr=function(e,t){Object.keys(e).forEach((function(n){"textBox"!==n&&(e[n].moving=t)}))},Yr=function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()},Xr=[b.TOUCH_END,b.TOUCH_DRAG_END,b.TOUCH_PINCH,b.TOUCH_PRESS,b.TAP],Kr=function(e){var t,n=this,a=e.detail,o=a.element,r=pt.touchProximity,i=function(e){t.invalidated=!0,ba(a,t.handles)&&L(o,n.name,t),e&&(e.moving=!1,e.selected=!0),y.cornerstone.updateImage(o),o.addEventListener(b.TOUCH_DRAG,n._moveCallback)},l=a.startPoints.canvas,s=O(e.currentTarget,this.name);if(s){for(var c=function(c){t=s.data[c];var u=[o,t.handles,l,r],d=pa.apply(void 0,u);if(d)return o.removeEventListener(b.TOUCH_DRAG,n._moveCallback),t.active=!0,Zr(t.handles),d.moving=!0,function(e,t,n,a,o,r){var i=e.element,l=e.image,s=e.buttons,c={x:a.x-e.currentPoints.image.x,y:a.y-e.currentPoints.image.y},u=function(e){var o=e.detail;a.hasMoved=!0,void 0===a.index||null===a.index?(a.x=o.currentPoints.image.x+c.x,a.y=o.currentPoints.image.y+c.y):Vr(a,o,n,c),r&&(a.x=Math.max(a.x,0),a.x=Math.min(a.x,o.image.width),a.y=Math.max(a.y,0),a.y=Math.min(a.y,o.image.height)),n.invalidated=!0,y.cornerstone.updateImage(i);var u=Da(i,s,"touch");u instanceof po&&u.updateCachedStats(l,i,n);var d={toolName:t,toolType:t,element:i,measurementData:n};y.cornerstone.triggerEvent(i,b.MEASUREMENT_MODIFIED,d)};a.active=!0,pt.isToolLocked=!0,i.addEventListener(b.TOUCH_DRAG,u);var d=function e(){a.active=!1,pt.isToolLocked=!1,i.removeEventListener(b.TOUCH_DRAG,u),Xr.forEach((function(t){i.removeEventListener(t,e)})),y.cornerstone.updateImage(i),"function"==typeof o&&o()};Xr.forEach((function(e){i.addEventListener(e,d)}))}(a,n.name,t,d,(function(){return i(d)})),Jr(e),{v:!0}},u=0;u<s.data.length;u++){var d=c(u);if("object"===T()(d))return d.v}for(var f=function(e){return function(){$r(e,!1),i()}},h=0;h<s.data.length;h++)if(t=s.data[h],this.pointNearTool(o,t,l,"touch")){o.removeEventListener(b.TOUCH_DRAG,this._moveCallback),t.active=!0,Zr(t.handles),$r(t.handles,!0);var v=f(t.handles);return Ha(a,this.name,t,null,{deleteIfHandleOutsideImage:!0,preventHandleOutsideImage:!1},"touch",v),Jr(e),!0}}},Zr=function(e){var t=!1;return Object.keys(e).forEach((function(n){"textBox"!==n&&(e[n].selected=!1,t=e[n].active||t,e[n].active=!1)})),t},$r=function(e,t){Object.keys(e).forEach((function(n){"textBox"!==n&&(e[n].moving=t)}))},Jr=function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()};function Qr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ei=function(e,t,n){return n()},ti=function(e){u()(n,e);var t=Qr(n);function n(e){var a;i()(this,n);var o={name:"Bidirectional",supportedInteractionTypes:["Mouse","Touch"],configuration:{changeMeasurementLocationCallback:ei,getMeasurementLocationCallback:ei,textBox:"",shadow:"",drawHandles:!0,drawHandlesOnHover:!0,hideHandlesIfMoving:!1,renderDashed:!1,additionalData:[]},svgCursor:Eo};return(a=t.call(this,e,o)).throttledUpdateCachedStats=ur(a.updateCachedStats,110),a.createNewMeasurement=Tr.bind(wa()(a)),a.pointNearTool=Cr.bind(wa()(a)),a.renderToolData=Ir.bind(wa()(a)),a.addNewMeasurement=kr.bind(wa()(a)),a._moveCallback=Dr.bind(wa()(a)),a.handleSelectedCallback=Or.bind(wa()(a)),a.handleSelectedMouseCallback=zr.bind(wa()(a)),a.handleSelectedTouchCallback=Kr.bind(wa()(a)),a}return s()(n,[{key:"updateCachedStats",value:function(e,t,n){if(n.toolName===this.name){var a=function(e,t){var n=t.rowPixelSpacing,a=t.colPixelSpacing,o=e.handles,r=o.start,i=o.end,l=o.perpendicularStart,s=o.perpendicularEnd,c=(r.x-i.x)*(a||1),u=(r.y-i.y)*(n||1),d=Math.sqrt(c*c+u*u),f=(l.x-s.x)*(a||1),h=(l.y-s.y)*(n||1),v=Math.sqrt(f*f+h*h);if(v||(v=0),v>d){var g=d;d=v,v=g}return{longestDiameter:d.toFixed(1),shortestDiameter:v.toFixed(1)}}(n,lr(e)),o=a.longestDiameter,r=a.shortestDiameter;n.longestDiameter=o,n.shortestDiameter=r,n.invalidated=!1}}}]),n}(po),ni=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=y.cornerstone,o=a.metaData.get("patientStudyModule",e.imageId),r=a.metaData.get("generalSeriesModule",e.imageId);if(o&&r){var i=r.modality;if("PT"===i){var l=n?t:t*e.slope+e.intercept,s=o.patientWeight;if(s){var c=a.metaData.get("petIsotopeModule",e.imageId);if(c){var u=c.radiopharmaceuticalInfo,d=u.radiopharmaceuticalStartTime,f=u.radionuclideTotalDose,h=u.radionuclideHalfLife,v=r.seriesTime;if(d&&f&&h&&v){var g=ai(v.fractionalSeconds||0)+v.seconds+60*v.minutes+60*v.hours*60,m=ai(d.fractionalSeconds||0)+d.seconds+60*d.minutes+60*d.hours*60,p=g-m,x=f*Math.exp(-p*Math.log(2)/h),T=l*s/x*1e3;return T}}}}}};function ai(e){return parseFloat(".".concat(e))}var oi=function(e,t){var n=e.width/2,a=e.height/2;if(n<=0||a<=0)return!1;var o=e.left+n,r=e.top+a,i=t.x-o,l=t.y-r;return i*i/(n*n)+l*l/(a*a)<=1},ri=function(e,t){for(var n=0,a=0,o=0,r=0,i=null,l=null,s=t.top;s<t.top+t.height;s++)for(var c=t.left;c<t.left+t.width;c++){oi(t,{x:c,y:s})&&(null===i&&(i=e[r],l=e[r]),n+=e[r],a+=e[r]*e[r],i=Math.min(i,e[r]),l=Math.max(l,e[r]),o++),r++}if(0===o)return{count:o,mean:0,variance:0,stdDev:0,min:0,max:0};var u=n/o,d=a/o-u*u;return{count:o,mean:u,variance:d,stdDev:Math.sqrt(d),min:i,max:l}},ii={calculateEllipseStatistics:ri,pointInEllipse:oi};function li(e,t){var n=function(e){var t=[e.start,e.end].sort((function(e,t){return e.x<t.x?-1:1})),n=[e.start,e.end].sort((function(e,t){return e.y<t.y?-1:1})),a=t[0],o=t[t.length-1],r=n[0],i=n[n.length-1];return{top:r,left:a,bottom:i,right:o}}(t),a=(n.left.x+n.right.x)/2,o=(n.top.y+n.bottom.y)/2,r={};return e.rotation>=0&&e.rotation<90&&(r.x=e.hflip?n.left.x:n.right.x,r.y=o),e.rotation>=90&&e.rotation<180&&(r.x=a,r.y=e.vflip?n.bottom.y:n.top.y),e.rotation>=180&&e.rotation<270&&(r.x=e.hflip?n.right.x:n.left.x,r.y=o),e.rotation>=270&&e.rotation<360&&(r.x=a,r.y=e.vflip?n.top.y:n.bottom.y),r}var si=function(e){var t=e.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")};function ci(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ui=B("tools:annotation:CircleRoiTool"),di=function(e){u()(n,e);var t=ci(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"CircleRoi",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Io,configuration:{renderDashed:!1,hideHandlesIfMoving:!1}};return(e=t.call(this,a,o)).throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};ui.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n,a){var o=t&&t.handles&&t.handles.start&&t.handles.end,r=y.cornerstoneMath.point.distance;if(o||ui.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!o||!1===t.visible)return!1;var i="mouse"===a?15:25,l=y.cornerstone.pixelToCanvas(e,t.handles.start),s=y.cornerstone.pixelToCanvas(e,t.handles.end),c=r(l,n),u=r(l,s);return c>u-i/2&&c<u+i/2}},{key:"updateCachedStats",value:function(e,t,n){var a=(y.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,o=lr(e),r=function(e,t,n,a,o){var r,i=ye(n.start,n.end),l=y.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),s=ri(l,i);"PT"===a&&(r={mean:ni(e,s.mean,!0)||0,stdDev:ni(e,s.stdDev,!0)||0});return{area:Math.PI*(i.width*(o.colPixelSpacing||1)/2)*(i.height*(o.rowPixelSpacing||1)/2)||0,count:s.count||0,mean:s.mean||0,variance:s.variance||0,stdDev:s.stdDev||0,min:s.min||0,max:s.max||0,meanStdDevSUV:r}}(e,t,n.handles,a,o);n.cachedStats=r,n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=O(e.currentTarget,this.name);if(n){var a=y.cornerstoneMath.point.distance,o=e.detail,r=o.image,i=o.element,l=o.canvasContext,s=Xt.getToolWidth(),c=this.configuration,u=c.handleRadius,d=c.drawHandlesOnHover,f=c.hideHandlesIfMoving,h=c.renderDashed,v=_n(l.canvas),g=lr(r),m=g.rowPixelSpacing,p=g.colPixelSpacing,x=Tt("globalConfiguration").configuration.lineDash,T=(y.cornerstone.metaData.get("generalSeriesModule",r.imageId)||{}).modality,b=m&&p;Wt(v,(function(e){for(var l=0;l<n.data.length;l++){var c=n.data[l];if(!1!==c.visible){var v=un.getColorIfActive(c),g={color:v,handleRadius:u,drawHandlesIfActive:d,hideHandlesIfMoving:f};Dn(e,t.configuration);var m=y.cornerstone.pixelToCanvas(i,c.handles.start),p=y.cornerstone.pixelToCanvas(i,c.handles.end),C=a(m,p),M={color:v};if(h&&(M.lineDash=x),Qt(e,i,c.handles.start,C,M,"pixel"),dn(e,o,c.handles,g),!0===c.invalidated&&(c.cachedStats?t.throttledUpdateCachedStats(r,i,c):t.updateCachedStats(r,i,c)),!c.handles.textBox.hasMoved){var E=li(o.viewport,c.handles);Object.assign(c.handles.textBox,E)}var w=hi(e,r.color,c.cachedStats,T,b,t.configuration);c.unit=fi(T,t.configuration.showHounsfieldUnits),Sn(e,i,c.handles.textBox,w,c.handles,(function(e){return t=e.start,n=e.end,a=ye(t,n),o=a.left,r=a.top,i=a.width,l=a.height,[{x:o+i/2,y:r},{x:o,y:r+l/2},{x:o+i/2,y:r+l},{x:o+i,y:r+l/2}];var t,n,a,o,r,i,l}),v,s,10,!0)}}}))}}}]),n}(po);function fi(e,t){return"CT"===e&&!1!==t?"HU":""}function hi(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=n.area,o=n.mean,r=n.stdDev,i=n.min,l=n.max,s=n.meanStdDevSUV,c=arguments.length>3?arguments[3]:void 0,u=arguments.length>4?arguments[4]:void 0,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},f=d.showMinMax||!1,h=[],v=[];if(!t){var g=s&&0!==s.mean,m=fi(c,d.showHounsfieldUnits),p="Mean: ".concat(si(o.toFixed(2))," ").concat(m),y="Std Dev: ".concat(si(r.toFixed(2))," ").concat(m);if(g){for(var x=" SUV: ",T="".concat(x).concat(si(s.mean.toFixed(2))),b="".concat(x).concat(si(s.stdDev.toFixed(2))),C=Math.floor(e.measureText("".concat(y,"     ")).width);e.measureText(p).width<C;)p+=" ";v.push("".concat(p).concat(T)),v.push("".concat(y,"     ").concat(b))}else v.push("".concat(p,"     ").concat(y));if(f){for(var M="Min: ".concat(i," ").concat(m),E="Max: ".concat(l," ").concat(m),w=g?Math.floor(e.measureText("".concat(y,"     ")).width):Math.floor(e.measureText("".concat(p,"     ")).width);e.measureText(M).width<w;)M+=" ";v.push("".concat(M).concat(E))}}return h.push(vi(a,u)),v.forEach((function(e){return h.push(e)})),h}function vi(e,t){var n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(si(e.toFixed(2))).concat(n)}function gi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var mi=function(e){u()(n,e);var t=gi(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"CobbAngle",supportedInteractionTypes:["Mouse","Touch"],svgCursor:wo,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1}};return(e=t.call(this,a,o)).hasIncomplete=!1,e.throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){return this.hasIncomplete=!0,{visible:!0,active:!0,color:void 0,invalidated:!0,complete:!1,value:"",handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},start2:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1,drawnIndependently:!0},end2:{x:e.currentPoints.image.x+1,y:e.currentPoints.image.y,highlight:!0,active:!1,drawnIndependently:!0},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}},{key:"pointNearTool",value:function(e,t,n){if(!1===t.visible)return!1;if(this.hasIncomplete)return!1;var a=yo(e,t.handles.start,t.handles.end,n)<25,o=yo(e,t.handles.start2,t.handles.end2,n)<25;return a||o}},{key:"updateCachedStats",value:function(e,t,n){var a=lr(e),o=a.rowPixelSpacing,r=a.colPixelSpacing,i=(Math.ceil(n.handles.start.x)-Math.ceil(n.handles.end.x))*(r||1),l=(Math.ceil(n.handles.start.y)-Math.ceil(n.handles.end.y))*(o||1),s=(Math.ceil(n.handles.start2.x)-Math.ceil(n.handles.end2.x))*(r||1),c=(Math.ceil(n.handles.start2.y)-Math.ceil(n.handles.end2.y))*(o||1),u=Math.acos(Math.abs((i*s+l*c)/(Math.sqrt(i*i+l*l)*Math.sqrt(s*s+c*c))));u*=180/Math.PI,n.rAngle=xo(u,2),n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=this.configuration,o=a.handleRadius,r=a.drawHandlesOnHover,i=a.hideHandlesIfMoving,l=a.renderDashed,s=O(e.currentTarget,this.name);if(s)for(var c=_n(n.canvasContext.canvas),u=Xt.getToolWidth(),d=Tt("globalConfiguration").configuration.lineDash,f=pn.getFont(),h=e.detail.element,v=lr(y.cornerstone.getEnabledElement(h).image),g=v.rowPixelSpacing,m=v.colPixelSpacing,p=function(e){var a=s.data[e];if(!1===a.visible)return"continue";a.value||(a.value=t.textBoxText(a,g,m)),Wt(c,(function(e){Dn(e,t.configuration);var s=un.getColorIfActive(a),c={color:s};l&&(c.lineDash=d),Zt(e,n.element,a.handles.start,a.handles.end,c),a.complete&&Zt(e,n.element,a.handles.start2,a.handles.end2,c);var h={color:s,handleRadius:o,drawHandlesIfActive:r,hideHandlesIfMoving:i};t.configuration.drawHandles&&dn(e,n,a.handles,h),e.fillStyle=s;var v=a.value;if(!a.handles.textBox.hasMoved){var g={x:(a.handles.start.x+a.handles.end.x)/2,y:(a.handles.start.y+a.handles.end.y)/2-10};e.font=f,a.handles.textBox.x=g.x,a.handles.textBox.y=g.y}Sn(e,n.element,a.handles.textBox,v,a.handles,T,s,u,0,!0)}))},x=0;x<s.data.length;x++)p(x);function T(e){return[e.start,e.start2,e.end,e.end2]}}},{key:"getIncomplete",value:function(e){var t=O(e,this.name);if(t&&Array.isArray(t.data))return t.data.find((function(e){return!1===e.complete}))}},{key:"addNewMeasurement",value:function(e,t){var n=this;e.preventDefault(),e.stopPropagation();var a,o,r=e.detail,i=function(e){if(e){var t=b.MEASUREMENT_COMPLETED,o={toolName:n.name,toolType:n.name,element:l,measurementData:a};C(l,t,o)}else L(l,n.name,a)},l=e.detail.element,s=this.getIncomplete(l);s?((a=s).complete=!0,a.handles.start2={x:r.currentPoints.image.x,y:r.currentPoints.image.y,drawnIndependently:!1,highlight:!0,active:!1},a.handles.end2={x:r.currentPoints.image.x,y:r.currentPoints.image.y,drawnIndependently:!1,highlight:!0,active:!0},o=a.handles.end2,this.hasIncomplete=!1,i=function(e){if(e){var t=b.MEASUREMENT_COMPLETED,o={toolName:n.name,toolType:n.name,element:l,measurementData:a};C(l,t,o)}else L(l,n.name,a)}):(a=this.createNewMeasurement(r),D(l,this.name,a),o=a.handles.end),y.cornerstone.updateImage(l),no(r,this.name,a,o,this.options,t,i)}},{key:"onMeasureModified",value:function(e){var t=e.detail.element,n=y.cornerstone.getEnabledElement(t).image,a=lr(n),o=a.rowPixelSpacing,r=a.colPixelSpacing;if(e.detail.toolName===this.name){var i=e.detail.measurementData;!0===i.invalidated&&(i.rAngle?this.throttledUpdateCachedStats(n,t,i):this.updateCachedStats(n,t,i)),i.value=this.textBoxText(i,o,r)}}},{key:"textBoxText",value:function(e,t,n){var a=e.rAngle;if(void 0===a)return"";if(Number.isNaN(a))return"";var o=t&&n?"":" (isotropic)";return"".concat(a,"°").concat(o)}},{key:"activeCallback",value:function(e){this.onMeasureModified=this.onMeasureModified.bind(this),e.addEventListener(b.MEASUREMENT_MODIFIED,this.onMeasureModified)}},{key:"passiveCallback",value:function(e){this.onMeasureModified=this.onMeasureModified.bind(this),e.addEventListener(b.MEASUREMENT_MODIFIED,this.onMeasureModified)}},{key:"enabledCallback",value:function(e){e.removeEventListener(b.MEASUREMENT_MODIFIED,this.onMeasureModified)}},{key:"disabledCallback",value:function(e){e.removeEventListener(b.MEASUREMENT_MODIFIED,this.onMeasureModified)}}]),n}(po);function pi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var yi=B("tools:annotation:EllipticalRoiTool"),xi=function(e){u()(n,e);var t=pi(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"EllipticalRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1},svgCursor:So};return(e=t.call(this,a,o)).throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};yi.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n,a){var o=t&&t.handles&&t.handles.start&&t.handles.end;if(o||yi.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!o||!1===t.visible)return!1;if(pa(e,t.handles,n,6))return!0;var r="mouse"===a?15:25,i=y.cornerstone.pixelToCanvas(e,t.handles.start),l=y.cornerstone.pixelToCanvas(e,t.handles.end),s={left:Math.min(i.x,l.x)+r/2,top:Math.min(i.y,l.y)+r/2,width:Math.abs(i.x-l.x)-r,height:Math.abs(i.y-l.y)-r},c={left:Math.min(i.x,l.x)-r/2,top:Math.min(i.y,l.y)-r/2,width:Math.abs(i.x-l.x)+r,height:Math.abs(i.y-l.y)+r},u=oi(s,n);return!(!oi(c,n)||u)}},{key:"updateCachedStats",value:function(e,t,n){var a=(y.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,o=lr(e),r=function(e,t,n,a,o){var r,i=Mi(n.start,n.end),l=y.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),s=ri(l,i);"PT"===a&&(r={mean:ni(e,s.mean,!0)||0,stdDev:ni(e,s.stdDev,!0)||0});return{area:Math.PI*(i.width*(o.colPixelSpacing||1)/2)*(i.height*(o.rowPixelSpacing||1)/2)||0,count:s.count||0,mean:s.mean||0,variance:s.variance||0,stdDev:s.stdDev||0,min:s.min||0,max:s.max||0,meanStdDevSUV:r}}(e,t,n.handles,a,o);n.cachedStats=r,n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=O(e.currentTarget,this.name);if(n){var a=e.detail,o=a.image,r=a.element,i=Xt.getToolWidth(),l=Tt("globalConfiguration").configuration.lineDash,s=this.configuration,c=s.handleRadius,u=s.drawHandlesOnHover,d=s.hideHandlesIfMoving,f=s.renderDashed,h=_n(a.canvasContext.canvas),v=lr(o),g=v.rowPixelSpacing,m=v.colPixelSpacing,p=(y.cornerstone.metaData.get("generalSeriesModule",o.imageId)||{}).modality,x=g&&m;Wt(h,(function(e){for(var s=0;s<n.data.length;s++){var h=n.data[s];if(!1!==h.visible){var v=un.getColorIfActive(h),g={color:v,handleRadius:c,drawHandlesIfActive:u,hideHandlesIfMoving:d};Dn(e,t.configuration);var m={color:v};if(f&&(m.lineDash=l),rn(e,r,h.handles.start,h.handles.end,m,"pixel",h.handles.initialRotation),dn(e,a,h.handles,g),!0===h.invalidated&&(h.cachedStats?t.throttledUpdateCachedStats(o,r,h):t.updateCachedStats(o,r,h)),!h.handles.textBox.hasMoved){var y=li(a.viewport,h.handles);Object.assign(h.handles.textBox,y)}var T=bi(e,o.color,h.cachedStats,p,x,t.configuration);h.unit=Ti(p,t.configuration.showHounsfieldUnits),Sn(e,r,h.handles.textBox,T,h.handles,(function(e){return t=e.start,n=e.end,a=Mi(t,n),o=a.left,r=a.top,i=a.width,l=a.height,[{x:o+i/2,y:r},{x:o,y:r+l/2},{x:o+i/2,y:r+l},{x:o+i,y:r+l/2}];var t,n,a,o,r,i,l}),v,i,10,!0)}}}))}}}]),n}(po);function Ti(e,t){return"CT"===e&&!1!==t?"HU":""}function bi(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=n.area,o=n.mean,r=n.stdDev,i=n.min,l=n.max,s=n.meanStdDevSUV,c=arguments.length>3?arguments[3]:void 0,u=arguments.length>4?arguments[4]:void 0,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},f=d.showMinMax||!1,h=[],v=[];if(!t){var g=s&&0!==s.mean,m=Ti(c,d.showHounsfieldUnits),p="Mean: ".concat(si(o.toFixed(2))," ").concat(m),y="Std Dev: ".concat(si(r.toFixed(2))," ").concat(m);if(g){for(var x=" SUV: ",T="".concat(x).concat(si(s.mean.toFixed(2))),b="".concat(x).concat(si(s.stdDev.toFixed(2))),C=Math.floor(e.measureText("".concat(y,"     ")).width);e.measureText(p).width<C;)p+=" ";v.push("".concat(p).concat(T)),v.push("".concat(y,"     ").concat(b))}else v.push("".concat(p)),v.push("".concat(y));if(f){for(var M="Min: ".concat(i," ").concat(m),E="Max: ".concat(l," ").concat(m),w=g?Math.floor(e.measureText("".concat(y,"     ")).width):Math.floor(e.measureText("".concat(p,"     ")).width);e.measureText(M).width<w;)M+=" ";v.push("".concat(M).concat(E))}}return h.push(Ci(a,u)),v.forEach((function(e){return h.push(e)})),h}function Ci(e,t){var n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(si(e.toFixed(2))).concat(n)}function Mi(e,t){return{left:Math.round(Math.min(e.x,t.x)),top:Math.round(Math.min(e.y,t.y)),width:Math.round(Math.abs(e.x-t.x)),height:Math.round(Math.abs(e.y-t.y))}}var Ei=function(e,t){for(var n=!1,a=e.length-1,o=0;o<e.length;o++)wi(t,e[o],e[a])&&(n=!n),a=o;return n};function wi(e,t,n){return a=e.y,o=t.y,r=n.y,!(!(o<a&&a<r||r<a&&a<o)||!function(e,t,n){if(t.x>e.x&&n.x>e.x)return!0;if(t.x===n.x)return e.x<t.x;if(t.x>n.x){var a=t;t=n,n=a}var o=function(e,t,n){var a=(n.y-t.y)/(n.x-t.x);return{value:t.y+a*(e.x-t.x),gradient:a}}(e,t,n);return Math.sign(o.gradient)*e.y>Math.sign(o.gradient)*o.value}(e,t,n));var a,o,r}function Ii(e,t,n,a){Ei(e,t)&&(n.value+=a,n.squared+=a*a,n.count++)}var Si=function e(t,n){i()(this,e),this.toolIndex=t,this.handleIndexArray=n},ki=function e(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];i()(this,e),this.x=t.x,this.y=t.y,this.highlight=n,this.active=a,this.lines=[]};function _i(e,t,n,a){for(var o=e.length-1,r=0;r<e.length;r++)if(-1===a.indexOf(r)&&-1===a.indexOf(o)){if(Pi(t,n,Di(e[o]),Di(e[r])))return!0;o=r}else o=r;return!1}function Pi(e,t,n,a){var o=!1,r=[Oi(e,t,n),Oi(e,t,a),Oi(n,a,e),Oi(n,a,t)];return r[0]!==r[1]&&r[2]!==r[3]||((0===r[0]&&Li(e,n,t)||0===r[1]&&Li(e,a,t)||0===r[2]&&Li(n,e,a)||0===r[3]&&Li(n,t,a))&&(o=!0),o)}function Di(e){return{x:e.x,y:e.y}}function Oi(e,t,n){var a=(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y);return 0===a?0:a>0?1:2}function Li(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}var Ri={newHandle:function(e,t){var n=t.length-1;return _i(t,Di(t[n]),Di(e),[n])},end:function(e){var t=e.length-1;return _i(e,Di(e[t]),Di(e[0]),[t,0])},modify:function(e,t){var n=Di(e[t]),a=t-1;0===t&&(a=e.length-1);var o=Di(e[a]);return!!_i(e,n,o,[t,a])||_i(e,n,o=Di(e[a=t===e.length-1?0:t+1]),[t,a])}},Ai=function(){function e(t,n){i()(this,e),this._eventData=t,this._toolName=n}return s()(e,[{key:"findLine",value:function(){var e=this.findTool();if(null===e)return null;var t=this._getCloseLinesInTool(e);return t?this._findCorrectLine(e,t):null}},{key:"findTool",value:function(){return this._toolData=O(this._eventData.element,this._toolName),this._mousePoint=this._eventData.currentPoints.canvas,this._toolData?this._nearestHandleToPointAllTools().toolIndex:null}},{key:"_nearestHandleToPointAllTools",value:function(){for(var e=this._toolData,t={toolIndex:null,handleIndex:null,distance:1/0},n=0;n<e.data.length;n++){var a=this._nearestHandleToPoint(n);null!==a&&(a.distance<t.distance&&(t=a))}return t}},{key:"_nearestHandleToPoint",value:function(e){var t=this._eventData,n=this._toolData.data[e],a=n.handles.points;if(void 0===a)return null;if(!1===n.visible)return null;for(var o={toolIndex:e,handleIndex:null,distance:1/0},r=0;r<a.length;r++){var i=y.cornerstone.pixelToCanvas(t.element,a[r]),l=y.cornerstoneMath.point.distance(i,this._mousePoint);l<o.distance&&(o.handleIndex=r,o.distance=l)}return o}},{key:"_getCloseLinesInTool",value:function(t){for(var n=this._toolData.data[t].handles.points,a=[],o=0;o<n.length;o++){var r=e.getNextHandleIndex(o,n.length);this._distanceOfPointfromLine(n[o],n[r])<10&&a.push([o,r])}return a}},{key:"_findCorrectLine",value:function(e,t){for(var n=0;n<t.length;n++)if(this._pointProjectsToLineSegment(e,t[n]))return new Si(e,t[n]);return null}},{key:"_pointProjectsToLineSegment",value:function(t,n){var a=this._eventData,o=this._toolData.data[t],r=o.handles.points;if(void 0!==o.handles.points){if(!1===o.visible)return!1;var i=r[n[0]],l=r[n[1]],s=e.getCanvasPointsFromHandles(i,l,a.element),c=e.getLineAsVector(s),u=this._getLineOriginToMouseAsVector(s),d=(u[0]*c[0]+u[1]*c[1])/c.magnitude;return d>0&&d<c.magnitude}}},{key:"_getLineOriginToMouseAsVector",value:function(e){return[this._mousePoint.x-e[0].x,this._mousePoint.y-e[0].y]}},{key:"_distanceOfPointfromLine",value:function(e,t){var n=this._eventData,a=y.cornerstone.pixelToCanvas(n.element,e),o=y.cornerstone.pixelToCanvas(n.element,t),r=this._mousePoint;return Math.abs((o.y-a.y)*r.x-(o.x-a.x)*r.y+o.x*a.y-o.y*a.x)/y.cornerstoneMath.point.distance(a,o)}}],[{key:"getCanvasPointsFromHandles",value:function(e,t,n){var a=[];return e.x<t.x?(a.push(y.cornerstone.pixelToCanvas(n,e)),a.push(y.cornerstone.pixelToCanvas(n,t))):(a.push(y.cornerstone.pixelToCanvas(n,t)),a.push(y.cornerstone.pixelToCanvas(n,e))),a}},{key:"getLineAsVector",value:function(e){var t=[e[1].x-e[0].x,e[1].y-e[0].y];return t.magnitude=y.cornerstoneMath.point.distance(e[0],e[1]),t}},{key:"getNextHandleIndex",value:function(e,t){return e<t-1?e+1:0}}]),e}(),Hi=function(e,t){t===e.length-1?e[t].lines.push(e[0]):e[t].lines.push(e[t+1])};function Ui(e,t){var n=O(e.element,this.name);if(void 0!==n){var a=t.handleIndex,o=t.toolIndex,r=n.data[o],i=r.handles.points;i.length<=3||(a===i.length-1?(i[a-1].lines.pop(),i[a-1].lines.push(i[0])):0===a?(i[i.length-1].lines.pop(),i[i.length-1].lines.push(i[a+1])):(i[a-1].lines.pop(),i[a-1].lines.push(i[a+1])),i.splice(a,1),r.invalidated=!0,r.active=!0,r.highlight=!0,y.cornerstone.updateImage(e.element))}}function Bi(e,t){var n=O(e.element,this.name);if(void 0!==n){var a=n.data[t.toolIndex],o=function(e){for(var t=e.handleIndexArray,n=1/0,a=t.includes(0),o=0;o<t.length;o++){var r=t[o];0!==r&&r<n&&(n=r)}a&&1===n&&(n=0);return++n}(t);if(o!==1/0){var r=new ki(e.currentPoints.image),i=a.handles.points;i.splice(o,0,r),i[o-1].lines.pop(),i[o-1].lines.push(e.currentPoints.image),Hi(i,o),a.active=!0,a.highlight=!0,a.invalidated=!0,y.cornerstone.updateImage(e.element)}}}var Ni={calculateFreehandStatistics:function(e,t,n){var a={count:0,mean:0,variance:0,stdDev:0},o=function(e,t,n){for(var a={value:0,squared:0,count:0},o=0,r=t.top;r<t.top+t.height;r++)for(var i=t.left;i<t.left+t.width;i++){Ii(n,{x:i,y:r},a,e[o]),o++}return a}(e,t,n);return 0===o.count||(a.count=o.count,a.mean=o.value/o.count,a.variance=o.squared/o.count-a.mean*a.mean,a.stdDev=Math.sqrt(a.variance)),a},ClickedLineData:Si,freehandArea:function(e,t){var n=0,a=e.length-1;t=t||1;for(var o=0;o<e.length;o++)n+=(e[a].x+e[o].x)*(e[a].y-e[o].y),a=o;return Math.abs(n*t/2)},FreehandHandleData:ki,freehandIntersect:Ri,FreehandLineFinder:Ai,insertOrDelete:function(e,t){var n=e.detail;if(t&&null!==t.handleNearby){var a={toolIndex:t.toolIndex,handleIndex:t.handleNearby};Ui.call(this,n,a)}else{var o=new Ai(n,this.name).findLine();o&&Bi.call(this,n,o)}},pointInFreehand:Ei,addLine:Hi};function Fi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Vi=B("tools:annotation:FreehandRoiTool"),qi=Ni.insertOrDelete,ji=Ni.freehandArea,zi=Ni.calculateFreehandStatistics,Wi=Ni.freehandIntersect,Gi=Ni.FreehandHandleData,Yi=function(e){u()(n,e);var t=Fi(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"FreehandRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{mouseLocation:{handles:{start:{highlight:!0,active:!0}}},spacing:1,activeHandleRadius:3,completeHandleRadius:6,completeHandleRadiusTouch:28,alwaysShowHandles:!1,invalidColor:"crimson",currentHandle:0,currentTool:-1,drawHandles:!0,drawStatistics:!1,renderDashed:!1},svgCursor:ko};return(e=t.call(this,a,o)).isMultiPartTool=!0,e._drawing=!1,e._dragging=!1,e._modifying=!1,e._drawingMouseDownCallback=e._drawingMouseDownCallback.bind(wa()(e)),e._drawingMouseMoveCallback=e._drawingMouseMoveCallback.bind(wa()(e)),e._drawingMouseDragCallback=e._drawingMouseDragCallback.bind(wa()(e)),e._drawingMouseUpCallback=e._drawingMouseUpCallback.bind(wa()(e)),e._drawingMouseDoubleClickCallback=e._drawingMouseDoubleClickCallback.bind(wa()(e)),e._editMouseUpCallback=e._editMouseUpCallback.bind(wa()(e)),e._editMouseDragCallback=e._editMouseDragCallback.bind(wa()(e)),e._drawingTouchStartCallback=e._drawingTouchStartCallback.bind(wa()(e)),e._drawingTouchDragCallback=e._drawingTouchDragCallback.bind(wa()(e)),e._drawingDoubleTapClickCallback=e._drawingDoubleTapClickCallback.bind(wa()(e)),e._editTouchDragCallback=e._editTouchDragCallback.bind(wa()(e)),e.throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image){var t={visible:!0,active:!0,invalidated:!0,color:void 0,handles:{points:[]}};return t.handles.textBox={active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},t}Vi.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n){var a=t&&t.handles&&t.handles.points;if(!a)throw new Error("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool"));return!(!a||!1===t.visible)&&void 0!==this._pointNearHandle(e,t,n)}},{key:"distanceFromPoint",value:function(e,t,n){for(var a=1/0,o=0;o<t.handles.points.length;o++){var r=y.cornerstoneMath.point.distance(t.handles.points[o],n);a=Math.min(a,r)}return a===1/0?-1:a}},{key:"distanceFromPointCanvas",value:function(e,t,n){var a=1/0;if(!t)return-1;for(var o=y.cornerstone.pixelToCanvas(e,n),r=t.handles.points,i=0;i<r.length;i++){var l=y.cornerstone.pixelToCanvas(e,r[i]),s=y.cornerstoneMath.point.distance(l,o);a=Math.min(a,s)}return a===1/0?-1:a}},{key:"updateCachedStats",value:function(e,t,n){for(var a,o,r=y.cornerstone.metaData.get("generalSeriesModule",e.imageId),i=r?r.modality:null,l=n.handles.points,s={left:l[0].x,right:l[0].x,bottom:l[0].y,top:l[0].x},c=0;c<l.length;c++)s.left=Math.min(s.left,l[c].x),s.right=Math.max(s.right,l[c].x),s.bottom=Math.min(s.bottom,l[c].y),s.top=Math.max(s.top,l[c].y);var u={left:s.left,top:s.bottom,width:Math.abs(s.right-s.left),height:Math.abs(s.top-s.bottom)};if(n.polyBoundingBox=u,!e.color){var d=y.cornerstone.getPixels(t,u.left,u.top,u.width,u.height);a=zi.call(this,d,u,n.handles.points),"PT"===i&&(o={mean:ni(e,(a.mean-e.intercept)/e.slope),stdDev:ni(e,(a.stdDev-e.intercept)/e.slope)}),a&&!isNaN(a.mean)&&(n.meanStdDev=a,n.meanStdDevSUV=o)}var f=lr(e),h=(f.colPixelSpacing||1)*(f.rowPixelSpacing||1),v=ji(n.handles.points,h);isNaN(v)||(n.area=v),n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=O(e.currentTarget,this.name);if(a)for(var o=n.image,r=n.element,i=this.configuration,l=y.cornerstone.metaData.get("generalSeriesModule",o.imageId),s=l?l.modality:null,c=_n(n.canvasContext.canvas),u=Xt.getToolWidth(),d=i.renderDashed,f=Tt("globalConfiguration").configuration.lineDash,h=function(e){var l=a.data[e];if(!1===l.visible)return"continue";Wt(c,(function(e){var a,s=un.getColorIfActive(l);l.active?l.handles.invalidHandlePlacement?(s=i.invalidColor,a=i.invalidColor):(s=un.getColorIfActive(l),a=un.getFillColor()):a=un.getToolColor();var c={color:s};if(d&&(c.lineDash=f),l.handles.points.length){var h=l.handles.points;$t(e,r,h[0],h,c),l.polyBoundingBox?$t(e,r,h[h.length-1],[h[0]],c):$t(e,r,h[h.length-1],[i.mouseLocation.handles.start],c)}if(c={color:s,fill:a},(i.alwaysShowHandles||l.active&&l.polyBoundingBox)&&(c.handleRadius=i.activeHandleRadius,t.configuration.drawHandles&&dn(e,n,l.handles.points,c)),l.canComplete){c.handleRadius=i.completeHandleRadius;var v=l.handles.points[0];t.configuration.drawHandles&&dn(e,n,[v],c)}if(l.active&&!l.polyBoundingBox){c.handleRadius=i.activeHandleRadius,t.configuration.drawHandles&&dn(e,n,i.mouseLocation.handles,c);var p=l.handles.points[0];t.configuration.drawHandles&&dn(e,n,[p],c)}if(!0!==l.invalidated||l.active||(l.meanStdDev&&l.meanStdDevSUV&&l.area?t.throttledUpdateCachedStats(o,r,l):t.updateCachedStats(o,r,l)),l.polyBoundingBox&&!l.handles.textBox.freehand){l.handles.textBox.hasMoved||(l.handles.textBox.x=l.polyBoundingBox.left+l.polyBoundingBox.width,l.handles.textBox.y=l.polyBoundingBox.top+l.polyBoundingBox.height/2);var y=g.call(t,l);t.configuration.drawStatistics&&Sn(e,r,l.handles.textBox,y,l.handles.points,m,s,u,0,!0)}}))},v=0;v<a.data.length;v++)h(v);function g(e){var t=e.meanStdDev,n=e.meanStdDevSUV,a=e.area,r=[];if(t&&void 0!==t.mean){var i="";"CT"===s&&(i="HU"),e.unit=i;var l="Mean: ".concat(si(t.mean.toFixed(2))," ").concat(i),c="StdDev: ".concat(si(t.stdDev.toFixed(2))," ").concat(i);if(n&&void 0!==n.mean){l+=" SUV: "+si(n.mean.toFixed(2)),c+=" SUV: "+si(n.stdDev.toFixed(2))}r.push(l),r.push(c)}if(a){var u=" mm".concat(String.fromCharCode(178)),d=lr(o),f=d.rowPixelSpacing,h=d.colPixelSpacing;f&&h||(u=" pixels".concat(String.fromCharCode(178)));var v="Area: ".concat(si(a.toFixed(2))).concat(u);r.push(v)}return r}function m(e){return e}}},{key:"addNewMeasurement",value:function(e){var t=e.detail;this._startDrawing(e),this._addPoint(t),Xi(e)}},{key:"preMouseDownCallback",value:function(e){var t=e.detail,n=this._pointNearHandleAllTools(t);return!!t.event.ctrlKey&&(void 0!==n&&n.handleNearby.hasBoundingBox||qi.call(this,e,n),Xi(e),!0)}},{key:"handleSelectedCallback",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o=e.detail.element,r=O(o,this.name);if(n.hasBoundingBox)fo(e,this,t,n,a);else{var i=this.configuration;i.dragOrigin={x:n.x,y:n.y};for(var l=0;l<r.data.length;l++)for(var s=r.data[l].handles.points,c=0;c<s.length;c++)s[c]===n&&(i.currentHandle=c,i.currentTool=l);this._modifying=!0,this._activateModify(o),Xi(e)}}},{key:"_drawingMouseMoveCallback",value:function(e){var t=e.detail,n=t.currentPoints,a=t.element,o=O(a,this.name),r=this.configuration,i=r.currentTool,l=o.data[i],s=n.canvas;this._getMouseLocation(t),this._checkInvalidHandleLocation(l,t);var c=this._pointNearHandle(a,l,s),u=l.handles.points;void 0!==c&&!c.hasBoundingBox&&c<u.length-1&&(r.mouseLocation.handles.start.x=u[c].x,r.mouseLocation.handles.start.y=u[c].y),y.cornerstone.updateImage(a)}},{key:"_drawingMouseDragCallback",value:function(e){this.options.mouseButtonMask.includes(e.detail.buttons)&&this._drawingDrag(e)}},{key:"_drawingTouchDragCallback",value:function(e){this._drawingDrag(e)}},{key:"_drawingDrag",value:function(e){var t=e.detail,n=t.element,a=O(n,this.name),o=this.configuration.currentTool,r=a.data[o];this._getMouseLocation(t),this._checkInvalidHandleLocation(r,t),this._addPointPencilMode(t,r.handles.points),this._dragging=!0,y.cornerstone.updateImage(n)}},{key:"_drawingMouseUpCallback",value:function(e){var t=e.detail.element;if(this._dragging){this._dragging=!1;var n=this.configuration,a=n.currentTool,o=O(t,this.name).data[a];if(!Wi.end(o.handles.points)&&o.canComplete){var r=n.currentHandle;this._endDrawing(t,r)}Xi(e)}}},{key:"_drawingMouseDownCallback",value:function(e){var t=e.detail,n=t.buttons,a=t.currentPoints,o=t.element;if(this.options.mouseButtonMask.includes(n)){var r=a.canvas,i=this.configuration,l=i.currentTool,s=O(o,this.name).data[l],c=this._pointNearHandle(o,s,r);if(!Wi.end(s.handles.points)&&s.canComplete){var u=i.currentHandle;this._endDrawing(o,u)}else void 0===c&&this._addPoint(t);Xi(e)}}},{key:"_drawingTouchStartCallback",value:function(e){var t=e.detail,n=t.currentPoints,a=t.element,o=n.canvas,r=this.configuration,i=r.currentTool,l=O(a,this.name).data[i],s=this._pointNearHandle(a,l,o);if(!Wi.end(l.handles.points)&&l.canComplete){var c=r.currentHandle;this._endDrawing(a,c)}else void 0===s&&this._addPoint(t);Xi(e)}},{key:"completeDrawing",value:function(e){if(this._drawing){var t=O(e,this.name),n=this.configuration,a=t.data[n.currentTool];if(!Wi.end(a.handles.points)&&a.handles.points.length>=2){var o=n.currentHandle;a.polyBoundingBox={},this._endDrawing(e,o)}}}},{key:"_drawingMouseDoubleClickCallback",value:function(e){var t=e.detail.element;this.completeDrawing(t),Xi(e)}},{key:"_drawingDoubleTapClickCallback",value:function(e){var t=e.detail.element;this.completeDrawing(t),Xi(e)}},{key:"_editMouseDragCallback",value:function(e){var t=e.detail,n=t.element,a=t.buttons;if(this.options.mouseButtonMask.includes(a)){var o,r=O(n,this.name),i=this.configuration,l=r.data[i.currentTool],s=i.currentHandle,c=l.handles.points;if(this._getMouseLocation(t),l.handles.invalidHandlePlacement=Wi.modify(c,s),l.active=!0,l.highlight=!0,c[s].x=i.mouseLocation.handles.start.x,c[s].y=i.mouseLocation.handles.start.y,o=this._getPrevHandleIndex(s,c),s>=0){var u=c[o].lines.length-1,d=c[o].lines[u];d.x=i.mouseLocation.handles.start.x,d.y=i.mouseLocation.handles.start.y}y.cornerstone.updateImage(n)}}},{key:"_editTouchDragCallback",value:function(e){var t,n=e.detail,a=n.element,o=O(a,this.name),r=this.configuration,i=o.data[r.currentTool],l=r.currentHandle,s=i.handles.points;if(this._getMouseLocation(n),i.handles.invalidHandlePlacement=Wi.modify(s,l),i.active=!0,i.highlight=!0,s[l].x=r.mouseLocation.handles.start.x,s[l].y=r.mouseLocation.handles.start.y,t=this._getPrevHandleIndex(l,s),l>=0){var c=s[t].lines.length-1,u=s[t].lines[c];u.x=r.mouseLocation.handles.start.x,u.y=r.mouseLocation.handles.start.y}y.cornerstone.updateImage(a)}},{key:"_getPrevHandleIndex",value:function(e,t){return 0===e?t.length-1:e-1}},{key:"_editMouseUpCallback",value:function(e){var t=e.detail,n=t.element,a=O(n,this.name);this._deactivateModify(n),this._dropHandle(t,a),this._endDrawing(n),y.cornerstone.updateImage(n)}},{key:"_dropHandle",value:function(e,t){var n=this.configuration,a=n.currentTool,o=t.data[a].handles,r=o.points;if(o.invalidHandlePlacement){var i,l=n.currentHandle,s=r[l];if(0===l)i=r[r.length-1];else i=r[l-1];s.x=n.dragOrigin.x,s.y=n.dragOrigin.y,i.lines[0]=s,o.invalidHandlePlacement=!1}}},{key:"_startDrawing",value:function(e){var t,n=e.detail,a=this.createNewMeasurement(n),o=n.element,r=this.configuration;e.type===b.MOUSE_DOWN_ACTIVATE?t="Mouse":e.type===b.TOUCH_START_ACTIVE&&(t="Touch"),this._activateDraw(o,t),this._getMouseLocation(n),D(o,this.name,a);var i=O(o,this.name);r.currentTool=i.data.length-1,this._activeDrawingToolReference=i.data[r.currentTool]}},{key:"_addPoint",value:function(e){var t=e.currentPoints,n=e.element,a=O(n,this.name),o=this.configuration,r=a.data[o.currentTool];if(!r.handles.invalidHandlePlacement){var i=new Gi(t.image);r.handles.points.length&&r.handles.points[o.currentHandle-1].lines.push(t.image),r.handles.points.push(i),o.currentHandle+=1,y.cornerstone.updateImage(n),this.fireModifiedEvent(n,r)}}},{key:"_addPointPencilMode",value:function(e,t){var n=this,a=this.configuration,o=e.element,r=a.mouseLocation.handles.start;t.every((function(e){return n._isDistanceLargerThanSpacing(o,e,r)}))&&this._addPoint(e)}},{key:"_endDrawing",value:function(e,t){var n=O(e,this.name),a=this.configuration,o=n.data[a.currentTool];if(o.active=!1,o.highlight=!1,o.handles.invalidHandlePlacement=!1,void 0!==t){var r=o.handles.points;r[a.currentHandle-1].lines.push(r[0])}this._modifying&&(this._modifying=!1,o.invalidated=!0),a.currentHandle=0,a.currentTool=-1,o.canComplete=!1,this._drawing&&this._deactivateDraw(e),y.cornerstone.updateImage(e),this.fireModifiedEvent(e,o),this.fireCompletedEvent(e,o)}},{key:"_pointNearHandle",value:function(e,t,n){if(void 0!==t.handles&&void 0!==t.handles.points&&!1!==t.visible){for(var a=0;a<t.handles.points.length;a++){var o=y.cornerstone.pixelToCanvas(e,t.handles.points[a]);if(y.cornerstoneMath.point.distance(o,n)<6)return a}return t.handles.textBox&&ga(t.handles.textBox,n)?t.handles.textBox:void 0}}},{key:"_pointNearHandleAllTools",value:function(e){var t=e.currentPoints,n=e.element,a=t.canvas,o=O(n,this.name);if(o)for(var r,i=0;i<o.data.length;i++)if(void 0!==(r=this._pointNearHandle(n,o.data[i],a)))return{handleNearby:r,toolIndex:i}}},{key:"_getMouseLocation",value:function(e){var t=e.currentPoints,n=e.image,a=this.configuration;a.mouseLocation.handles.start.x=t.image.x,a.mouseLocation.handles.start.y=t.image.y,Mn(a.mouseLocation.handles.start,n)}},{key:"_checkInvalidHandleLocation",value:function(e,t){if(e.handles.points.length<2)return!0;var n;n=this._dragging?this._checkHandlesPencilMode(e,t):this._checkHandlesPolygonMode(e,t),e.handles.invalidHandlePlacement=n}},{key:"_checkHandlesPolygonMode",value:function(e,t){var n=this.configuration,a=t.element,o=n.mouseLocation.handles.start,r=e.handles.points,i=!1;return e.canComplete=!1,this._isDistanceSmallerThanCompleteSpacingCanvas(a,r[0],o)&&!Wi.end(r)&&r.length>2?(e.canComplete=!0,i=!1):i=Wi.newHandle(o,r),i}},{key:"_checkHandlesPencilMode",value:function(e,t){var n=this.configuration.mouseLocation.handles.start,a=e.handles.points,o=Wi.newHandle(n,a);return!1===o&&(o=this._invalidHandlePencilMode(e,t)),o}},{key:"_invalidHandlePencilMode",value:function(e,t){var n=this.configuration,a=t.element,o=n.mouseLocation.handles.start,r=e.handles.points;if(this._isDistanceSmallerThanCompleteSpacingCanvas(a,r[0],o))return e.canComplete=!0,!1;e.canComplete=!1;for(var i=1;i<r.length-1;i++)if(this._isDistanceSmallerThanSpacing(a,r[i],o))return!0;return!1}},{key:"_isDistanceSmallerThanCompleteSpacingCanvas",value:function(e,t,n){var a,o=y.cornerstone.pixelToCanvas(e,t),r=y.cornerstone.pixelToCanvas(e,n);return"Mouse"===this._drawingInteractionType?a=this.configuration.completeHandleRadius:"Touch"===this._drawingInteractionType&&(a=this.configuration.completeHandleRadiusTouch),this._compareDistanceToSpacing(e,o,r,"<",a)}},{key:"_isDistanceSmallerThanSpacing",value:function(e,t,n){return this._compareDistanceToSpacing(e,t,n,"<")}},{key:"_isDistanceLargerThanSpacing",value:function(e,t,n){return this._compareDistanceToSpacing(e,t,n,">")}},{key:"_compareDistanceToSpacing",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:">",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.configuration.spacing;return">"===a?y.cornerstoneMath.point.distance(t,n)>o:y.cornerstoneMath.point.distance(t,n)<o}},{key:"_activateDraw",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Mouse";this._drawing=!0,this._drawingInteractionType=t,pt.isMultiPartToolActive=!0,wt(this.element),e.addEventListener(b.MOUSE_DOWN,this._drawingMouseDownCallback),e.addEventListener(b.MOUSE_MOVE,this._drawingMouseMoveCallback),e.addEventListener(b.MOUSE_DOUBLE_CLICK,this._drawingMouseDoubleClickCallback),e.addEventListener(b.MOUSE_DRAG,this._drawingMouseDragCallback),e.addEventListener(b.MOUSE_UP,this._drawingMouseUpCallback),e.addEventListener(b.TOUCH_START,this._drawingMouseMoveCallback),e.addEventListener(b.TOUCH_START,this._drawingTouchStartCallback),e.addEventListener(b.TOUCH_DRAG,this._drawingTouchDragCallback),e.addEventListener(b.TOUCH_END,this._drawingMouseUpCallback),e.addEventListener(b.DOUBLE_TAP,this._drawingDoubleTapClickCallback),y.cornerstone.updateImage(e)}},{key:"_deactivateDraw",value:function(e){this._drawing=!1,pt.isMultiPartToolActive=!1,this._activeDrawingToolReference=null,this._drawingInteractionType=null,Et(this.element,this.svgCursor),e.removeEventListener(b.MOUSE_DOWN,this._drawingMouseDownCallback),e.removeEventListener(b.MOUSE_MOVE,this._drawingMouseMoveCallback),e.removeEventListener(b.MOUSE_DOUBLE_CLICK,this._drawingMouseDoubleClickCallback),e.removeEventListener(b.MOUSE_DRAG,this._drawingMouseDragCallback),e.removeEventListener(b.MOUSE_UP,this._drawingMouseUpCallback),e.removeEventListener(b.TOUCH_START,this._drawingTouchStartCallback),e.removeEventListener(b.TOUCH_DRAG,this._drawingTouchDragCallback),e.removeEventListener(b.TOUCH_START,this._drawingMouseMoveCallback),e.removeEventListener(b.TOUCH_END,this._drawingMouseUpCallback),y.cornerstone.updateImage(e)}},{key:"_activateModify",value:function(e){pt.isToolLocked=!0,e.addEventListener(b.MOUSE_UP,this._editMouseUpCallback),e.addEventListener(b.MOUSE_DRAG,this._editMouseDragCallback),e.addEventListener(b.MOUSE_CLICK,this._editMouseUpCallback),e.addEventListener(b.TOUCH_END,this._editMouseUpCallback),e.addEventListener(b.TOUCH_DRAG,this._editTouchDragCallback),y.cornerstone.updateImage(e)}},{key:"_deactivateModify",value:function(e){pt.isToolLocked=!1,e.removeEventListener(b.MOUSE_UP,this._editMouseUpCallback),e.removeEventListener(b.MOUSE_DRAG,this._editMouseDragCallback),e.removeEventListener(b.MOUSE_CLICK,this._editMouseUpCallback),e.removeEventListener(b.TOUCH_END,this._editMouseUpCallback),e.removeEventListener(b.TOUCH_DRAG,this._editTouchDragCallback),y.cornerstone.updateImage(e)}},{key:"passiveCallback",value:function(e){this._closeToolIfDrawing(e)}},{key:"enabledCallback",value:function(e){this._closeToolIfDrawing(e)}},{key:"disabledCallback",value:function(e){this._closeToolIfDrawing(e)}},{key:"_closeToolIfDrawing",value:function(e){if(this._drawing){var t=this.configuration.currentHandle;this._endDrawing(e,t),y.cornerstone.updateImage(e)}}},{key:"fireModifiedEvent",value:function(e,t){C(e,b.MEASUREMENT_MODIFIED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}},{key:"fireCompletedEvent",value:function(e,t){C(e,b.MEASUREMENT_COMPLETED,{toolName:this.name,toolType:this.name,element:e,measurementData:t})}},{key:"spacing",get:function(){return this.configuration.spacing},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehand spacing to a value other than a number.");this.configuration.spacing=e,y.cornerstone.updateImage(this.element)}},{key:"activeHandleRadius",get:function(){return this.configuration.activeHandleRadius},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehand activeHandleRadius to a value other than a number.");this.configuration.activeHandleRadius=e,y.cornerstone.updateImage(this.element)}},{key:"completeHandleRadius",get:function(){return this.configuration.completeHandleRadius},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehand completeHandleRadius to a value other than a number.");this.configuration.completeHandleRadius=e,y.cornerstone.updateImage(this.element)}},{key:"alwaysShowHandles",get:function(){return this.configuration.alwaysShowHandles},set:function(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehand alwaysShowHandles to a value other than a boolean.");this.configuration.alwaysShowHandles=e,y.cornerstone.updateImage(this.element)}},{key:"invalidColor",get:function(){return this.configuration.invalidColor},set:function(e){this.configuration.invalidColor=e,y.cornerstone.updateImage(this.element)}},{key:"cancelDrawing",value:function(e){if(this._drawing){var t=O(e,this.name),n=this.configuration,a=t.data[n.currentTool];a.active=!1,a.highlight=!1,a.handles.invalidHandlePlacement=!1,n.currentHandle=0,n.currentTool=-1,a.canComplete=!1,L(e,this.name,a),this._deactivateDraw(e),y.cornerstone.updateImage(e)}}},{key:"newImageCallback",value:function(e){var t=this.configuration;if(this._drawing&&this._activeDrawingToolReference){var n=e.detail.element,a=this._activeDrawingToolReference;a.active=!1,a.highlight=!1,a.handles.invalidHandlePlacement=!1;var o=a.handles.points;o[t.currentHandle-1].lines.push(o[0]),t.currentHandle=0,t.currentTool=-1,a.canComplete=!1,this._deactivateDraw(n),y.cornerstone.updateImage(n)}}}]),n}(po);function Xi(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()}function Ki(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Zi=B("tools:annotation:LengthTool"),$i=function(e){u()(n,e);var t=Ki(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Length",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Po,configuration:{drawHandles:!0,drawHandlesOnHover:!1,hideHandlesIfMoving:!1,renderDashed:!1,digits:2}};return(e=t.call(this,a,o)).throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image){var t=e.currentPoints.image,n=t.x,a=t.y;return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:n,y:a,highlight:!0,active:!1},end:{x:n,y:a,highlight:!0,active:!0},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}}Zi.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n){return t&&t.handles&&t.handles.start&&t.handles.end?!1!==t.visible&&yo(e,t.handles.start,t.handles.end,n)<25:(Zi.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!1)}},{key:"updateCachedStats",value:function(e,t,n){var a=lr(e),o=a.rowPixelSpacing,r=a.colPixelSpacing,i=(n.handles.end.x-n.handles.start.x)*(r||1),l=(n.handles.end.y-n.handles.start.y)*(o||1),s=Math.sqrt(i*i+l*l);n.length=s,n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=this.configuration,o=a.handleRadius,r=a.drawHandlesOnHover,i=a.hideHandlesIfMoving,l=a.renderDashed,s=a.digits,c=O(e.currentTarget,this.name);if(c)for(var u=_n(n.canvasContext.canvas),d=n.image,f=n.element,h=lr(d),v=h.rowPixelSpacing,g=h.colPixelSpacing,m=(Xt.getToolWidth(),Tt("globalConfiguration").configuration.lineDash),p=function(e){var a=c.data[e];if(!1===a.visible)return"continue";Wt(u,(function(e){Dn(e,t.configuration);var c=un.getColorIfActive(a),u={color:c};l&&(u.lineDash=m),Zt(e,f,a.handles.start,a.handles.end,u);var h={color:c,handleRadius:o,drawHandlesIfActive:r,hideHandlesIfMoving:i};if(t.configuration.drawHandles&&dn(e,n,a.handles,h),!a.handles.textBox.hasMoved){var p={x:Math.max(a.handles.start.x,a.handles.end.x)};p.x===a.handles.start.x?p.y=a.handles.start.y:p.y=a.handles.end.y,a.handles.textBox.x=p.x,a.handles.textBox.y=p.y}!0===a.invalidated&&(a.length?t.throttledUpdateCachedStats(d,f,a):t.updateCachedStats(d,f,a));!function(e,t,n){var a=(o=e.length,r=Number(o),isNaN(r)?void 0:r);var o,r;if(!a)return"";var i="mm";t&&n||(i="pixels");e.unit=i,"".concat(a.toFixed(s)," ").concat(i)}(a,v,g)}))},y=0;y<c.data.length;y++)p(y)}}]),n}(po);var Ji=function(e,t,n,a,o){if(!e)throw new Error("getRGBPixels: parameter element must not be undefined");t=Math.round(t),n=Math.round(n);var r,i,l,s=y.cornerstone.getEnabledElement(e),c=[],u=0,d=s.image.getPixelData();if(s.image.color)for(i=0;i<o;i++)for(l=0;l<a;l++){var f=d[r=4*((i+n)*s.image.columns+(l+t))],h=d[r+1],v=d[r+2],g=d[r+3];c[u++]=f,c[u++]=h,c[u++]=v,c[u++]=g}return c};function Qi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var el=B("tools:annotation:ProbeTool"),tl=function(e){u()(n,e);var t=Qi(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Probe",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Do,configuration:{drawHandles:!0,renderDashed:!1}};return(e=t.call(this,a,o)).throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0}}};el.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n){var a=t&&t.handles&&t.handles.end;if(a||el.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!a||!1===t.visible)return!1;var o=y.cornerstone.pixelToCanvas(e,t.handles.end);return y.cornerstoneMath.point.distance(o,n)<5}},{key:"updateCachedStats",value:function(e,t,n){var a=Math.round(n.handles.end.x),o=Math.round(n.handles.end.y),r={};a>=0&&o>=0&&a<e.columns&&o<e.rows&&(r.x=a,r.y=o,e.color?r.storedPixels=Ji(t,a,o,1,1):(r.storedPixels=y.cornerstone.getStoredPixels(t,a,o,1,1),r.sp=r.storedPixels[0],r.mo=r.sp*e.slope+e.intercept,r.suv=ni(e,r.sp))),n.cachedStats=r,n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=this.configuration,o=a.handleRadius,r=a.renderDashed,i=O(e.currentTarget,this.name);if(i)for(var l=_n(n.canvasContext.canvas),s=n.image,c=n.element,u=(pn.getFontSize(),Tt("globalConfiguration").configuration.lineDash),d=function(e){var a=i.data[e];if(!1===a.visible)return"continue";Wt(l,(function(e){var i=un.getColorIfActive(a);if(t.configuration.drawHandles){var l={handleRadius:o,color:i};r&&(l.lineDash=u),dn(e,n,a.handles,l)}!0===a.invalidated&&(a.cachedStats?t.throttledUpdateCachedStats(s,c,a):t.updateCachedStats(s,c,a));var d=a.cachedStats,f=d.x,h=d.y,v=d.storedPixels,g=d.sp,m=d.mo,p=d.suv;if(f>=0&&h>=0&&f<s.columns&&h<s.rows){"".concat(f,", ").concat(h),s.color?"R: ".concat(v[0]," G: ").concat(v[1]," B: ").concat(v[2]):("SP: ".concat(g," MO: ").concat(parseFloat(m.toFixed(3))),p&&" SUV: ".concat(parseFloat(p.toFixed(3))));var x={x:a.handles.end.x+3,y:a.handles.end.y-3};y.cornerstone.pixelToCanvas(n.element,x)}}))},f=0;f<i.data.length;f++)d(f)}}]),n}(po);function nl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var al=B("tools:annotation:RectangleRoiTool"),ol=function(e){u()(n,e);var t=nl(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"RectangleRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{drawHandles:!0,drawHandlesOnHover:!1,drawStatistics:!1,hideHandlesIfMoving:!1,renderDashed:!1,mouseEditingRadius:15,touchEditingRadius:25},svgCursor:Oo};return(e=t.call(this,a,o)).throttledUpdateCachedStats=ur(e.updateCachedStats,110),e}return s()(n,[{key:"createNewMeasurement",value:function(e){if(e&&e.currentPoints&&e.currentPoints.image)return{visible:!0,active:!0,color:void 0,invalidated:!0,handles:{start:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!1},end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0},initialRotation:e.viewport.rotation,textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}};al.error("required eventData not supplied to tool ".concat(this.name,"'s createNewMeasurement"))}},{key:"pointNearTool",value:function(e,t,n,a){var o=t&&t.handles&&t.handles.start&&t.handles.end;if(o||al.warn("invalid parameters supplied to tool ".concat(this.name,"'s pointNearTool")),!o||!1===t.visible)return!1;var r=this.configuration,i=r.touchEditingRadius,l=r.mouseEditingRadius,s="mouse"===a?l:i,c=y.cornerstone.pixelToCanvas(e,t.handles.start),u=y.cornerstone.pixelToCanvas(e,t.handles.end),d={left:Math.min(c.x,u.x),top:Math.min(c.y,u.y),width:Math.abs(c.x-u.x),height:Math.abs(c.y-u.y)};return y.cornerstoneMath.rect.distanceToPoint(d,n)<s}},{key:"updateCachedStats",value:function(e,t,n){var a=(y.cornerstone.metaData.get("generalSeriesModule",e.imageId)||{}).modality,o=lr(e),r=function(e,t,n,a,o){var r,i=rl(n.start,n.end),l=function(e,t){for(var n=0,a=0,o=0,r=0,i=e?e[0]:null,l=e?e[0]:null,s=t.top;s<t.top+t.height;s++)for(var c=t.left;c<t.left+t.width;c++)n+=e[r],a+=e[r]*e[r],i=Math.min(i,e[r]),l=Math.max(l,e[r]),o++,r++;if(0===o)return{count:o,mean:0,variance:0,stdDev:0,min:0,max:0};var u=n/o,d=a/o-u*u;return{count:o,mean:u,variance:d,stdDev:Math.sqrt(d),min:i,max:l}}(y.cornerstone.getPixels(t,i.left,i.top,i.width,i.height),i);"PT"===a&&(r={mean:ni(e,l.mean,!0)||0,stdDev:ni(e,l.stdDev,!0)||0});var s=i.width*(o.colPixelSpacing||1)*(i.height*(o.rowPixelSpacing||1)),c=2*i.width*(o.colPixelSpacing||1)+2*i.height*(o.rowPixelSpacing||1);return{area:s||0,perimeter:c,count:l.count||0,mean:l.mean||0,variance:l.variance||0,stdDev:l.stdDev||0,min:l.min||0,max:l.max||0,meanStdDevSUV:r}}(e,t,n.handles,a,o);n.cachedStats=r,n.invalidated=!1}},{key:"renderToolData",value:function(e){var t=this,n=O(e.currentTarget,this.name);if(n){var a=e.detail,o=a.image,r=a.element,i=Xt.getToolWidth(),l=Tt("globalConfiguration").configuration.lineDash,s=this.configuration,c=s.handleRadius,u=s.drawHandlesOnHover,d=s.hideHandlesIfMoving,f=s.renderDashed,h=_n(a.canvasContext.canvas),v=lr(o),g=v.rowPixelSpacing,m=v.colPixelSpacing,p=(y.cornerstone.metaData.get("generalSeriesModule",o.imageId)||{}).modality,x=g&&m;Wt(h,(function(e){for(var s=0;s<n.data.length;s++){var h=n.data[s];if(!1!==h.visible){var v=un.getColorIfActive(h),g={color:v,handleRadius:c,drawHandlesIfActive:u,hideHandlesIfMoving:d};Dn(e,t.configuration);var m={color:v};if(f&&(m.lineDash=l),kn(e,r,h.handles.start,h.handles.end,m,"pixel",h.handles.initialRotation),t.configuration.drawHandles&&"AI"!==h.source&&dn(e,a,h.handles,g),!0===h.invalidated&&(h.cachedStats?t.throttledUpdateCachedStats(o,r,h):t.updateCachedStats(o,r,h)),!h.handles.textBox.hasMoved){var y=li(a.viewport,h.handles);Object.assign(h.handles.textBox,y)}var T=sl(e,o.color,h.cachedStats,p,x,t.configuration);h.unit=ll(p,t.configuration.showHounsfieldUnits),t.configuration.drawStatistics&&Sn(e,r,h.handles.textBox,T,h.handles,(function(e){return t=e.start,n=e.end,a=rl(t,n),o=a.left,r=a.top,i=a.width,l=a.height,[{x:o+i/2,y:r},{x:o,y:r+l/2},{x:o+i/2,y:r+l},{x:o+i,y:r+l/2}];var t,n,a,o,r,i,l}),v,i,10,!0)}}}))}}}]),n}(po);function rl(e,t){return{left:Math.min(e.x,t.x),top:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}}function il(e,t){var n=t?" mm".concat(String.fromCharCode(178)):" px".concat(String.fromCharCode(178));return"Area: ".concat(si(e.toFixed(2))).concat(n)}function ll(e,t){return"CT"===e&&!1!==t?"HU":""}function sl(e,t,n,a,o){var r=n.area,i=n.mean,l=n.stdDev,s=n.min,c=n.max,u=n.meanStdDevSUV,d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},f=d.showMinMax||!1,h=[],v=[];if(!t){var g=u&&0!==u.mean,m=ll(a,d.showHounsfieldUnits),p="Mean: ".concat(si(i.toFixed(2))," ").concat(m),y="Std Dev: ".concat(si(l.toFixed(2))," ").concat(m);if(g){for(var x=" SUV: ",T="".concat(x).concat(si(u.mean.toFixed(2))),b="".concat(x).concat(si(u.stdDev.toFixed(2))),C=Math.floor(e.measureText("".concat(y,"     ")).width);e.measureText(p).width<C;)p+=" ";v.push("".concat(p).concat(T)),v.push("".concat(y,"     ").concat(b))}else v.push("".concat(p)),v.push("".concat(y));if(f){for(var M="Min: ".concat(s," ").concat(m),E="Max: ".concat(c," ").concat(m),w=g?Math.floor(e.measureText("".concat(y,"     ")).width):Math.floor(e.measureText("".concat(p,"     ")).width);e.measureText(M).width<w;)M+=" ";v.push("".concat(M).concat(E))}}return h.push(il(r,o)),v.forEach((function(e){return h.push(e)})),h}function cl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ul=function(e){u()(n,e);var t=cl(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"TextMarker",supportedInteractionTypes:["Mouse","Touch"],configuration:{markers:[],current:"",ascending:!0,loop:!1,changeTextCallback:dl},svgCursor:Lo};return(e=t.call(this,a,o)).touchPressCallback=e._changeText.bind(wa()(e)),e.doubleClickCallback=e._changeText.bind(wa()(e)),e}return s()(n,[{key:"createNewMeasurement",value:function(e){var t=this.configuration;if(t.current){var n={visible:!0,active:!0,text:t.current,color:void 0,handles:{end:{x:e.currentPoints.image.x,y:e.currentPoints.image.y,highlight:!0,active:!0,hasBoundingBox:!0}}},a={left:0,top:0,width:e.image.width,height:e.image.height};if(y.cornerstoneMath.point.insideRect(n.handles.end,a)){var o=t.markers.indexOf(t.current);return(o+=t.ascending?1:-1)>=t.markers.length?o=t.loop?0:-1:o<0&&(o=t.loop?t.markers.length:-1),t.current=t.markers[o],n}}}},{key:"pointNearTool",value:function(e,t,n){if(!1===t.visible)return!1;if(t.handles.end.boundingBox){var a=y.cornerstoneMath.rect.distanceToPoint(t.handles.end.boundingBox,n),o=ga(t.handles.end,n);return a<10||o}}},{key:"updateCachedStats",value:function(){}},{key:"renderToolData",value:function(e){var t=e.detail,n=this.configuration,a=O(t.element,this.name);if(a)for(var o=_n(t.canvasContext.canvas),r=function(e){var r=a.data[e];if(!1===r.visible)return"continue";var i=un.getColorIfActive(r);Wt(o,(function(e){Dn(e,n);var a=y.cornerstone.pixelToCanvas(t.element,r.handles.end);r.handles.end.boundingBox=bn(e,r.text,a.x,a.y-10,i,{centering:{x:!0,y:!0}})}))},i=0;i<a.data.length;i++)r(i)}},{key:"_changeText",value:function(e){var t,n=e.detail,a=n.element,o=n.currentPoints;function r(e,t,n){!0===n?L(a,this.name,e):e.text=t,e.active=!1,y.cornerstone.updateImage(a)}var i=this.configuration,l=o.canvas,s=O(a,this.name);if(s)for(var c=0;c<s.data.length;c++)if(t=s.data[c],this.pointNearTool(a,t,l))return t.active=!0,y.cornerstone.updateImage(a),i.changeTextCallback(t,n,r),e.stopImmediatePropagation(),e.preventDefault(),void e.stopPropagation()}}]),n}(po),dl=function(e,t,n){n(e,prompt("Change your annotation:"))};function fl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}B("tools:BrushTool");var hl=Tt("segmentation"),vl=function(e){u()(n,e);var t=fl(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Brush",supportedInteractionTypes:["Mouse","Touch"],configuration:{},mixins:["renderBrushMixin"]};return(e=t.call(this,a,o)).touchDragCallback=e._paint.bind(wa()(e)),e}return s()(n,[{key:"_paint",value:function(e){var t=hl.configuration,n=e.detail,a=(n.element,n.image),o=a.rows,r=a.columns,i=n.currentPoints.image,l=i.x,s=i.y;if(!(l<0||l>r||s<0||s>o)){var c=be(t.radius,o,r,l,s),u=this.paintEventData,d=u.labelmap2D,f=u.labelmap3D,h=u.shouldErase;te(c,d.pixelData,f.activeSegmentIndex,r,h),y.cornerstone.updateImage(e.detail.element)}}}]),n}(_a);function gl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ml=B("tools:SphericalBrushTool"),pl=Tt("segmentation"),yl=function(e){u()(n,e);var t=gl(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"SphericalBrush",supportedInteractionTypes:["Mouse","Touch"],configuration:{alwaysEraseOnClick:!1},mixins:["renderBrushMixin"]};return(e=t.call(this,a,o)).touchDragCallback=e._paint.bind(wa()(e)),e}return s()(n,[{key:"_startPainting",value:function(e){var t,n=pl.configuration,a=pl.getters,o=e.detail,r=o.element,i=o.image,l=y.cornerstone,s=n.radius,c=i.rows,u=i.columns,d=Math.max(i.rowPixelSpacing,i.columnPixelSpacing),f=O(r,"stack").data[0].imageIds,h=a.labelmap2D(r),v=h.labelmap2D,g=h.labelmap3D,m=h.currentImageIdIndex,p=h.activeLabelmapIndex,x=this._isCtrlDown(o)||this.configuration.alwaysEraseOnClick,T=l.metaData.get("imagePlaneModule",i.imageId);if(T){var b=T.imagePositionPatient;t=this._getImagesInRange(m,b,f,s,d)}else ml.warn("No imagePlane metadata found for image, defaulting to circle brush application."),t=[{imageIdIndex:m,radiusOnImage:s}];if(this.paintEventData={labelmap2D:v,labelmap3D:g,currentImageIdIndex:m,activeLabelmapIndex:p,shouldErase:x,imagesInRange:t},n.storeHistory){for(var C=[],M=0;M<t.length;M++){var E=t[M].imageIdIndex,w=a.labelmap2DByImageIdIndex(g,E,c,u).pixelData.slice();C.push(w)}this.paintEventData.previousPixeldataForImagesInRange=C}}},{key:"_paint",value:function(e){var t=pl.getters,n=e.detail,a=(n.element,n.image),o=a.rows,r=a.columns,i=n.currentPoints.image,l=i.x,s=i.y;if(!(l<0||l>r||s<0||s>o)){for(var c=this.paintEventData,u=c.labelmap3D,d=c.imagesInRange,f=c.shouldErase,h=0;h<d.length;h++){var v=d[h],g=v.imageIdIndex;te(be(v.radiusOnImage,o,r,l,s),t.labelmap2DByImageIdIndex(u,g,o,r).pixelData,u.activeSegmentIndex,r,f)}y.cornerstone.updateImage(e.detail.element)}}},{key:"_getImagesInRange",value:function(e,t,n,a,o){for(var r=a*o,i=[{imageIdIndex:e,radiusOnImage:a}],l=e+1;l<n.length;l++){var s=this._getRadiusOnImage(n[l],t,r,o);if(!s)break;i.push({imageIdIndex:l,radiusOnImage:s})}for(var c=e-1;c>=0;c--){var u=this._getRadiusOnImage(n[c],t,r,o);if(!u)break;i.push({imageIdIndex:c,radiusOnImage:u})}return i}},{key:"_getRadiusOnImage",value:function(e,t,n,a){var o=y.cornerstone.metaData.get("imagePlaneModule",e);if(o){var r=o.imagePositionPatient,i=Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2)+Math.pow(r[2]-t[2],2));if(!(i>n))return Math.floor(Math.sqrt(Math.pow(n,2)-Math.pow(i,2))/a)}else ml.warn("Can't find imagePlane metadata for image, cancelling spherical brushing on: ".concat(e,","))}},{key:"_endPainting",value:function(e){for(var t=this.paintEventData,n=t.labelmap3D,a=t.imagesInRange,o=[],r=pl.configuration,i=pl.setters,l=0;l<a.length;l++){for(var s=a[l].imageIdIndex,c=n.labelmaps2D[s],u=new Set(c.pixelData).values(),d=[],f=!1;!f;){var h=u.next();(f=h.done)||d.push(h.value)}if(c.segmentsOnLabelmap=d,r.storeHistory){var v=this.paintEventData.previousPixeldataForImagesInRange[l],g=n.labelmaps2D[s].pixelData;o.push({imageIdIndex:s,diff:Le(v,g)})}}r.storeHistory&&i.pushState(this.element,o),Oe(this.element)}}]),n}(_a),xl=B("util:segmentation:operations:correction");function Tl(e,t){var n=t.pixelData,a=t.segmentIndex,o=t.segmentationMixinType;if("freehandSegmentationMixin"===o){var r=function(e,t){for(var n=t.pixelData,a=t.points,o=e.detail.image,r=o.width,i=o.height,l=[],s=0;s<a.length;s++){var c=a[s],u=Math.floor(c.x),d=Math.floor(c.y);u=In(u,0,r-1),d=In(d,0,i-1);var f=l[l.length-1];f&&u===f.x&&d===f.y||l.push({x:u,y:d,segment:n[d*r+u]})}return l}(e,t),i=function(e,t){for(var n=!0,a=!0,o=0;o<e.length;o++){if(e[o].segment===t?a=!1:n=!1,!n&&!a)break}if(a)return{isScissorOperation:!0,operation:"fillInsideFreehand"};if(n)return{isScissorOperation:!0,operation:"eraseInsideFreehand"};return{isScissorOperation:!1}}(r,a);if(i.isScissorOperation)"fillInsideFreehand"===i.operation?(xl.warn("The line never intersects a segment."),Al(e,t)):"eraseInsideFreehand"===i.operation&&(xl.warn("The line is only ever inside the segment."),Sl(e,t));else{var l=new Uint8Array(n.length);(function(e,t){var n=e[0].segment===t,a=[];a.push({additive:!n,nodes:[]});for(var o=0,r=0;r<e.length;r++){var i=e[r];n?(a[o].nodes.push(i),i.segment!==t&&(o++,n=!n,a.push({additive:!0,nodes:[]}),a[o].nodes.push(e[r-1]),a[o].nodes.push(i))):(a[o].nodes.push(i),i.segment===t&&(o++,n=!n,a.push({additive:!1,nodes:[]}),a[o].nodes.push(e[r-1]),a[o].nodes.push(i)))}return a.pop(),a.shift(),a})(r,a).forEach((function(t){!function(e,t,n,a,o){var r=o.detail.image,i=r.width,l=r.height,s=e.nodes,c=e.additive,u=c?0:1,d=function(e){return e.y*i+e.x},f=function(e){return{x:e%i,y:Math.floor(e/i)}};c?xl.warn("additive operation..."):xl.warn("subtractive operation...");for(var h=function(e){for(var t=[],n=0;n<e.length-1;n++)t.push(e[n]),t.push.apply(t,J()(Ee(e[n],e[n+1])));t.push[e[e.length-1]];for(var a=[],o=[],r=0;r<t.length-1;r++){var i=Ml(t[r],t[r+1]),l=i.left,s=i.right;a.push(l),o.push(s)}return{pixelPath:t,leftPath:a,rightPath:o}}(s),v=h.pixelPath,g=h.leftPath,m=h.rightPath,p=v[0],y={xMin:p.x,xMax:p.x,yMin:p.y,yMax:p.y},x=0;x<n.length;x++)if(t[x]===a){var T=f(x);bl(y,T),n[x]=1}else n[x]=0;for(var b=0;b<v.length;b++){var C=v[b];n[d(C)]=2,bl(y,C)}!function(e,t,n){e.xMax=Math.min(e.xMax+2,n),e.xMin=Math.max(e.xMin-2,0),e.yMax=Math.min(e.yMax+2,t),e.yMin=Math.max(e.yMin-2,0)}(y,l,i);var M=y.xMin,E=y.xMax,w=y.yMin,I=y.yMax;function S(e,t){if(!(e>=E||e<M||t>=I||t<w))return n[t*i+e]}for(var k=0,_=0,P=0;P<g.length;P++){var D=g[P];n[d(D)]===u&&Ge(D,l,i)&&(k+=Cl(D,3,n,S,i));var O=m[P];n[d(O)]===u&&Ge(O,l,i)&&(_+=Cl(O,4,n,S,i))}if(0===k||0===_)return;for(var L=c?a:0,R=k<_?3:4,A=0;A<n.length;A++)n[A]===R&&(t[A]=L);if(L===a)for(var H=0;H<v.length;H++)t[d(v[H])]=a;else for(var U=0;U<v.length;U++){var B=d(v[U]);t[B]===a&&(t[B]=0)}}(t,n,l,a,e)}))}}else xl.error("correction operation requires freehandSegmentationMixin operationData, recieved ".concat(o))}function bl(e,t){var n=t.x,a=t.y;n<e.xMin&&(e.xMin=n),n>e.xMax&&(e.xMax=n),a<e.yMin&&(e.yMin=a),a>e.yMax&&(e.yMax=a)}function Cl(e,t,n,a,o){for(var r=ve(a,[e.x,e.y]).flooded,i=0;i<r.length;i++){var l=r[i];n[l[1]*o+l[0]]=t}return r.length}function Ml(e,t){var n={x:t.x-e.x,y:t.y-e.y};return-1===n.x&&1===n.y?{left:{x:e.x-1,y:e.y-1},right:{x:e.x+1,y:e.y+1}}:0===n.x&&1===n.y?{left:{x:e.x-1,y:e.y},right:{x:e.x+1,y:e.y}}:1===n.x&&1===n.y?{left:{x:e.x-1,y:e.y+1},right:{x:e.x+1,y:e.y-1}}:1===n.x&&0===n.y?{left:{x:e.x,y:e.y+1},right:{x:e.x,y:e.y-1}}:1===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y+1},right:{x:e.x-1,y:e.y-1}}:0===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y},right:{x:e.x-1,y:e.y}}:-1===n.x&&-1===n.y?{left:{x:e.x+1,y:e.y-1},right:{x:e.x-1,y:e.y+1}}:-1===n.x&&0===n.y?{left:{x:e.x,y:e.y-1},right:{x:e.x,y:e.y+1}}:void xl.error("Unable to find left and right paths for flood fill ",e,t,n)}function El(e,t){for(var n=e[0],a=e[1],o=!1,r=0,i=t.length-1;r<t.length;i=r++){var l=t[r][0],s=t[r][1],c=t[i][0],u=t[i][1];s>a!=u>a&&n<(c-l)*(a-s)/(u-s)+l&&(o=!o)}return o}var wl=B("util:segmentation:operations:eraseInsideFreehand");function Il(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.points,o=t.segmentationMixinType;if("freehandSegmentationMixin"===o){var r=e.detail.image,i=a.map((function(e){return[e.x,e.y]})),l=Te(i,r),s=oe()(l,2),c=s[0],u=s[1];n?le(e,t,(function(e){return El([e.x,e.y],i)}),c,u):se(e,t,(function(e){return El([e.x,e.y],i)}),c,u)}else wl.error("eraseInsideFreehand operation requires freehandSegmentationMixin operationData, recieved ".concat(o))}function Sl(e,t){Il(e,t,!0)}function kl(e,t){Il(e,t,!1)}var _l=B("util:segmentation:operations:eraseInsideRectangle");function Pl(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.points,o=t.segmentationMixinType;if("rectangleSegmentationMixin"===o){var r=e.detail,i=r.image,l=a.map((function(e){return[e.x,e.y]})),s=Te(l,i),c=oe()(s,2),u=c[0],d=c[1];n?le(e,t,(function(){return!0}),u,d):ne(e,t,u,d)}else _l.error("eraseInsideRectangle operation requires rectangleSegmentationMixin operationData, recieved ".concat(o))}function Dl(e,t){Pl(e,t,!0)}function Ol(e,t){Pl(e,t,!1)}var Ll=B("util:segmentation:operations:fillInsideFreehand");function Rl(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.points,o=t.segmentationMixinType;if("freehandSegmentationMixin"===o){var r=e.detail.image,i=a.map((function(e){return[e.x,e.y]})),l=Te(i,r),s=oe()(l,2),c=s[0],u=s[1];n?fe(e,t,(function(e){return El([e.x,e.y],i)}),c,u):he(e,t,(function(e){return El([e.x,e.y],i)}),c,u)}else Ll.error("eraseInsideFreehand operation requires freehandSegmentationMixin operationData, recieved ".concat(o))}function Al(e,t){Rl(e,t,!0)}function Hl(e,t){Rl(e,t,!1)}var Ul=B("util:segmentation:operations:fillInsideRectangle");function Bl(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.points,o=t.segmentationMixinType;if("rectangleSegmentationMixin"===o){var r=e.detail.image,i=a.map((function(e){return[e.x,e.y]})),l=Te(i,r),s=oe()(l,2),c=s[0],u=s[1];n?fe(e,t,(function(){return!0}),c,u):ce(e,t,c,u)}else Ul.error("eraseInsideRectangle operation requires rectangleSegmentationMixin operationData, recieved ".concat(o))}function Nl(e,t){Bl(e,t,!0)}function Fl(e,t){Bl(e,t,!1)}var Vl=B("util:segmentation:operations:fillCircle");function ql(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.segmentationMixinType;if("circleSegmentationMixin"===a){var o=e.detail,r=xe(e),i=oe()(r,2),l=i[0],s=i[1],c=ye(o.handles.start,o.handles.end);n?fe(e,t,(function(e){return oi(c,e)}),l,s):he(e,t,(function(e){return oi(c,e)}),l,s)}else Vl.error("fillInsideCircle operation requires circleSegmentationMixin operationData, recieved ".concat(a))}function jl(e,t){ql(e,t,!0)}function zl(e,t){ql(e,t,!1)}var Wl=B("util:segmentation:operations:eraseInsideCircle");function Gl(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=t.segmentationMixinType;if("circleSegmentationMixin"===a){var o=e.detail,r=xe(e),i=oe()(r,2),l=i[0],s=i[1],c=ye(o.handles.start,o.handles.end);n?le(e,t,(function(e){return oi(c,e)}),l,s):se(e,t,(function(e){return oi(c,e)}),l,s)}else Wl.error("eraseInsideCircle operation requires circleSegmentationMixin operationData, recieved ".concat(a))}function Yl(e,t){Gl(e,t,!0)}function Xl(e,t){Gl(e,t,!1)}function Kl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Zl=function(e){u()(n,e);var t=Kl(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"FreehandScissors",strategies:{FILL_INSIDE:Al,FILL_OUTSIDE:Hl,ERASE_OUTSIDE:kl,ERASE_INSIDE:Sl},cursors:{FILL_INSIDE:Zo,FILL_OUTSIDE:Jo,ERASE_OUTSIDE:$o,ERASE_INSIDE:Ko},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Zo,mixins:["freehandSegmentationMixin"]};return t.call(this,e,a)}return n}(va);function $l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Jl=function(e){u()(n,e);var t=$l(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"RectangleScissors",strategies:{FILL_INSIDE:Nl,FILL_OUTSIDE:Fl,ERASE_OUTSIDE:Ol,ERASE_INSIDE:Dl},cursors:{FILL_INSIDE:er,FILL_OUTSIDE:nr,ERASE_OUTSIDE:tr,ERASE_INSIDE:Qo},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],mixins:["rectangleSegmentationMixin"]};return t.call(this,e,a)}return n}(va);function Ql(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var es=function(e){u()(n,e);var t=Ql(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"CircleScissors",strategies:{FILL_INSIDE:jl,FILL_OUTSIDE:zl,ERASE_OUTSIDE:Xl,ERASE_INSIDE:Yl},cursors:{FILL_INSIDE:or,FILL_OUTSIDE:ir,ERASE_OUTSIDE:rr,ERASE_INSIDE:ar},defaultStrategy:"FILL_INSIDE",supportedInteractionTypes:["Mouse","Touch"],svgCursor:or,mixins:["circleSegmentationMixin"]};return t.call(this,e,a)}return n}(va);function ts(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ns=function(e){u()(n,e);var t=ts(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"CorrectionScissors",strategies:{CORRECTION:Tl},cursors:{CORRECTION:Zo},defaultStrategy:"CORRECTION",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Zo,mixins:["polylineSegmentationMixin"]};return t.call(this,e,a)}return n}(va),as={},os={},rs={};function is(e){if(!e)return"DEFAULT";var t=y.cornerstone.getEnabledElement(e).uuid;if(!t)throw new Error("Something went wrong when getting uuid from element");return t}var ls={setStartLoadHandler:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(!e)throw new Error("The Handler function must be defined");var n=is(t);as[n]=e},getStartLoadHandler:function(e){var t=is(e);return as[t]||as.DEFAULT},setEndLoadHandler:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(!e)throw new Error("The Handler function must be defined");var n=is(t);os[n]=e},getEndLoadHandler:function(e){var t=is(e);return os[t]||os.DEFAULT},setErrorLoadingHandler:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(!e)throw new Error("The Handler function must be defined");var n=is(t);rs[n]=e},getErrorLoadingHandler:function(e){var t=is(e);return rs[t]||rs.DEFAULT},removeHandlers:function(e){var t=is(e);delete as[t],delete os[t],delete rs[t]}},ss={};function cs(e,t){if(!ss[e])return{};var n=ss[e].find((function(e){return e.element===t}));return n?n.options:{}}function us(e,t,n){if(ss[e]){var a=ss[e].findIndex((function(e){return e.element===t}));if(-1===a)ss[e].push({element:t,options:n});else{var o=ss[e][a].options||{};ss[e][a].options=Object.assign(o,n)}}else ss[e]=[{element:t,options:n}]}function ds(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var fs=function(e){u()(n,e);var t=ds(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Crosshairs",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Ro};return(e=t.call(this,a,o)).preMouseDownCallback=e._chooseLocation.bind(wa()(e)),e.mouseDragCallback=e._chooseLocation.bind(wa()(e)),e.touchDragCallback=e._chooseLocation.bind(wa()(e)),e}return s()(n,[{key:"_chooseLocation",value:function(e){var t=e.detail,n=t.element;e.stopImmediatePropagation();var a=O(n,this.name);if(a){var o=n,r=y.cornerstone.getEnabledElement(o).image.imageId,i=y.cornerstone.metaData.get("imagePlaneModule",r);if(i){var l=nn(t.currentPoints.image,i);a.data[0].synchronizationContext.getSourceElements().forEach((function(e){if(e!==o){var t=Number.MAX_VALUE,n=-1,a=O(e,"stack");if(void 0!==a){var r=a.data[0];if(r.imageIds.forEach((function(e,a){var o=y.cornerstone.metaData.get("imagePlaneModule",e);if(o&&o.imagePositionPatient&&o.rowCosines&&o.columnCosines){var r=en(o.imagePositionPatient),i=en(o.rowCosines),s=en(o.columnCosines).clone().cross(i.clone()),c=Math.abs(s.clone().dot(r)-s.clone().dot(l));c<t&&(t=c,n=a)}})),n!==r.currentImageIdIndex&&-1!==n&&void 0!==r.imageIds[n]){var i=ls.getStartLoadHandler(e),s=ls.getEndLoadHandler(e),c=ls.getErrorLoadingHandler(e);i&&i(e),(!0===r.preventCache?y.cornerstone.loadImage(r.imageIds[n]):y.cornerstone.loadAndCacheImage(r.imageIds[n])).then((function(t){var a=y.cornerstone.getViewport(e);r.currentImageIdIndex=n,y.cornerstone.displayImage(e,t,a),s&&s(e,t)}),(function(t){var a=r.imageIds[n];c&&c(e,a,t)}))}}}}))}}}},{key:"activeCallback",value:function(e,t){var n=t.mouseButtonMask,a=t.synchronizationContext;us(this.name,e,{mouseButtonMask:n}),R(e,this.name),D(e,this.name,{synchronizationContext:a})}}]),n}(va);function hs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var vs=function(e){u()(n,e);var t=hs(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"DoubleTapFitToWindow",supportedInteractionTypes:["DoubleTap"]};return t.call(this,e,a)}return s()(n,[{key:"doubleTapCallback",value:function(e){var t=e.detail;y.cornerstone.fitToWindow(t.element)}}]),n}(va);function gs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ms=function(e){u()(n,e);var t=gs(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"DragProbe",strategies:{default:ps,minimal:ys},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Do};return(e=t.call(this,a,o)).touchDragCallback=e._movingEventCallback.bind(wa()(e)),e.touchEndCallback=e._endMovingEventCallback.bind(wa()(e)),e.mouseDragCallback=e._movingEventCallback.bind(wa()(e)),e.mouseUpCallback=e._endMovingEventCallback.bind(wa()(e)),e.dragEventData={},e}return s()(n,[{key:"_movingEventCallback",value:function(e){var t=e.detail,n=t.element;this.dragEventData=t,y.cornerstone.updateImage(n)}},{key:"_endMovingEventCallback",value:function(e){var t=e.detail.element;this.dragEventData={},y.cornerstone.updateImage(t)}},{key:"renderToolData",value:function(e){this.dragEventData.currentPoints&&e&&e.detail&&Boolean(Object.keys(this.dragEventData.currentPoints).length)&&(e.detail.currentPoints=this.dragEventData.currentPoints,this.applyActiveStrategy(e))}}]),n}(va);function ps(e){var t=this.configuration,n=y.cornerstone,a=e.detail,o=a.element,r=a.image,i=a.currentPoints,l=a.canvasContext,s=_n(l.canvas),c=un.getActiveColor(),u=pn.getFontSize(),d=Math.round(i.image.x),f=Math.round(i.image.y);d<0||f<0||d>=r.columns||f>=r.rows||Wt(s,(function(e){Dn(e,t);var a,l,s="".concat(d,", ").concat(f);if(r.color)a=Ji(o,d,f,1,1),l="R: ".concat(a[0]," G: ").concat(a[1]," B: ").concat(a[2]," A: ").concat(a[3]);else{var h=(a=n.getStoredPixels(o,d,f,1,1))[0],v=h*r.slope+r.intercept,g=ni(r,h);l="SP: ".concat(h," MO: ").concat(parseFloat(v.toFixed(3))),g&&(l+=" SUV: ".concat(parseFloat(g.toFixed(3))))}var m={x:i.canvas.x+5,y:i.canvas.y-5};bn(e,l,m.x,m.y+u+5,c),bn(e,s,m.x,m.y,c)}))}function ys(e){var t=this.configuration,n=y.cornerstone,a=e.detail,o=a.element,r=a.image,i=a.currentPoints,l=a.canvasContext,s=a.isTouchEvent,c=_n(l.canvas),u=un.getActiveColor(),d=i.page.y-pn.getFontSize()/2;s&&(d=i.page.y-4*pn.getFontSize());var f=n.pageToPixel(o,i.page.x,d);f.x<0||f.y<0||f.x>=r.columns||f.y>=r.rows||Wt(c,(function(e){Dn(e,t);var a,i=n.metaData.get("generalSeriesModule",r.imageId),l=i&&i.modality,c="";if(r.color)a=Ji(o,f.x,f.y,1,1),c="R: ".concat(a[0]," G: ").concat(a[1]," B: ").concat(a[2]);else{var d=(a=n.getStoredPixels(o,f.x,f.y,1,1))[0],h=d*r.slope+r.intercept,v=parseFloat(h.toFixed(2));if("CT"===l)c+="HU: ".concat(v);else if("PT"===l){c+=v;var g=ni(r,d);g&&(c+=" SUV: ".concat(parseFloat(g.toFixed(2))))}else c+=v}var m=n.pixelToCanvas(o,f),p={x:12,y:-(pn.getFontSize()+10)/2},y=Tn(e,c,5);s&&(p={x:-y/2,y:-pn.getFontSize()-10-12}),Qt(e,o,m,6,{color:u},"canvas"),bn(e,c,m.x+p.x,m.y+p.y,u)}))}function xs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Ts=function(e){u()(n,e);var t=xs(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Eraser",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Ao};return(e=t.call(this,a,o)).preMouseDownCallback=e._deleteAllNearbyTools.bind(wa()(e)),e.preTouchStartCallback=e._deleteAllNearbyTools.bind(wa()(e)),e}return s()(n,[{key:"_deleteAllNearbyTools",value:function(e){var t=e.detail.currentPoints.canvas,n=e.detail.element;pt.tools.forEach((function(e){var a=O(n,e.name);a&&a.data.forEach((function(a){"function"==typeof e.pointNearTool&&e.pointNearTool(n,a,t)&&(L(n,e.name,a),y.cornerstone.updateImage(n))}))}));return!0}}]),n}(va);function bs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Cs=Ni.FreehandHandleData,Ms=function(e){u()(n,e);var t=bs(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"FreehandRoiSculptor",referencedToolName:"FreehandRoi",supportedInteractionTypes:["Mouse","Touch","DoubleTap"],mixins:["activeOrDisabledBinaryTool"],configuration:Es(),svgCursor:_o};return(e=t.call(this,a,o)).updateOnMouseMove=!0,e.isMultiPartTool=!0,e.referencedToolName=e.initialConfiguration.referencedToolName,e._active=!1,e.activeMouseUpCallback=e.activeMouseUpCallback.bind(wa()(e)),e.activeTouchEndCallback=e.activeTouchEndCallback.bind(wa()(e)),e.activeMouseDragCallback=e.activeMouseDragCallback.bind(wa()(e)),e}return s()(n,[{key:"renderToolData",value:function(e){var t=e.detail;if(null===this.configuration.currentTool)return!1;var n=t.element,a=this.configuration;if(!O(n,this.referencedToolName).data[a.currentTool])return!1;if(this._active){var o=t.canvasContext.canvas.getContext("2d"),r={color:this.configuration.dragColor,fill:null,handleRadius:this._toolSizeCanvas};dn(o,t,this.configuration.mouseLocation.handles,r)}else this.configuration.showCursorOnHover&&!this._recentTouchEnd&&this._renderHoverCursor(e)}},{key:"doubleClickCallback",value:function(e){var t=e.detail;this._selectFreehandTool(t),y.cornerstone.updateImage(t.element)}},{key:"doubleTapCallback",value:function(e){var t=e.detail;this._selectFreehandTool(t),y.cornerstone.updateImage(t.element)}},{key:"preTouchStartCallback",value:function(e){return this._initialiseSculpting(e),!0}},{key:"preMouseDownCallback",value:function(e){if(this.options.mouseButtonMask.includes(e.detail.buttons))return this._initialiseSculpting(e),!0}},{key:"activeMouseDragCallback",value:function(e){var t=this.configuration;if(this._active){var n=e.detail,a=O(n.element,this.referencedToolName);if(a){var o=a.data[t.currentTool].handles.points;this._getMouseLocation(n),this._sculpt(n,o),y.cornerstone.updateImage(n.element)}}}},{key:"activeMouseUpCallback",value:function(e){this._activeEnd(e)}},{key:"activeTouchEndCallback",value:function(e){this._activeEnd(e),this._deselectAllTools(e),this._recentTouchEnd=!0}},{key:"_activeEnd",value:function(e){var t=e.detail,n=t.element,a=this.configuration;this._active=!1,pt.isMultiPartToolActive=!1,this._getMouseLocation(t),this._invalidateToolData(t),a.mouseUpRender=!0,this._deactivateSculpt(n),y.cornerstone.updateImage(t.element),function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault()}(e)}},{key:"_renderHoverCursor",value:function(e){var t,n=e.detail,a=n.element,o=n.canvasContext.canvas.getContext("2d"),r=O(a,this.referencedToolName).data[this.configuration.currentTool];this._recentTouchEnd=!1,this.configuration.mouseUpRender?(t=this.configuration.mouseLocation.handles.start,this.configuration.mouseUpRender=!1):t=pt.mousePositionImage;var i=Ct(a,this.referencedToolName).distanceFromPointCanvas(a,r,t);if(this.configuration.mouseLocation.handles.start.x=t.x,this.configuration.mouseLocation.handles.start.y=t.y,this.configuration.limitRadiusOutsideRegion){var l=i;i=this._limitCursorRadiusCanvas(n,i),l>this.configuration.hoverCursorFadeDistance*i&&(o.globalAlpha=this.configuration.hoverCursorFadeAlpha)}var s={fill:null,color:this.configuration.hoverColor,handleRadius:i};dn(o,n,this.configuration.mouseLocation.handles,s),this.configuration.limitRadiusOutsideRegion&&(o.globalAlpha=1)}},{key:"newImageCallback",value:function(e){this._deselectAllTools(e)}},{key:"enabledCallback",value:function(e){this._deselectAllTools(e)}},{key:"passiveCallback",value:function(e){this._deselectAllTools(e)}},{key:"disabledCallback",value:function(e){this._deselectAllTools(e)}},{key:"_selectFreehandTool",value:function(e){var t=this.configuration,n=e.element,a=this._getClosestFreehandToolOnElement(n,e);void 0!==a&&(t.currentTool=a,wt(n))}},{key:"_activateFreehandTool",value:function(e,t){var n=O(e,this.referencedToolName).data;this.configuration.currentTool=t;for(var a=0;a<n.length;a++)n[a].active=a===t}},{key:"_initialiseSculpting",value:function(e){var t=e.detail,n=this.configuration,a=t.element;null===n.currentTool&&(this._selectFreehandTool(t),null===n.currentTool)||(this._active=!0,pt.isMultiPartToolActive=!0,this._configureToolSize(t),this._getMouseLocation(t),this._activateFreehandTool(a,n.currentTool),this._activateSculpt(a),y.cornerstone.updateImage(t.element))}},{key:"_sculpt",value:function(e,t){var n=this.configuration;this._sculptData={element:e.element,image:e.image,mousePoint:e.currentPoints.image,points:t,toolSize:this._toolSizeImage,minSpacing:n.minSpacing,maxSpacing:Math.max(this._toolSizeImage,2*n.minSpacing)};var a=this._pushHandles();void 0!==a.first&&(this._insertNewHandles(a),this._consolidateHandles())}},{key:"_pushHandles",value:function(){for(var e=this._sculptData,t=e.points,n=e.mousePoint,a=e.toolSize,o={},r=0;r<t.length;r++){var i=y.cornerstoneMath.point.distance(t[r],n);i>a||(this._pushOneHandle(r,i),void 0===o.first?(o.first=r,o.last=r):o.last=r)}return o}},{key:"_pushOneHandle",value:function(e,t){var n=this._sculptData,a=n.points,o=n.mousePoint,r=n.toolSize,i=n.image,l=a[e],s=(l.x-o.x)/t,c=(l.y-o.y)/t,u={x:o.x+r*s,y:o.y+r*c};Mn(u,i),l.x=u.x,l.y=u.y;var d=this.constructor._getPreviousHandleIndex(e,a.length);a[d].lines.pop(),a[d].lines.push(l)}},{key:"_insertNewHandles",value:function(e){for(var t=this._findNewHandleIndicies(e),n=0,a=0;a<t.length;a++){var o=t[a]+1+n;this._insertHandleRadially(o),n++}}},{key:"_findNewHandleIndicies",value:function(e){for(var t=this._sculptData,n=t.points,a=t.maxSpacing,o=[],r=e.first;r<=e.last;r++)this._checkSpacing(r,n,o,a);var i=this.constructor._getNextHandleIndex(e.last,n.length);if(i!==e.first){this._checkSpacing(i,n,o,a);var l=this.constructor._getPreviousHandleIndex(e.first,n.length);l!==i&&this._checkSpacing(l,n,o,a)}return o}},{key:"_checkSpacing",value:function(e,t,n,a){var o=this.constructor._getNextHandleIndex(e,t.length);y.cornerstoneMath.point.distance(t[e],t[o])>a&&n.push(e)}},{key:"_insertHandleRadially",value:function(e){var t=this._sculptData.points,n=e-1,a=this.constructor._getNextHandleIndexBeforeInsert(e,t.length),o=this._getInsertPosition(e,n,a),r=new Cs(o);t.splice(e,0,r),t[n].lines.pop(),t[n].lines.push(t[e]),Ni.addLine(t,e)}},{key:"_consolidateHandles",value:function(){if(!(this._sculptData.points.length<=3)){var e=this._findCloseHandlePairs();this._mergeCloseHandles(e)}}},{key:"_findCloseHandlePairs",value:function(){for(var e=this._sculptData,t=e.points,n=e.minSpacing,a=[],o=t.length,r=0;r<o;r++){var i=this.constructor._getNextHandleIndex(r,t.length);if(y.cornerstoneMath.point.distance(t[r],t[i])<n){var l=[r,i];a.push(l),0===r&&(o-=1),r++}}return a}},{key:"_mergeCloseHandles",value:function(e){for(var t=0,n=0;n<e.length;n++){var a=this.constructor._getCorrectedPair(e[n],t);this._combineHandles(a),t++}var o=this._findCloseHandlePairs();o.length&&this._mergeCloseHandles(o)}},{key:"_combineHandles",value:function(e){var t=this._sculptData,n=t.points,a=t.image,o={x:(n[e[0]].x+n[e[1]].x)/2,y:(n[e[0]].y+n[e[1]].y)/2};Mn(o,a),n[e[0]].x=o.x,n[e[0]].y=o.y;var r=this.constructor._getNextHandleIndex(e[1],n.length);n[e[0]].lines.pop(),n[e[0]].lines.push(n[r]),n.splice(e[1],1)}},{key:"_configureToolSize",value:function(e){var t=e.element,n=this.configuration,a=n.currentTool,o=e.currentPoints.image,r=O(t,this.referencedToolName).data[a],i=Ct(t,this.referencedToolName),l=i.distanceFromPoint(t,r,o),s=i.distanceFromPointCanvas(t,r,o);n.limitRadiusOutsideRegion&&(l=this._limitCursorRadiusImage(e,l),s=this._limitCursorRadiusCanvas(e,s)),this._toolSizeImage=l,this._toolSizeCanvas=s}},{key:"_getMouseLocation",value:function(e){var t=this.configuration;t.mouseLocation.handles.start.x=e.currentPoints.image.x,t.mouseLocation.handles.start.y=e.currentPoints.image.y,Mn(t.mouseLocation.handles.start,e.image)}},{key:"_activateSculpt",value:function(e){this._deactivateSculpt(e),e.addEventListener(b.MOUSE_UP,this.activeMouseUpCallback),e.addEventListener(b.MOUSE_CLICK,this.activeMouseUpCallback),e.addEventListener(b.MOUSE_DRAG,this.activeMouseDragCallback),e.addEventListener(b.TOUCH_END,this.activeTouchEndCallback),e.addEventListener(b.TOUCH_TAP,this.activeTouchEndCallback),e.addEventListener(b.TOUCH_DRAG,this.activeMouseDragCallback),y.cornerstone.updateImage(e)}},{key:"_deactivateSculpt",value:function(e){e.removeEventListener(b.MOUSE_UP,this.activeMouseUpCallback),e.removeEventListener(b.MOUSE_CLICK,this.activeMouseUpCallback),e.removeEventListener(b.MOUSE_DRAG,this.activeMouseDragCallback),e.removeEventListener(b.TOUCH_END,this.activeTouchEndCallback),e.removeEventListener(b.TOUCH_TAP,this.activeTouchEndCallback),e.removeEventListener(b.TOUCH_DRAG,this.activeMouseDragCallback),y.cornerstone.updateImage(e)}},{key:"_invalidateToolData",value:function(e){var t=this.configuration;O(e.element,this.referencedToolName).data[t.currentTool].invalidated=!0}},{key:"_deselectAllTools",value:function(e){var t=this.configuration,n=O(this.element,this.referencedToolName);if(t.currentTool=null,n)for(var a=0;a<n.data.length;a++)n.data[a].active=!1;Et(this.element,this.svgCursor),y.cornerstone.updateImage(this.element)}},{key:"_limitCursorRadiusCanvas",value:function(e,t){return this._limitCursorRadius(e,t,!0)}},{key:"_limitCursorRadiusImage",value:function(e,t){return this._limitCursorRadius(e,t,!1)}},{key:"_limitCursorRadius",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=e.element,o=e.image,r=this.configuration,i=O(a,this.referencedToolName),l=i.data[r.currentTool],s=1;if(n){var c=y.cornerstone.pixelToCanvas(a,{x:0,y:0}),u=y.cornerstone.pixelToCanvas(a,{x:o.width,y:o.height}),d=(u.x-c.x)*(u.y-c.y);s=d/(o.width*o.height)}var f=l.area*s,h=Math.pow(f/Math.PI,.5);return Math.min(t,h)}},{key:"_getClosestFreehandToolOnElement",value:function(e,t){var n=Ct(e,this.referencedToolName),a=O(e,this.referencedToolName);if(a){for(var o=a.data,r=t.currentPoints.image,i={distance:1/0,toolIndex:null},l=0;l<o.length;l++){var s=n.distanceFromPoint(e,o[l],r);-1!==s&&(s<i.distance&&(i.distance=s,i.toolIndex=l))}return i.toolIndex}}},{key:"_getInsertPosition",value:function(e,t,n){var a,o=this._sculptData,r=o.points,i=o.toolSize,l=o.mousePoint,s=o.image,c={x:(r[t].x+r[n].x)/2,y:(r[t].y+r[n].y)/2},u=y.cornerstoneMath.point.distance(l,c);if(u<i){var d={x:(c.x-l.x)/u,y:(c.y-l.y)/u};a={x:l.x+i*d.x,y:l.y+i*d.y}}else a=c;return Mn(a,s),a}},{key:"minSpacing",get:function(){return this.configuration.minSpacing},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter minSpacing to a value other than a number.");this.configuration.minSpacing=e}},{key:"maxSpacing",get:function(){return this.configuration.maxSpacing},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter maxSpacing to a value other than a number.");this.configuration.maxSpacing=e}},{key:"showCursorOnHover",get:function(){return this.configuration.showCursorOnHover},set:function(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehandSculpter showCursorOnHover to a value other than a boolean.");this.configuration.showCursorOnHover=e,y.cornerstone.updateImage(this.element)}},{key:"limitRadiusOutsideRegion",get:function(){return this.configuration.limitRadiusOutsideRegion},set:function(e){if("boolean"!=typeof e)throw new Error("Attempting to set freehandSculpter limitRadiusOutsideRegion to a value other than a boolean.");this.configuration.limitRadiusOutsideRegion=e,y.cornerstone.updateImage(this.element)}},{key:"hoverCursorFadeAlpha",get:function(){return this.configuration.hoverCursorFadeAlpha},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter hoverCursorFadeAlpha to a value other than a number.");e=Math.max(Math.min(e,1),0),this.configuration.hoverCursorFadeAlpha=e,y.cornerstone.updateImage(this.element)}},{key:"hoverCursorFadeDistance",get:function(){return this.configuration.hoverCursorFadeDistance},set:function(e){if("number"!=typeof e)throw new Error("Attempting to set freehandSculpter hoverCursorFadeDistance to a value other than a number.");e=Math.max(e,1),this.configuration.hoverCursorFadeDistance=e,y.cornerstone.updateImage(this.element)}}],[{key:"_getCorrectedPair",value:function(e,t){var n=[e[0]-t,e[1]-t];return n[1]<0&&(n[1]=0),n}},{key:"_getNextHandleIndex",value:function(e,t){return e===t-1?0:e+1}},{key:"_getPreviousHandleIndex",value:function(e,t){return 0===e?t-1:e-1}},{key:"_getNextHandleIndexBeforeInsert",value:function(e,t){return e===t?0:e}}]),n}(va);function Es(){return{mouseLocation:{handles:{start:{highlight:!0,active:!0}}},minSpacing:1,currentTool:null,dragColor:un.getActiveColor(),hoverColor:un.getToolColor(),showCursorOnHover:!0,limitRadiusOutsideRegion:!0,hoverCursorFadeAlpha:.5,hoverCursorFadeDistance:1.2}}function ws(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Is=function(e){u()(n,e);var t=ws(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Magnify",supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:300,magnificationLevel:2},svgCursor:Ho};return(e=t.call(this,a,o)).zoomCanvas=void 0,e.zoomElement=void 0,e.activeCallback=e._createMagnificationCanvas.bind(wa()(e)),e.enabledCallback=e._createMagnificationCanvas.bind(wa()(e)),e.disabledCallback=e._destroyMagnificationCanvas.bind(wa()(e)),e.postTouchStartCallback=e._addMagnifyingGlass.bind(wa()(e)),e.touchDragCallback=e._updateMagnifyingGlass.bind(wa()(e)),e.touchEndCallback=e._removeMagnifyingGlass.bind(wa()(e)),e.touchDragEndCallback=e._removeMagnifyingGlass.bind(wa()(e)),e.postMouseDownCallback=e._addMagnifyingGlass.bind(wa()(e)),e.mouseDragCallback=e._updateMagnifyingGlass.bind(wa()(e)),e.mouseUpCallback=e._removeMagnifyingGlass.bind(wa()(e)),e.mouseClickCallback=e._removeMagnifyingGlass.bind(wa()(e)),e.newImageCallback=e._drawMagnificationTool.bind(wa()(e)),e}return s()(n,[{key:"_addMagnifyingGlass",value:function(e){var t=this;this._removeZoomElement(),this._drawZoomedElement(e),window.requestAnimationFrame((function(){return t._drawMagnificationTool(e)})),wt(e.detail.element),e.preventDefault(),e.stopPropagation()}},{key:"_updateMagnifyingGlass",value:function(e){this._drawMagnificationTool(e),e.preventDefault(),e.stopPropagation()}},{key:"_removeMagnifyingGlass",value:function(e){var t=e.detail.element;Et(this.element,this.svgCursor),t.querySelector(".magnifyTool").style.display="none",this._removeZoomElement()}},{key:"_drawMagnificationTool",value:function(e){var t=e.detail.element,n=t.querySelector(".magnifyTool");if(n||this._createMagnificationCanvas(t),void 0!==this.zoomCanvas){var a=t.querySelector("canvas:not(.magnifyTool)"),o=_n(n),r=y.cornerstone.pixelToCanvas(e.detail.element,e.detail.currentPoints.image),i=Math.min(this.configuration.magnifySize,a.width,a.height),l=this.configuration.magnificationLevel;n.width=i,n.height=i,r.x=Math.max(r.x,.5*i/l),r.x=Math.min(r.x,a.width-.5*i/l),r.y=Math.max(r.y,.5*i/l),r.y=Math.min(r.y,a.height-.5*i/l);var s={x:r.x*l-.5*i,y:r.y*l-.5*i};s.x=Math.max(s.x,0),s.y=Math.max(s.y,0),o.drawImage(this.zoomCanvas,s.x,s.y,i,i,0,0,i,i);var c=e.detail.isTouchEvent?120:0,u={top:Math.max(r.y-.5*i-c,0),left:Math.max(r.x-.5*i,0)},d=n.getBoundingClientRect();u.top=Math.min(u.top,a.height-d.height),u.left=Math.min(u.left,a.width-d.width),n.style.top="".concat(u.top,"px"),n.style.left="".concat(u.left,"px"),n.style.display="block"}}},{key:"_drawZoomedElement",value:function(e){var t=e.detail.element,n=e.detail.enabledElement;void 0===n&&(n=y.cornerstone.getEnabledElement(t));var a=this.configuration.magnificationLevel,o=n.canvas,r=n.image;this.zoomElement||(this.zoomElement=document.createElement("div"),this.zoomElement.width=o.width*a,this.zoomElement.height=o.height*a,y.cornerstone.enable(this.zoomElement,n.options));var i=y.cornerstone.getEnabledElement(this.zoomElement),l=y.cornerstone.getViewport(n.element);this.zoomCanvas=i.canvas,this.zoomCanvas.width=o.width*a,this.zoomCanvas.height=o.height*a,i.viewport=Object.assign({},l),l.scale*=a,y.cornerstone.displayImage(this.zoomElement,r),y.cornerstone.setViewport(this.zoomElement,l)}},{key:"_removeZoomElement",value:function(){void 0!==this.zoomElement&&(y.cornerstone.disable(this.zoomElement),this.zoomElement=void 0,this.zoomCanvas=void 0)}},{key:"_createMagnificationCanvas",value:function(e){if(null===e.querySelector(".magnifyTool")){var t=document.createElement("canvas");t.classList.add("magnifyTool"),t.width=this.configuration.magnifySize,t.height=this.configuration.magnifySize,t.style.position="absolute",t.style.display="none",e.appendChild(t)}}},{key:"_destroyMagnificationCanvas",value:function(e){var t=e.querySelector(".magnifyTool");t&&e.removeChild(t)}}]),n}(va);function Ss(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ks=xt.globalConfiguration,_s=function(e){u()(n,e);var t=Ss(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Overlay",configuration:{},mixins:["enabledOrDisabledBinaryTool"]},r=Object.assign(o,a);return(e=t.call(this,r)).initialConfiguration=r,e}return s()(n,[{key:"enabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"disabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"forceImageUpdate",value:function(e){y.cornerstone.getEnabledElement(e).image&&y.cornerstone.updateImage(e)}},{key:"setupRender",value:function(e){if(e){var t=y.cornerstone.metaData.get("overlayPlaneModule",e.imageId);if(t&&t.overlays&&t.overlays.length)return t}}},{key:"setupViewport",value:function(e){if(void 0===e.overlayColor&&(e.overlayColor=ks.configuration.overlayColor||"white"),!1!==e.overlayColor)return!0}},{key:"renderToolData",value:function(e){var t=e.detail,n=t.enabledElement,a=t.image,o=t.viewport,r=t.canvasContext,i=this.setupRender(a);if(t&&n&&i&&this.setupViewport(o)){var l=a.columns,s=a.rows;i.overlays.forEach((function(e){if(!1!==e.visible){var t=document.createElement("canvas");t.width=l,t.height=s;var n=t.getContext("2d");n.fillStyle=e.fillStyle||o.overlayColor,"R"===e.type&&(n.fillRect(0,0,t.width,t.height),n.globalCompositeOperation="xor");for(var a=0,i=0;i<e.rows;i++)for(var c=0;c<e.columns;c++)e.pixelData[a++]>0&&n.fillRect(c,i,1,1);var u=!isNaN(parseFloat(e.x))&&isFinite(e.x)?e.x:0,d=!isNaN(parseFloat(e.y))&&isFinite(e.y)?e.y:0;r.drawImage(t,u,d)}}))}}}]),n}(va),Ps={getOrientationString:function(e){for(var t=en(e),n="",a=t.x<0?"R":"L",o=t.y<0?"A":"P",r=t.z<0?"F":"H",i=new y.cornerstoneMath.Vector3(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),l=1e-4,s=0;s<3;s++)if(i.x>l&&i.x>i.y&&i.x>i.z)n+=a,i.x=0;else if(i.y>l&&i.y>i.x&&i.y>i.z)n+=o,i.y=0;else if(i.z>l&&i.z>i.x&&i.z>i.y)n+=r,i.z=0;else if(i.x>l&&i.y>l&&i.x===i.y)n+=a+o,i.x=0,i.y=0;else if(i.x>l&&i.z>l&&i.x===i.z)n+=a+r,i.x=0,i.z=0;else{if(!(i.y>l&&i.z>l&&i.y===i.z))break;n+=o+r,i.y=0,i.z=0}return n},invertOrientationString:function(e){var t=e.replace("H","f");return t=(t=(t=(t=(t=(t=t.replace("F","h")).replace("R","l")).replace("L","r")).replace("A","p")).replace("P","a")).toUpperCase()}};function Ds(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Os=function(e){u()(n,e);var t=Ds(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"OrientationMarkers",configuration:{drawAllMarkers:!0},mixins:["enabledOrDisabledBinaryTool"]};return t.call(this,e,a)}return s()(n,[{key:"enabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"disabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"forceImageUpdate",value:function(e){var t=y.cornerstone;t.getEnabledElement(e).image&&t.updateImage(e)}},{key:"renderToolData",value:function(e){var t=e.detail,n=_n(t.canvasContext.canvas),a=t.element,o=As(a);if(o){var r=Hs(a,o),i=un.getToolColor(),l={top:Tn(n,o.top,0),left:Tn(n,o.left,0),right:Tn(n,o.right,0),bottom:Tn(n,o.bottom,0),height:Tn(n,"M",0)};Ls(n,o,r,l,i),this.configuration.drawAllMarkers&&Rs(n,o,r,l,i)}}}]),n}(va),Ls=function(e,t,n,a,o){bn(e,t.top,n.top.x-a.top/2,n.top.y,o),bn(e,t.left,n.left.x-a.left/2,n.left.y,o)},Rs=function(e,t,n,a,o){bn(e,t.right,n.right.x-a.right,n.right.y,o),bn(e,t.bottom,n.bottom.x-a.bottom/2,n.bottom.y-a.height,o)},As=function(e){var t=y.cornerstone,n=t.getEnabledElement(e),a=t.metaData.get("imagePlaneModule",n.image.imageId);if(a&&a.rowCosines&&a.columnCosines){var o=Ps.getOrientationString(a.rowCosines),r=Ps.getOrientationString(a.columnCosines),i=Ps.invertOrientationString(o);return{top:Ps.invertOrientationString(r),bottom:r,left:i,right:o}}},Hs=function(e){var t=y.cornerstone.getEnabledElement(e);return{top:y.cornerstone.pixelToCanvas(e,{x:t.image.width/2,y:5}),bottom:y.cornerstone.pixelToCanvas(e,{x:t.image.width/2,y:t.image.height-15}),left:y.cornerstone.pixelToCanvas(e,{x:5,y:t.image.height/2}),right:y.cornerstone.pixelToCanvas(e,{x:t.image.width-10,y:t.image.height/2})}};function Us(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Bs=function(e){u()(n,e);var t=Us(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"PanMultiTouch",supportedInteractionTypes:["MultiTouch"],configuration:{touchPointers:2}};return(e=t.call(this,a,o)).multiTouchDragCallback=e._dragCallback.bind(wa()(e)),e}return s()(n,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,a=t.viewport;if(t.numPointers===this.configuration.touchPointers){var o=this._getTranslation(t);this._applyTranslation(a,o),y.cornerstone.setViewport(n,a)}}},{key:"_getTranslation",value:function(e){var t=e.viewport,n=e.image,a=e.deltaPoints,o=t.scale,r=t.scale;return n.rowPixelSpacing<n.columnPixelSpacing?o*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(r*=n.rowPixelSpacing/n.columnPixelSpacing),{x:a.page.x/o,y:a.page.y/r}}},{key:"_applyTranslation",value:function(e,t){e.translation.x+=t.x,e.translation.y+=t.y}}]),n}(va);function Ns(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Fs=function(e){u()(n,e);var t=Ns(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"Pan",supportedInteractionTypes:["Mouse","Touch"],svgCursor:Uo};return(e=t.call(this,a,o)).touchDragCallback=e._dragCallback.bind(wa()(e)),e.mouseDragCallback=e._dragCallback.bind(wa()(e)),e}return s()(n,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,a=t.viewport,o=this._getTranslation(t);this._applyTranslation(a,o),y.cornerstone.setViewport(n,a)}},{key:"_getTranslation",value:function(e){var t=e.viewport,n=e.image,a=e.deltaPoints,o=t.scale,r=t.scale;return n.rowPixelSpacing<n.columnPixelSpacing?o*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(r*=n.rowPixelSpacing/n.columnPixelSpacing),{x:a.page.x/o,y:a.page.y/r}}},{key:"_applyTranslation",value:function(e,t){e.translation.x+=t.x,e.translation.y+=t.y}}]),n}(va),Vs=n(13),qs=n.n(Vs),js=n(11),zs=n.n(js),Ws=function(e,t,n,a){var o=y.cornerstone,r=o.getEnabledElement(n).image,i=o.getEnabledElement(a).image;if(r&&i){var l=o.metaData.get("imagePlaneModule",r.imageId),s=o.metaData.get("imagePlaneModule",i.imageId);if(l&&s&&l.rowCosines&&l.columnCosines&&l.imagePositionPatient&&s.rowCosines&&s.columnCosines&&s.imagePositionPatient&&l.frameOfReferenceUID===s.frameOfReferenceUID){l.rowCosines=en(l.rowCosines),l.columnCosines=en(l.columnCosines),l.imagePositionPatient=en(l.imagePositionPatient),s.rowCosines=en(s.rowCosines),s.columnCosines=en(s.columnCosines),s.imagePositionPatient=en(s.imagePositionPatient);var c=l.rowCosines.clone().cross(l.columnCosines),u=s.rowCosines.clone().cross(s.columnCosines),d=c.angleTo(u);if(!((d=Math.abs(d))<.5)){var f=function(e,t){var n=an(e,t);if(n)return{start:tn(n.start,e),end:tn(n.end,e)}}(l,s);if(f){var h=un.getActiveColor();e.setTransform(1,0,0,1,0,0),Wt(e,(function(e){Zt(e,t.element,f.start,f.end,{color:h})}))}}}}},Gs=function(e){return new Promise((function(t){return setTimeout(t,e)}))};function Ys(e){try{var t=y.cornerstone.getEnabledElement(e);return t.image?t:Gs(250).then((function(){return Ys(e)}))}catch(e){return null}}function Xs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Ks=B("tools:ReferenceLinesTool"),Zs=function(e){u()(a,e);var t,n=Xs(a);function a(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,a);var o={name:"ReferenceLines",mixins:["enabledOrDisabledBinaryTool"],configuration:{renderer:Ws}};return(e=n.call(this,t,o)).renderer=null,e.synchronizationContext=null,e}return s()(a,[{key:"enabledCallback",value:(t=qs()(zs.a.mark((function e(t){var n,a,o,r=arguments;return zs.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:{},a=n.synchronizationContext,o=this.configuration.renderer,e.next=4,Ys(t);case 4:if(e.sent&&o&&a){e.next=8;break}return Ks.warn("Unable to enable ".concat(this.name,". Exiting enable callback. Tool will be enabled, but will not render.")),e.abrupt("return");case 8:this.renderer=o,this.synchronizationContext=a,this.forceImageUpdate(t);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"disabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"forceImageUpdate",value:function(e){y.cornerstone.getEnabledElement(e).image&&y.cornerstone.updateImage(e)}},{key:"renderToolData",value:function(e){var t=this,n=e.detail;if(this.renderer&&this.synchronizationContext){var a=this.synchronizationContext.getSourceElements(),o=_n(n.canvasContext.canvas);y.cornerstone.setToPixelCoordinateSystem(n.enabledElement,o),a.forEach((function(a){a!==e.currentTarget&&t.renderer(o,n,e.currentTarget,a)}))}}}]),a}(va),$s=function(e,t,n){var a=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),o=Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2)),r=Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2));return{angle:180*Math.acos((Math.pow(a,2)+Math.pow(o,2)-Math.pow(r,2))/(2*a*o))/Math.PI,direction:(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)}};function Js(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Qs=function(e){u()(n,e);var t=Js(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"Rotate",strategies:{default:ec,horizontal:tc,vertical:nc},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],configuration:{roundAngles:!1,flipHorizontal:!1,flipVertical:!1,rotateScale:1},svgCursor:Bo};return t.call(this,e,a)}return s()(n,[{key:"touchDragCallback",value:function(e){this.dragCallback(e)}},{key:"mouseDragCallback",value:function(e){this.dragCallback(e)}},{key:"postMouseDownCallback",value:function(e){this.initialRotation=e.detail.viewport.rotation}},{key:"dragCallback",value:function(e){e.detail.viewport.initialRotation=this.initialRotation,this.applyActiveStrategy(e),y.cornerstone.setViewport(e.detail.element,e.detail.viewport)}}]),n}(va);function ec(e){var t=this.configuration,n=t.roundAngles,a=t.rotateScale,o=e.detail,r=o.element,i=o.viewport,l=o.startPoints,s=o.currentPoints,c=i.initialRotation?i.initialRotation:i.rotation,u=r.getBoundingClientRect(r),d=r.clientWidth,f=r.clientHeight,h=i.scale,v=i.translation,g={x:u.left+d/2+v.x*h,y:u.top+f/2+v.y*h},m=$s(g,l.client,s.client);m.angle*=a,n&&(m.angle=Math.ceil(m.angle)),m.direction<0&&(m.angle=-m.angle),i.rotation=c+m.angle}function tc(e){var t=this.configuration,n=t.roundAngles,a=t.flipHorizontal,o=t.rotateScale,r=e.detail,i=r.viewport,l=r.startPoints,s=r.currentPoints,c=i.initialRotation,u=l.client.x,d=(s.client.x-u)*o;n&&(d=Math.round(Math.abs(d))*(d>0?1:-1)),a&&(d=-d),i.rotation=c+d}function nc(e){var t=this.configuration,n=t.roundAngles,a=t.flipVertical,o=t.rotateScale,r=e.detail,i=r.viewport,l=r.startPoints,s=r.currentPoints,c=i.initialRotation,u=l.client.y,d=(s.client.y-u)*o;n&&(d=Math.round(Math.abs(d))*(d>0?1:-1)),a&&(d=-d),i.rotation=c+d}function ac(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var oc=function(e){u()(n,e);var t=ac(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"RotateTouch",supportedInteractionTypes:["TouchRotate"]};return t.call(this,e,a)}return s()(n,[{key:"touchRotateCallback",value:function(e){var t=e.detail,n=t.element,a=t.viewport,o=t.rotation;a.rotation+=o,y.cornerstone.setViewport(n,a)}}]),n}(va);function rc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var ic=B("tools:ScaleOverlayTool"),lc=function(e){u()(n,e);var t=rc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"ScaleOverlay",configuration:{minorTickLength:12.5,majorTickLength:25},mixins:["enabledOrDisabledBinaryTool"]};return t.call(this,e,a)}return s()(n,[{key:"enabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"disabledCallback",value:function(e){this.forceImageUpdate(e)}},{key:"forceImageUpdate",value:function(e){y.cornerstone.getEnabledElement(e).image&&y.cornerstone.updateImage(e)}},{key:"renderToolData",value:function(e){var t=e.detail,n=_n(t.canvasContext.canvas),a=t.image,o=t.viewport,r=t.element,i=a.rowPixelSpacing,l=a.columnPixelSpacing,s=y.cornerstone.metaData.get("imagePlaneModule",a.imageId);if(s&&(i=s.rowPixelSpacing||s.rowImagePixelSpacing,l=s.columnPixelSpacing||s.colImagePixelSpacing),i&&l){var c={width:n.canvas.width,height:n.canvas.height},u=10/i*o.scale,d=10/l*o.scale,f=sc(c,.25,.05),h=sc(c,.05,.15);if(c.width&&c.height&&f&&h){var v=un.getToolColor(),g=Xt.getToolWidth(),m=Object.assign({},{hscaleBounds:f,vscaleBounds:h,verticalMinorTick:u,horizontalMinorTick:d,verticalLine:{start:{x:h.bottomRight.x,y:h.topLeft.y},end:{x:h.bottomRight.x,y:h.bottomRight.y}},horizontalLine:{start:{x:f.topLeft.x,y:f.bottomRight.y},end:{x:f.bottomRight.x,y:f.bottomRight.y}},color:v,lineWidth:g},this.configuration);Wt(n,(function(e){Dn(e,m),Zt(e,r,m.verticalLine.start,m.verticalLine.end,{color:m.color,lineWidth:m.lineWidth},"canvas"),cc(e,r,m),Zt(e,r,m.horizontalLine.start,m.horizontalLine.end,{color:m.color,lineWidth:m.lineWidth},"canvas"),uc(e,r,m)}))}}else ic.warn("unable to define rowPixelSpacing or colPixelSpacing from data on ".concat(this.name,"'s renderToolData"))}}]),n}(va),sc=function(e,t,n){var a=t*Math.min(1e3,e.width),o=n*Math.min(1e3,e.height),r={left:a,top:o,width:e.width-2*a,height:e.height-2*o};return{topLeft:{x:r.left,y:r.top},bottomRight:{x:r.left+r.width,y:r.top+r.height}}},cc=function(e,t,n){for(var a=0;n.verticalLine.start.y+a*n.verticalMinorTick<=n.vscaleBounds.bottomRight.y;){var o=n.color,r=n.lineWidth,i={x:n.verticalLine.start.x,y:n.verticalLine.start.y+a*n.verticalMinorTick},l={x:0,y:n.verticalLine.start.y+a*n.verticalMinorTick};l.x=a%5==0?n.verticalLine.start.x-n.majorTickLength:n.verticalLine.start.x-n.minorTickLength,Zt(e,t,i,l,{color:o,lineWidth:r},"canvas"),a++}},uc=function(e,t,n){for(var a=0;n.horizontalLine.start.x+a*n.horizontalMinorTick<=n.hscaleBounds.bottomRight.x;){var o=n.color,r=n.lineWidth,i={x:n.horizontalLine.start.x+a*n.horizontalMinorTick,y:n.horizontalLine.start.y},l={x:n.horizontalLine.start.x+a*n.horizontalMinorTick,y:0};l.y=a%5==0?n.horizontalLine.start.y-n.majorTickLength:n.horizontalLine.start.y-n.minorTickLength,Zt(e,t,i,l,{color:o,lineWidth:r},"canvas"),a++}},dc=function(e,t){var n=O(e,"stack");if(n&&n.data&&n.data.length){var a,o=y.cornerstone;if(n.data.length>1){var r=O(e,"stackRenderer");r&&r.data&&r.data.length&&(a=r.data[0])}var i=n.data[0];t<0&&(t+=i.imageIds.length);var l=ls.getStartLoadHandler(e),s=ls.getEndLoadHandler(e),c=ls.getErrorLoadingHandler(e);if(t!==i.currentImageIdIndex){l&&l(e);var u={newImageIdIndex:t,direction:t-i.currentImageIdIndex};i.currentImageIdIndex=t;var d=i.imageIds[t];(Boolean(i.preventCache)?o.loadImage(d):o.loadAndCacheImage(d)).then((function(r){if(i.currentImageIdIndex===t){try{o.getEnabledElement(e)}catch(e){return}a?(a.currentImageIdIndex=t,a.render(e,n.data)):o.displayImage(e,r),s&&s(e,r)}}),(function(n){var a=i.imageIds[t];c&&c(e,a,n)})),C(e,b.STACK_SCROLL,u)}}},fc=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=O(e,"stack");if(o&&o.data&&o.data.length){var r=o.data[0];r.pending||(r.pending=[]);var i=r.currentImageIdIndex+t;if(n){var l=r.imageIds.length;i%=l}else i=In(i,0,r.imageIds.length-1);if(a)dc(e,i);else{var s={index:i};r.pending.push(s),hc(r,s,e)}}};function hc(e,t,n){if(e.pending[0]===t){if(e.currentImageIdIndex===t.index)return e.pending.splice(e.pending.indexOf(t),1),void(e.pending.length>0&&hc(e,e.pending[0],n));n.addEventListener(y.cornerstone.EVENTS.NEW_IMAGE,(function a(o){e.imageIds.indexOf(o.detail.image.imageId)===t.index&&(e.pending.splice(e.pending.indexOf(t),1),n.removeEventListener(y.cornerstone.EVENTS.NEW_IMAGE,a),e.pending.length>0&&hc(e,e.pending[0],n))})),dc(n,t.index)}}function vc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var gc=function(e){u()(n,e);var t=vc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"StackScrollMouseWheel",supportedInteractionTypes:["MouseWheel"],configuration:{loop:!1,allowSkipping:!0,invert:!1}};return t.call(this,e,a)}return s()(n,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.direction,a=t.element,o=this.configuration,r=o.loop,i=o.allowSkipping,l=o.invert;fc(a,l?-n:n,r,i)}}]),n}(va);function mc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var pc=function(e){u()(n,e);var t=mc(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"StackScrollMultiTouch",supportedInteractionTypes:["MultiTouch"],configuration:{loop:!1,allowSkipping:!0,touchPointers:3}};return(e=t.call(this,a,o)).multiTouchDragCallback=e._dragCallback.bind(wa()(e)),e}return s()(n,[{key:"_dragCallback",value:function(e){var t=e.detail;if(t.numPointers===this.configuration.touchPointers){var n=t.element,a=t.deltaPoints,o=this.configuration,r=o.loop,i=o.allowSkipping,l=cs(this.name,n),s=this._getPixelPerImage(n),c=this._getDeltaY(n,a.page.y);if(!s)return;if(Math.abs(c)>=s){var u=Math.round(c/s);fc(n,u,r,i),l.deltaY=c%s}else l.deltaY=c;us(this.name,n,l)}}},{key:"_getDeltaY",value:function(e,t){return(cs(this.name,e).deltaY||0)+t}},{key:"_getPixelPerImage",value:function(e){var t=O(e,"stack");if(t&&t.data&&t.data.length){var n=t.data[0];return this.configuration.stackScrollSpeed||Math.max(2,e.offsetHeight/Math.max(n.imageIds.length,8))}}}]),n}(va);function yc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var xc=function(e){u()(n,e);var t=yc(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"StackScroll",supportedInteractionTypes:["Mouse","Touch"],configuration:{loop:!1,allowSkipping:!0},svgCursor:No};return(e=t.call(this,a,o)).mouseDragCallback=e._dragCallback.bind(wa()(e)),e.touchDragCallback=e._dragCallback.bind(wa()(e)),e}return s()(n,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,a=t.deltaPoints,o=this.configuration,r=o.loop,i=o.allowSkipping,l=cs(this.name,n),s=this._getPixelPerImage(n),c=this._getDeltaY(n,a.page.y);if(s){if(Math.abs(c)>=s){var u=Math.round(c/s);fc(n,u,r,i),l.deltaY=c%s}else l.deltaY=c;us(this.name,n,l)}}},{key:"_getDeltaY",value:function(e,t){return(cs(this.name,e).deltaY||0)+t}},{key:"_getPixelPerImage",value:function(e){var t=O(e,"stack");if(t&&t.data&&t.data.length){var n=t.data[0];return this.configuration.stackScrollSpeed||Math.max(2,e.offsetHeight/Math.max(n.imageIds.length,8))}}}]),n}(va),Tc=function(e,t,n,a,o){if(!e)throw new Error("getLuminance: parameter element must not be undefined");t=Math.round(t),n=Math.round(n);var r,i,l,s=y.cornerstone.getEnabledElement(e).image,c=[],u=0,d=s.getPixelData();if(s.color)for(i=0;i<o;i++)for(l=0;l<a;l++){var f=d[r=4*((i+n)*s.columns+(l+t))],h=d[r+1],v=d[r+2];c[u++]=.2126*f+.7152*h+.0722*v}else for(i=0;i<o;i++)for(l=0;l<a;l++)r=(i+n)*s.columns+(l+t),c[u++]=d[r]*s.slope+s.intercept;return c};function bc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Cc=function(e){u()(n,e);var t=bc(n);function n(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var o={name:"WwwcRegion",supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10},svgCursor:Fo};return(e=t.call(this,a,o))._resetHandles(),e.postTouchStartCallback=e._startOutliningRegion.bind(wa()(e)),e.touchDragCallback=e._setHandlesAndUpdate.bind(wa()(e)),e.touchEndCallback=e._applyStrategy.bind(wa()(e)),e.postMouseDownCallback=e._startOutliningRegion.bind(wa()(e)),e.mouseClickCallback=e._startOutliningRegion.bind(wa()(e)),e.mouseDragCallback=e._setHandlesAndUpdate.bind(wa()(e)),e.mouseMoveCallback=e._setHandlesAndUpdate.bind(wa()(e)),e.mouseUpCallback=e._applyStrategy.bind(wa()(e)),e}return s()(n,[{key:"renderToolData",value:function(e){var t=this,n=e.detail,a=n.element,o=un.getColorIfActive({active:!0}),r=_n(n.canvasContext.canvas);Wt(r,(function(e){kn(e,a,t.handles.start,t.handles.end,{color:o})}))}},{key:"_startOutliningRegion",value:function(e){var t=e.detail.element,n=e.detail.currentPoints.image;return Mc(this.handles.start)?this.handles.start=n:(this.handles.end=n,this._applyStrategy(e)),y.cornerstone.updateImage(t),!0}},{key:"_setHandlesAndUpdate",value:function(e){var t=e.detail.element,n=e.detail.currentPoints.image;this.handles.end=n,y.cornerstone.updateImage(t)}},{key:"_applyStrategy",value:function(e){Mc(this.handles.start)||Mc(this.handles.end)||(e.detail.handles=this.handles,Ec(e,this.configuration),this._resetHandles())}},{key:"_resetHandles",value:function(){this.handles={start:{},end:{}}}}]),n}(va),Mc=function(e){return 0===Object.keys(e).length&&e.constructor===Object},Ec=function(e,t){var n=e.detail,a=n.image,o=n.element,r=e.detail.handles,i=r.start,l=r.end,s=Math.min(i.x,l.x),c=Math.min(i.y,l.y),u=Math.abs(i.x-l.x),d=Math.abs(i.y-l.y);s=In(s,0,a.width),c=In(c,0,a.height),u=Math.floor(Math.min(u,Math.abs(a.width-s))),d=Math.floor(Math.min(d,Math.abs(a.height-c)));var f=Tc(o,s,c,u,d),h=wc(f,a.minPixelValue,a.maxPixelValue),v=n.viewport;void 0===t.minWindowWidth&&(t.minWindowWidth=10),v.voi.windowWidth=Math.max(Math.abs(h.max-h.min),t.minWindowWidth),v.voi.windowCenter=h.mean,v.voiLUT=void 0,y.cornerstone.setViewport(o,v),y.cornerstone.updateImage(o)},wc=function(e,t,n){var a=e.length,o=n,r=t,i=0;if(a<2)return{min:o,max:r,mean:(t+n)/2};for(var l=0;l<a;l++){var s=e[l];o=Math.min(o,s),r=Math.max(r,s),i+=s}return{min:o,max:r,mean:i/a}};function Ic(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Sc=function(e){u()(n,e);var t=Ic(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"Wwwc",strategies:{basicLevelingStrategy:kc},supportedInteractionTypes:["Mouse","Touch"],configuration:{orientation:0},svgCursor:Vo};return t.call(this,e,a)}return s()(n,[{key:"mouseDragCallback",value:function(e){this.applyActiveStrategy(e),y.cornerstone.setViewport(e.detail.element,e.detail.viewport)}},{key:"touchDragCallback",value:function(e){e.stopImmediatePropagation(),this.applyActiveStrategy(e),y.cornerstone.setViewport(e.detail.element,e.detail.viewport)}}]),n}(va);function kc(e){var t=this.configuration.orientation,n=e.detail,a=(n.image.maxPixelValue*n.image.slope+n.image.intercept-(n.image.minPixelValue*n.image.slope+n.image.intercept))/1024,o=n.deltaPoints.page.x*a,r=n.deltaPoints.page.y*a;0===t?(n.viewport.voi.windowWidth+=o,n.viewport.voi.windowCenter+=r):(n.viewport.voi.windowWidth+=r,n.viewport.voi.windowCenter+=o),n.viewport.voiLUT=void 0}var _c=function(e,t,n){var a=n.maxScale,o=n.minScale,r=Math.log(e.scale)/Math.log(1.7)+t,i=Math.pow(1.7,r);return e.scale=a&&i>a?a:o&&i<o?o:i,e},Pc={changeViewportScale:_c,correctShift:function(e,t){var n=t.hflip,a=t.vflip,o=t.rotation;if(e.x*=n?-1:1,e.y*=a?-1:1,0!==o){var r=o*Math.PI/180,i=Math.cos(r),l=Math.sin(r),s=e.x*i-e.y*l,c=e.x*l+e.y*i;e.x=s,e.y=c}return e}};function Dc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Oc=function(e){u()(n,e);var t=Dc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"ZoomMouseWheel",supportedInteractionTypes:["MouseWheel"],configuration:{minScale:.25,maxScale:20,invert:!1}};return t.call(this,e,a)}return s()(n,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.element,a=t.viewport,o=t.spinY,r=this.configuration,i=r.invert,l=r.maxScale,s=r.minScale,c=_c(a,i?o/4:-o/4,{maxScale:l,minScale:s});y.cornerstone.setViewport(n,c)}}]),n}(va);function Lc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var Rc=Pc.correctShift,Ac=Pc.changeViewportScale,Hc=function(e){u()(n,e);var t=Lc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"Zoom",strategies:{default:Bc,translate:Nc,zoomToCenter:Fc},defaultStrategy:"default",supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,preventZoomOutsideImage:!1,minScale:.25,maxScale:20},svgCursor:qo};return t.call(this,e,a)}return s()(n,[{key:"touchDragCallback",value:function(e){Uc.call(this,e)}},{key:"mouseDragCallback",value:function(e){Uc.call(this,e)}}]),n}(va),Uc=function(e){if(!e.detail.deltaPoints.page.y)return!1;this.applyActiveStrategy(e,this.configuration),y.cornerstone.setViewport(e.detail.element,e.detail.viewport)};function Bc(e){var t=this.configuration,n=t.invert,a=t.maxScale,o=t.minScale,r=e.detail.deltaPoints.page.y,i=n?-r/100:r/100,l=e.detail,s=l.element,c=l.viewport,u=[e.detail.startPoints.page.x,e.detail.startPoints.page.y,e.detail.startPoints.image.x,e.detail.startPoints.image.y],d=u[0],f=u[1],h=u[2],v=u[3],g=Ac(c,i,{maxScale:a,minScale:o});y.cornerstone.setViewport(s,g);var m=y.cornerstone.pageToPixel(s,d,f),p={x:h-m.x,y:v-m.y};p=Rc(p,g),c.translation.x-=p.x,c.translation.y-=p.y}function Nc(e){var t=this.configuration,n=t.invert,a=t.preventZoomOutsideImage,o=t.maxScale,r=t.minScale,i=e.detail.deltaPoints.page.y,l=n?-i/100:i/100,s=e.detail.image,c=e.detail.viewport,u=[e.detail.startPoints.image.x,e.detail.startPoints.image.y],d=u[0],f=u[1],h=Ac(c,l,{maxScale:o,minScale:r}),v={x:0,y:0};if(l<0)h.scale<3&&(Math.abs(h.translation.x)<.01?h.translation.x=0:v.x=h.translation.x/8,Math.abs(h.translation.y)<.01?h.translation.y=0:v.y=h.translation.y/8);else{a&&Mn(e.detail.startPoints.image,s);var g={x:s.width/2-d,y:s.height/2-f};g=Rc(g,h);var m={x:h.translation.x-g.x,y:h.translation.y-g.y};Math.abs(m.x)<.01?h.translation.x=g.x:v.x=m.x/8,Math.abs(m.y)<.01?h.translation.y=g.y:v.y=m.y/8}h.translation.x-=v.x,h.translation.y-=v.y}function Fc(e){var t=this.configuration,n=t.invert,a=t.maxScale,o=t.minScale,r=e.detail.deltaPoints.page.y,i=n?-r/100:r/100,l=e.detail.viewport;Ac(l,i,{maxScale:a,minScale:o})}function Vc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=v()(e);if(t){var o=v()(this).constructor;n=Reflect.construct(a,arguments,o)}else n=a.apply(this,arguments);return f()(this,n)}}var qc=Pc.correctShift,jc=function(e){u()(n,e);var t=Vc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i()(this,n);var a={name:"ZoomTouchPinch",supportedInteractionTypes:["TouchPinch"],configuration:{minScale:.25,maxScale:20}};return t.call(this,e,a)}return s()(n,[{key:"touchPinchCallback",value:function(e){var t=e.detail,n=t.element,a=t.viewport,o=t.scaleChange,r=[e.detail.startPoints.page.x,e.detail.startPoints.page.y,e.detail.startPoints.image.x,e.detail.startPoints.image.y],i=r[0],l=r[1],s=r[2],c=r[3],u=this.configuration,d=u.maxScale,f=u.minScale;a.scale+=o*a.scale,d&&a.scale>d?a.scale=d:f&&a.scale<f&&(a.scale=f),y.cornerstone.setViewport(n,a);var h=y.cornerstone.pageToPixel(n,i,l),v={x:s-h.x,y:c-h.y};v=qc(v,a),a.translation.x-=v.x,a.translation.y-=v.y,y.cornerstone.setViewport(n,a)}}]),n}(va),zc=function(e){return{page:Wc(e.page),image:Wc(e.image),client:Wc(e.client),canvas:Wc(e.canvas)}};function Wc(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.x,n=e.y;return{x:t,y:n}}var Gc,Yc=B("eventListeners:mouseEventListeners"),Xc=!0,Kc=new Map;function Zc(e){if("number"==typeof e.buttons)return e.buttons;switch(e.which){case 0:return 0;case 1:return 1;case 2:return 4;case 3:return 2}return 0}function $c(){Xc=!1}function Jc(e){var t=e.currentTarget,n=y.cornerstone.getEnabledElement(t);if(n.image){var a=b.MOUSE_DOUBLE_CLICK,o={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};o.canvas=y.cornerstone.pixelToCanvas(t,o.image);var r=zc(o);Yc.log("double-click: %o",Zc(e)),C(t,a,{event:e,buttons:Zc(e),viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:o,lastPoints:r,currentPoints:o,deltaPoints:{x:0,y:0},type:a})}}function Qc(e){var t=e.currentTarget,n=y.cornerstone.getEnabledElement(t);if(n.image){Gc=setTimeout($c,200),t.removeEventListener("mousemove",eu);var a={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};a.canvas=y.cornerstone.pixelToCanvas(t,a.image);var o=zc(a),r={event:e,buttons:Zc(e),viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:a,lastPoints:o,currentPoints:a,deltaPoints:{x:0,y:0},type:b.MOUSE_DOWN};C(r.element,b.MOUSE_DOWN,r)&&(r.type=b.MOUSE_DOWN_ACTIVATE,C(r.element,b.MOUSE_DOWN_ACTIVATE,r)),document.addEventListener("mousemove",i),document.addEventListener("mouseup",l),Kc.set(i,"mousemove"),Kc.set(l,"mouseup")}function i(e){var r=b.MOUSE_DRAG,i={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};i.canvas=y.cornerstone.pixelToCanvas(t,i.image);var l={page:y.cornerstoneMath.point.subtract(i.page,o.page),image:y.cornerstoneMath.point.subtract(i.image,o.image),client:y.cornerstoneMath.point.subtract(i.client,o.client),canvas:y.cornerstoneMath.point.subtract(i.canvas,o.canvas)};Yc.log("mousemove: %o",Zc(e));var s={buttons:Zc(e),viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:a,lastPoints:o,currentPoints:i,deltaPoints:l,type:r,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey};C(s.element,r,s),o=zc(i)}function l(e){clearTimeout(Gc);var r=b.MOUSE_UP;Xc&&(r=b.MOUSE_CLICK);var s={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};s.canvas=y.cornerstone.pixelToCanvas(t,s.image);var c={page:y.cornerstoneMath.point.subtract(s.page,o.page),image:y.cornerstoneMath.point.subtract(s.image,o.image),client:y.cornerstoneMath.point.subtract(s.client,o.client),canvas:y.cornerstoneMath.point.subtract(s.canvas,o.canvas)};Yc.log("mouseup: %o",Zc(e));var u={event:e,buttons:Zc(e),viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:a,lastPoints:o,currentPoints:s,deltaPoints:c,type:r};C(u.element,r,u),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",l),Kc.delete(i),Kc.delete(l),t.addEventListener("mousemove",eu),Xc=!0}}function eu(e){var t=e.currentTarget,n=y.cornerstone.getEnabledElement(t);if(n.image){var a=b.MOUSE_MOVE,o={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};o.canvas=y.cornerstone.pixelToCanvas(t,o.image);var r=zc(o),i={page:y.cornerstoneMath.point.pageToPoint(e),image:y.cornerstone.pageToPixel(t,e.pageX,e.pageY),client:{x:e.clientX,y:e.clientY}};i.canvas=y.cornerstone.pixelToCanvas(t,i.image);var l={page:y.cornerstoneMath.point.subtract(i.page,r.page),image:y.cornerstoneMath.point.subtract(i.image,r.image),client:y.cornerstoneMath.point.subtract(i.client,r.client),canvas:y.cornerstoneMath.point.subtract(i.canvas,r.canvas)};C(t,a,{viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:o,lastPoints:r,currentPoints:i,deltaPoints:l,type:a}),r=zc(i)}}function tu(e){e.removeEventListener("mousedown",Qc),e.removeEventListener("mousemove",eu),e.removeEventListener("dblclick",Jc),Kc.forEach((function(e,t){document.removeEventListener(e,t)})),Kc.clear()}var nu={enable:function(e){tu(e),e.addEventListener("mousedown",Qc),e.addEventListener("mousemove",eu),e.addEventListener("dblclick",Jc)},disable:tu};function au(e){var t=e.currentTarget,n=y.cornerstone.getEnabledElement(t);if(n.image&&!(e.deltaY>-1&&e.deltaY<1)){e.preventDefault();var a=e.pageX,o=e.pageY,r=y.cornerstone.pageToPixel(t,a,o),i=function(e){var t=0,n=0,a=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),a=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(a=e.deltaX),(a||o)&&e.deltaMode&&(1===e.deltaMode?(a*=40,o*=40):(a*=800,o*=800)),a&&!t&&(t=a<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:a,pixelY:o}}(e),l=i.spinX,s=i.spinY,c=i.pixelX,u=i.pixelY,d=s<0?-1:1,f={element:t,viewport:y.cornerstone.getViewport(t),detail:e,image:n.image,direction:d,spinX:l,spinY:s,pixelX:c,pixelY:u,pageX:a,pageY:o,imageX:r.x,imageY:r.y};C(t,b.MOUSE_WHEEL,f)}}function ou(e){e.removeEventListener("wheel",au,{passive:!1})}var ru,iu,lu={enable:function(e){ou(e),e.addEventListener("wheel",au,{passive:!1})},disable:ou},su=0,cu=1;function uu(e,t){var n=Date.now();if(e!==ru){if(n-iu<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;ru=e}iu=n}var du=uu.bind(null,su),fu=uu.bind(null,cu);function hu(e,t,n){var a=n?du:fu;t.forEach((function(t){e.addEventListener(t,a,{passive:!1})}))}function vu(e,t,n){var a=n?du:fu;t.forEach((function(t){e.removeEventListener(t,a)}))}var gu=["mousedown","mouseup"],mu=["touchstart","touchend"];function pu(e){vu(e,gu,su),vu(e,mu,cu)}var yu,xu,Tu,bu,Cu,Mu,Eu,wu,Iu,Su={enable:function(e){pu(e),hu(e,gu,su),hu(e,mu,cu)},disable:pu},ku=1,_u=0,Pu=!1,Du=!1;function Ou(e){var t=e.currentTarget||e.srcEvent.currentTarget,n=y.cornerstone.getEnabledElement(t);if(n.image){var a,o,r,i;switch(e.preventDefault(),(e.pointers&&e.pointers.length>1||e.touches&&e.touches.length>1)&&(Du=!1,clearTimeout(Eu)),e.type){case"tap":Du=!1,clearTimeout(Eu),(xu={page:y.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:y.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,xu.image),a=b.TAP,Cu={event:e,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:xu,type:a,isTouchEvent:!0},C(t,a,Cu);break;case"doubletap":Du=!1,clearTimeout(Eu),(xu={page:y.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:y.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,xu.image),a=b.DOUBLE_TAP,Cu={event:e,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:xu,type:a,isTouchEvent:!0},C(t,a,Cu);break;case"pinchstart":Du=!1,clearTimeout(Eu),ku=1;break;case"pinchmove":if(Du=!1,clearTimeout(Eu),!0===Pu){ku=e.scale,Pu=!1;break}o=(e.scale-ku)/ku,(yu={page:e.center,image:y.cornerstone.pageToPixel(t,e.center.x,e.center.y)}).canvas=y.cornerstone.pixelToCanvas(t,yu.image),a=b.TOUCH_PINCH,Cu={event:e,startPoints:yu,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,direction:e.scale<1?1:-1,scaleChange:o,type:a,isTouchEvent:!0},C(t,a,Cu),ku=e.scale;break;case"touchstart":ku=1,clearTimeout(Eu),clearTimeout(Mu),Mu=setTimeout((function(){(yu={page:y.cornerstoneMath.point.pageToPoint(e.touches[0]),image:y.cornerstone.pageToPixel(t,e.touches[0].pageX,e.touches[0].pageY),client:{x:e.touches[0].clientX,y:e.touches[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,yu.image),a=b.TOUCH_START,e.touches.length>1&&(a=b.MULTI_TOUCH_START),Cu={event:e,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:yu,currentPoints:yu,type:a,isTouchEvent:!0},!0===C(t,a,Cu)&&(a=b.TOUCH_START_ACTIVE,e.touches.length>1&&(a=b.MULTI_TOUCH_START_ACTIVE),Cu.type=a,C(t,a,Cu)),Tu=zc(yu)}),50),Du=!0,wu=0,Eu=setTimeout((function(){Du&&((xu={page:y.cornerstoneMath.point.pageToPoint(e.touches[0]),image:y.cornerstone.pageToPixel(t,e.touches[0].pageX,e.touches[0].pageY),client:{x:e.touches[0].clientX,y:e.touches[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,yu.image),a=b.TOUCH_PRESS,Cu={event:e,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,currentPoints:xu,type:a,isTouchEvent:!0},C(t,a,Cu))}),700);break;case"touchend":ku=1,Du=!1,clearTimeout(Eu),setTimeout((function(){(yu={page:y.cornerstoneMath.point.pageToPoint(e.changedTouches[0]),image:y.cornerstone.pageToPixel(t,e.changedTouches[0].pageX,e.changedTouches[0].pageY),client:{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,yu.image),a=b.TOUCH_END,Cu={event:e,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:yu,currentPoints:yu,type:a,isTouchEvent:!0},C(t,a,Cu)}),50);break;case"panmove":r={x:e.deltaX-Iu.x,y:e.deltaY-Iu.y},Iu={x:e.deltaX,y:e.deltaY},(xu={page:{x:Tu.page.x+r.x,y:Tu.page.y+r.y},image:y.cornerstone.pageToPixel(t,Tu.page.x+r.x,Tu.page.y+r.y),client:{x:Tu.client.x+r.x,y:Tu.client.y+r.y}}).canvas=y.cornerstone.pixelToCanvas(t,xu.image),bu={page:y.cornerstoneMath.point.subtract(xu.page,Tu.page),image:y.cornerstoneMath.point.subtract(xu.image,Tu.image),client:y.cornerstoneMath.point.subtract(xu.client,Tu.client),canvas:y.cornerstoneMath.point.subtract(xu.canvas,Tu.canvas)},(wu+=Math.sqrt(bu.page.x*bu.page.x+bu.page.y*bu.page.y))>5&&(Du=!1,clearTimeout(Eu)),a=b.TOUCH_DRAG,e.pointers.length>1&&(a=b.MULTI_TOUCH_DRAG),Cu={viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:yu,lastPoints:Tu,currentPoints:xu,deltaPoints:bu,numPointers:e.pointers.length,type:a,isTouchEvent:!0},C(t,a,Cu),Tu=zc(xu);break;case"panstart":Iu={x:e.deltaX,y:e.deltaY},(xu={page:y.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:y.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,xu.image),Tu=zc(xu);break;case"panend":if(Du=!1,clearTimeout(Eu),!Tu)return!1;(xu={page:y.cornerstoneMath.point.pageToPoint(e.pointers[0]),image:y.cornerstone.pageToPixel(t,e.pointers[0].pageX,e.pointers[0].pageY),client:{x:e.pointers[0].clientX,y:e.pointers[0].clientY}}).canvas=y.cornerstone.pixelToCanvas(t,xu.image),bu={page:y.cornerstoneMath.point.subtract(xu.page,Tu.page),image:y.cornerstoneMath.point.subtract(xu.image,Tu.image),client:y.cornerstoneMath.point.subtract(xu.client,Tu.client),canvas:y.cornerstoneMath.point.subtract(xu.canvas,Tu.canvas)},a=b.TOUCH_DRAG_END,Cu={event:e.srcEvent,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,startPoints:yu,lastPoints:Tu,currentPoints:xu,deltaPoints:bu,type:a,isTouchEvent:!0},C(t,a,Cu),2===e.pointers.length-e.changedPointers.length&&(Pu=!0);break;case"rotatemove":Du=!1,clearTimeout(Eu),i=e.rotation-_u,_u=e.rotation,a=b.TOUCH_ROTATE,Cu={event:e.srcEvent,viewport:y.cornerstone.getViewport(t),image:n.image,element:t,rotation:i,type:a},C(t,a,Cu)}return!1}}function Lu(e){Su.disable(e);["touchstart","touchend"].forEach((function(t){e.removeEventListener(t,Ou)}));var t=cs("touchInput",e),n=t.hammer;n&&(n.off("tap doubletap panstart panmove panend pinchstart pinchmove rotatemove",Ou),n.input.destroy()),t.hammer=null,function(e,t){var n=ss[e];n&&(ss[e]=n.filter((function(e){return e.element!==t})))}("touchInput",e)}var Ru={enable:function(e){Lu(e);var t=y.Hammer,n={inputClass:t.SUPPORT_POINTER_EVENTS?t.PointerEventInput:t.TouchInput},a=new t.Manager(e,n),o={pointers:0,direction:t.DIRECTION_ALL,threshold:0},r=new t.Pan(o),i=new t.Pinch({threshold:0}),l=new t.Rotate({threshold:0});i.recognizeWith(r),i.recognizeWith(l),l.recognizeWith(r);var s=new t.Tap({event:"doubletap",taps:2,interval:1500,threshold:50,posThreshold:50});s.recognizeWith(r),a.add([s,r,l,i]),a.on("tap doubletap panstart panmove panend pinchstart pinchmove rotatemove",Ou),Su.enable(e),["touchstart","touchend"].forEach((function(t){e.addEventListener(t,Ou,{passive:!1})}));var c=cs("touchInput",e);c.hammer=a,us("touchInput",e,c)},disable:Lu},Au=Tt("segmentation");function Hu(e,t,n,a,o){!function(e,t,n){var a=Au.configuration,o=e.detail,r=_n(o.canvasContext.canvas),i=y.cornerstone.pixelToCanvas(o.element,{x:0,y:0}),l=y.cornerstone.pixelToCanvas(o.element,{x:o.image.width,y:0}),s=y.cornerstone.pixelToCanvas(o.element,{x:o.image.width,y:o.image.height}),c=y.cornerstoneMath.point.distance(i,l),u=y.cornerstoneMath.point.distance(l,s),d=o.canvasContext.canvas,f=o.viewport,h=r.imageSmoothingEnabled,v=r.globalAlpha;r.imageSmoothingEnabled=!1,r.globalAlpha=n?a.fillAlpha:a.fillAlphaInactive,function(e,t,n){if(n.hflip||n.vflip||n.rotation){var a={x:t.width/2+n.translation.x*n.scale,y:t.height/2+n.translation.y*n.scale};e.translate(a.x,a.y),n.rotation&&e.rotate(n.rotation*Math.PI/180),n.vflip&&e.scale(1,-1),n.hflip&&e.scale(-1,1),e.translate(-a.x,-a.y)}}(r,d,f);var g=function(e){var t=e.viewport,n=e.image,a=t.scale,o=t.scale;n.rowPixelSpacing<n.columnPixelSpacing?a*=n.columnPixelSpacing/n.rowPixelSpacing:n.columnPixelSpacing<n.rowPixelSpacing&&(o*=n.rowPixelSpacing/n.columnPixelSpacing);return{x:t.translation.x*a,y:t.translation.y*o}}(o);r.drawImage(t,d.width/2-c/2+g.x,d.height/2-u/2+g.y,c,u),r.globalAlpha=v,r.imageSmoothingEnabled=h,function(e){e.setTransform(1,0,0,1,0,0)}(r)}(e,function(e,t,n){var a=Au.state,o=e.detail.image,r=o.width,i=o.height,l=t.segmentsHidden,s=n.pixelData,c=a.colorLutTables[t.colorLUTIndex],u=document.createElement("canvas");u.width=r,u.height=i;for(var d=_n(u),f=new ImageData(r,i),h=f.data,v=0;v<s.length;v++){var g=s[v];if(0!==g&&!l[g]){var m=c[s[v]];h[4*v]=m[0],h[4*v+1]=m[1],h[4*v+2]=m[2],h[4*v+3]=m[3]}}return d.putImageData(f,0,0),u}(e,t,n),o)}var Uu=Tt("segmentation");function Bu(e,t,n,a,o){!function(e,t,n){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=Uu.configuration,r=Uu.state,i=e.detail,l=i.element,s=i.canvasContext,c=o.outlineWidth||1,u=_n(s.canvas),d=r.colorLutTables[n],f=u.globalAlpha;u.globalAlpha=a?o.outlineAlpha:o.outlineAlphaInactive,Wt(u,(function(e){for(var n=1;n<t.length;n++)if(t[n]){var a=d[n];fn(e,l,t[n],{color:"rgba(".concat(a[0],", ").concat(a[1],", ").concat(a[2],", 1.0 )"),lineWidth:c},"canvas")}})),u.globalAlpha=f}(e,function(e,t,n,a){var o=e.detail,r=o.element,i=o.image,l=o.viewport,s=i.width,c=i.height;a=a||1;var u=t.segmentsHidden,d=n.pixelData,f=t.activeSegmentIndex,h=[];n.segmentsOnLabelmap.forEach((function(e){!u[e]&&(h[e]=[])})),h[f]||(h[f]=[]);for(var v=function(e,t){var n=t/2,a=e.rotation;a*=Math.PI/180;var o=Math.cos(a),r=Math.sin(a),i=[o,r],l=[-r,o],s={x:n*i[0],y:n*i[1]},c={x:n*l[0],y:n*l[1]};e.hflip&&(s.x*=-1,s.y*=-1);e.vflip&&(c.x*=-1,c.y*=-1);return{i:s,j:c}}(l,a),g=0;g<d.length;g++){var m=d[g];if(0!==m)if(!u[m]){var p={x:(x=g)%s,y:Math.floor(x/s)},y=Nu(p,c,s);void 0!==y.top&&d[y.top]===m||zu(h[m],r,p,v),void 0!==y.bottom&&d[y.bottom]===m||Wu(h[m],r,p,v),void 0!==y.left&&d[y.left]===m||Gu(h[m],r,p,v),void 0!==y.right&&d[y.right]===m||Yu(h[m],r,p,v),void 0!==y.topLeft&&d[y.topLeft]!==m&&d[y.top]===m&&d[y.left]===m&&Fu(h[m],r,p,v),void 0!==y.topRight&&d[y.topRight]!==m&&d[y.top]===m&&d[y.right]===m&&Vu(h[m],r,p,v),void 0!==y.bottomLeft&&d[y.bottomLeft]!==m&&d[y.bottom]===m&&d[y.left]===m&&qu(h[m],r,p,v),void 0!==y.bottomRight&&d[y.bottomRight]!==m&&d[y.bottom]===m&&d[y.right]===m&&ju(h[m],r,p,v)}}var x;return h}(e,t,n,Uu.configuration.outlineWidth),t.colorLUTIndex,o)}function Nu(e,t,n){var a=e.y*n+e.x,o={},r=e.y-1>=0,i=e.y+1<t,l=e.x-1>=0,s=e.x+1<n;return r&&(o.top=a-n,s&&(o.topRight=o.top+1),l&&(o.topLeft=o.top-1)),i&&(o.bottom=a+n,s&&(o.bottomRight=o.bottom+1),l&&(o.bottomLeft=o.bottom-1)),l&&(o.left=a-1),s&&(o.right=a+1),o}function Fu(e,t,n,a){var o=(0,y.cornerstone.pixelToCanvas)(t,n);o.x+=a.j.x,o.y+=a.j.y;var r={x:o.x,y:o.y};r.x+=2*a.i.x,r.y+=2*a.i.y,e.push({start:o,end:r})}function Vu(e,t,n,a){var o=(0,y.cornerstone.pixelToCanvas)(t,{x:n.x+1,y:n.y});o.x+=a.j.x,o.y+=a.j.y;var r={x:o.x,y:o.y};r.x-=2*a.i.x,r.y-=2*a.i.y,e.push({start:o,end:r})}function qu(e,t,n,a){var o=(0,y.cornerstone.pixelToCanvas)(t,{x:n.x,y:n.y+1});o.x-=a.j.x,o.y-=a.j.y;var r={x:o.x,y:o.y};r.x+=2*a.i.x,r.y+=2*a.i.y,e.push({start:o,end:r})}function ju(e,t,n,a){var o=(0,y.cornerstone.pixelToCanvas)(t,{x:n.x+1,y:n.y+1});o.x-=a.j.x,o.y-=a.j.y;var r={x:o.x,y:o.y};r.x-=2*a.i.x,r.y-=2*a.i.y,e.push({start:o,end:r})}function zu(e,t,n,a){var o=y.cornerstone.pixelToCanvas,r=o(t,n),i=o(t,{x:n.x+1,y:n.y});r.x+=a.j.x,r.y+=a.j.y,i.x+=a.j.x,i.y+=a.j.y,e.push({start:r,end:i})}function Wu(e,t,n,a){var o=y.cornerstone.pixelToCanvas,r=o(t,{x:n.x,y:n.y+1}),i=o(t,{x:n.x+1,y:n.y+1});r.x-=a.j.x,r.y-=a.j.y,i.x-=a.j.x,i.y-=a.j.y,e.push({start:r,end:i})}function Gu(e,t,n,a){var o=y.cornerstone.pixelToCanvas,r=o(t,n),i=o(t,{x:n.x,y:n.y+1});r.x+=a.i.x,r.y+=a.i.y,i.x+=a.i.x,i.y+=a.i.y,e.push({start:r,end:i})}function Yu(e,t,n,a){var o=y.cornerstone.pixelToCanvas,r=o(t,{x:n.x+1,y:n.y}),i=o(t,{x:n.x+1,y:n.y+1});r.x-=a.i.x,r.y-=a.i.y,i.x-=a.i.x,i.y-=a.i.y,e.push({start:r,end:i})}var Xu=Tt("segmentation");function Ku(e,t,n,a,o){(function(e){var t=Xu.configuration;return t.renderFill&&(e&&0!==t.fillAlpha||!e&&0!==t.fillAlphaInactive)})(o)&&Hu(e,t,a,0,o),function(e){var t=Xu.configuration;return t.renderOutline&&(e&&0!==t.outlineAlpha||!e&&0!==t.outlineAlphaInactive)}(o)&&Bu(e,t,a,0,o)}var Zu=Tt("segmentation"),$u=function(e){var t=e.detail.element,n=Zu.configuration,a=Zu.getters.labelmaps3D(t),o=a.activeLabelmapIndex,r=a.labelmaps3D,i=a.currentImageIdIndex;r&&(n.shouldRenderInactiveLabelmaps&&function(e,t,n,a){for(var o=0;o<t.length;o++){var r=t[o];if(o!==n&&r){var i=r.labelmaps2D[a];i&&Ku(e,r,0,i,!1)}}}(e,r,o,i),function(e,t,n,a){var o=t[n];if(!o)return;var r=o.labelmaps2D[a];r&&Ku(e,o,0,r,!0)}(e,r,o,i))};var Ju=Tt("segmentation"),Qu=function(e){var t=e.detail,n=t.element,a=pt.tools.filter((function(e){return e.element===n&&("active"===e.mode||"passive"===e.mode||"enabled"===e.mode)})),o=O(n,"stack"),r=Ju.configuration;o&&(r.renderFill||r.renderOutline)&&$u(e);var i=t.canvasContext.canvas.getContext("2d");a.forEach((function(t){t.renderToolData&&(i.save(),t.renderToolData(e),i.restore())}))},ed=function(e){e.addEventListener(y.cornerstone.EVENTS.IMAGE_RENDERED,Qu)},td=function(e){e.removeEventListener(y.cornerstone.EVENTS.IMAGE_RENDERED,Qu)},nd=function(e,t,n){if(pt.isToolLocked)return!1;var a=n.detail.element,o=pt.tools.filter((function(t){return t.supportedInteractionTypes.includes(e)}));if(o=(o=Ma(a,o,e)).filter((function(e){return"function"==typeof e[t]})),pt.isMultiPartToolActive&&(o=Pa(o)),0===o.length)return!1;o[0][t](n)},ad=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse";return t.filter((function(t){for(var o=so(a,t.name),r=O(e,t.name),i=0;i<r.data.length;i++)if(void 0!==pa(e,r.data[i].handles,n,o))return!0;return!1}))},od=function(e,t){return t.filter((function(t){return t.element===e&&("active"===t.mode||"passive"===t.mode)}))},rd=function(e,t){return t.filter((function(t){var n=O(e,t.name);return n&&n.data.length>0}))},id=function(e){if(!pt.isToolLocked){var t=e.detail,n=e.detail.element,a=e.detail.currentPoints.canvas,o=od(n,yt.mouseTools()),r=o.filter((function(e){return"active"===e.mode&&Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.includes(t.buttons)&&e.options.isMouseActive}));if(pt.isMultiPartToolActive&&(r=Pa(r)),r.length>0){var i=r.find((function(e){return"function"==typeof e.preMouseDownCallback}));if(i)if(i.preMouseDownCallback(e))return}if(!pt.isMultiPartToolActive){var l=rd(n,o),s=ad(n,l,a,"mouse");if(s.length>0){var c=s[0],u=O(n,c.name),d=ho(n,u,c.name,a),f=d.handle,h=d.data;c.handleSelectedCallback(e,h,f,"mouse")}else{var v=o.filter((function(e){var t=O(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some((function(t){return e.pointNearTool(n,t,a,"mouse")}))}));if(v.length>0){var g=v[0],m=O(n,g.name).data.find((function(e){return g.pointNearTool(n,e,a)}));g.toolSelectedCallback(e,m,"mouse")}else if(r.length>0){var p=r.find((function(e){return"function"==typeof e.postMouseDownCallback}));if(p)if(p.postMouseDownCallback(e))return}}}}},ld=B("eventDispatchers:mouseEventHandlers"),sd=function(e){if(!pt.isToolLocked){var t=e.detail,n=Da(t.element,t.buttons,"mouse");if(n){if("function"==typeof n.preMouseDownActivateCallback)if(n.preMouseDownActivateCallback(e))return;pt.isMultiPartToolActive||(n.addNewMeasurement?n.addNewMeasurement(e,"mouse"):n instanceof po&&function(e,t){ld.log("addNewMeasurement"),e.preventDefault(),e.stopPropagation();var n=e.detail,a=n.element,o=t.createNewMeasurement(n);o&&(D(a,t.name,o),y.cornerstone.updateImage(a),(1===Object.keys(o.handles).length?Ga:no)(n,t.name,o,o.handles.end,t.options,"mouse",(function(e){if(!o.cancelled)if(e){var n=b.MEASUREMENT_COMPLETED,r={toolName:t.name,toolType:t.name,element:a,measurementData:o};C(a,n,r)}else L(a,t.name,o)})))}(e,n))}}},cd=function(e){if(!pt.isToolLocked){var t,n=e.detail,a=n.element;if(t=(t=(t=Ma(a,yt.mouseTools())).filter((function(e){return Array.isArray(e.options.mouseButtonMask)&&e.options.mouseButtonMask.includes(n.buttons)&&e.options.isMouseActive}))).filter((function(e){return"function"==typeof e.mouseDragCallback})),pt.isMultiPartToolActive&&(t=Pa(t)),0!==t.length)t[0].mouseDragCallback(e)}},ud=function(e){if(!pt.isToolLocked&&!pt.isMultiPartToolActive){var t,n=e.detail,a=n.element,o=n.currentPoints;pt.mousePositionImage=o.image;var r=(t=od(a,yt.mouseTools())).filter((function(e){return"active"===e.mode&&e.options.isMouseActive})),i=!1;r.length>0&&(i=r.some((function(e){return e.updateOnMouseMove}))),t=rd(a,t);for(var l=0;l<t.length;l++){var s=t[l];"function"==typeof s.mouseMoveCallback&&(i=s.mouseMoveCallback(e)||i)}!0===i&&y.cornerstone.updateImage(a)}},dd=nd.bind(null,"Mouse","mouseClickCallback"),fd=nd.bind(null,"Mouse","doubleClickCallback"),hd=nd.bind(null,"Mouse","mouseUpCallback"),vd=nd.bind(null,"MouseWheel","mouseWheelCallback"),gd=function(e){e.addEventListener(b.MOUSE_CLICK,dd),e.addEventListener(b.MOUSE_DOWN,id),e.addEventListener(b.MOUSE_DOWN_ACTIVATE,sd),e.addEventListener(b.MOUSE_DOUBLE_CLICK,fd),e.addEventListener(b.MOUSE_DRAG,cd),e.addEventListener(b.MOUSE_MOVE,ud),e.addEventListener(b.MOUSE_UP,hd),e.addEventListener(b.MOUSE_WHEEL,vd)},md=function(e){e.removeEventListener(b.MOUSE_CLICK,dd),e.removeEventListener(b.MOUSE_DOWN,id),e.removeEventListener(b.MOUSE_DOWN_ACTIVATE,sd),e.removeEventListener(b.MOUSE_DOUBLE_CLICK,fd),e.removeEventListener(b.MOUSE_DRAG,cd),e.removeEventListener(b.MOUSE_MOVE,ud),e.removeEventListener(b.MOUSE_UP,hd),e.removeEventListener(b.MOUSE_WHEEL,vd)},pd=function(e){if(pt.isToolLocked)return!1;var t=e.detail.element,n=pt.tools.filter((function(e){return e.element===t&&("active"===e.mode||"passive"===e.mode||"enabled"===e.mode)}));if(0===n.length)return!1;n.forEach((function(t){t.newImageCallback&&t.newImageCallback(e)}))},yd=function(e){e.addEventListener(y.cornerstone.EVENTS.NEW_IMAGE,pd)},xd=function(e){e.removeEventListener(y.cornerstone.EVENTS.NEW_IMAGE,pd)},Td=function(e){if(pt.isToolLocked)return!1;var t=e.detail,n=t.element,a=t.numPointers,o=pt.tools.filter((function(e){return e.supportedInteractionTypes.includes("MultiTouch")}));if(o=(o=Ma(n,o,"MultiTouch")).filter((function(e){return"function"==typeof e.multiTouchDragCallback&&a===e.configuration.touchPointers})),pt.isMultiPartToolActive&&(o=Pa(o)),0===o.length)return!1;o[0].multiTouchDragCallback(e)},bd=B("eventDispatchers:touchEventHandlers"),Cd=function(e){if(!pt.isToolLocked&&!pt.isMultiPartToolActive){var t=Da(e.detail.element,null,"touch");t&&t.addNewMeasurement?t.addNewMeasurement(e,"touch"):t instanceof po&&function(e,t){bd.log("addNewMeasurement"),e.preventDefault(),e.stopPropagation();var n=e.detail,a=n.element,o=t.createNewMeasurement(n);if(o){if(D(a,t.name,o),1===Object.keys(o.handles).length&&n.type===b.TAP)return o.active=!1,o.handles.end.active=!1,o.handles.end.highlight=!1,o.invalidated=!0,(pt.deleteIfHandleOutsideImage||t.options.deleteIfHandleOutsideImage)&&ba(n,o.handles)&&L(a,t.name,o),void y.cornerstone.updateImage(a);y.cornerstone.updateImage(a),no(n,t.name,o,o.handles.end,t.options,"touch",(function(){var e=b.MEASUREMENT_COMPLETED,n={toolName:t.name,toolType:t.name,element:a,measurementData:o};C(a,e,n)}))}}(e,t)}},Md=function(e){if(e)for(var t=0;t<e.data.length;t++){var n=e.data[t];n.active=!1,n.handles&&Ed(n.handles)}};function Ed(e){Object.keys(e).forEach((function(t){e[t].active=!1}))}var wd=function(e){if(!pt.isToolLocked&&!pt.isMultiPartToolActive){var t,n=e.detail.element,a=e.detail.currentPoints.canvas;t=Ma(n,yt.touchTools());var o=(t=rd(n,t)).filter((function(e){for(var t=O(n,e.name),o=0;o<t.data.length;o++)if(void 0!==pa(n,t.data[o].handles,a,28))return!0;return!1}));if(o.length>0){var r=o[0],i=O(n,r.name),l=i.data.find((function(e){return void 0!==pa(n,e.handles,a,28)}));return i.data.active=!0,l.active=!0,y.cornerstone.updateImage(n),Ga(e.detail,r.name,i.data,l,r.options,"touch",(function(){return Md(i)})),e.stopImmediatePropagation(),void e.preventDefault()}var s=t.filter((function(e){var t=O(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some((function(t){return e.pointNearTool(n,t,a)}))}));if(s.length>0){var c=s[0],u=O(n,c.name),d=u.data.find((function(e){return c.pointNearTool(n,e,a)}));return d.active=!0,y.cornerstone.updateImage(n),Ha(e.detail,c.name,d,null,c.options,"touch",(function(){return Md(u)})),e.stopImmediatePropagation(),void e.preventDefault()}var f=Ma(n,yt.touchTools());return f.length>0&&f[0].touchStartActiveCallback?f[0].touchStartActiveCallback(e):Cd(e),!1}},Id=function(e){if(!pt.isToolLocked){var t=e.detail,n=t.element,a=t.startPoints.canvas,o=od(n,yt.touchTools()),r=o.filter((function(e){return"active"===e.mode&&e.options.isTouchActive}));if(pt.isMultiPartToolActive&&(r=Pa(r)),r.length>0){var i=r.find((function(e){return"function"==typeof e.preTouchStartCallback}));if(i)if(i.preTouchStartCallback(e))return}if(!pt.isMultiPartToolActive){var l=rd(n,o),s=ad(n,l,a,"touch");if(s.length>0){var c=s[0],u=O(n,c.name),d=ho(n,u,c.name,a,"touch"),f=d.handle,h=d.data;c.handleSelectedCallback(e,h,f,"touch")}else{var v=l.filter((function(e){var t=O(n,e.name);return t&&t.data&&e.pointNearTool&&t.data.some((function(t){return e.pointNearTool(n,t,a,"touch")}))}));if(v.length>0){var g=v[0],m=O(n,g.name).data.find((function(e){return g.pointNearTool(n,e,a)}));g.toolSelectedCallback(e,m,"touch")}else if(r.length>0){var p=r.find((function(e){return"function"==typeof e.postTouchStartCallback}));if(p)if(p.postTouchStartCallback(e))return}}}}},Sd=nd.bind(null,"DoubleTap","doubleTapCallback"),kd=nd.bind(null,"Touch","touchDragCallback"),_d=nd.bind(null,"Touch","touchEndCallback"),Pd=nd.bind(null,"TouchPinch","touchPinchCallback"),Dd=nd.bind(null,"Touch","touchPressCallback"),Od=nd.bind(null,"TouchRotate","touchRotateCallback"),Ld=function(e){e.addEventListener(b.TAP,wd),e.addEventListener(b.TOUCH_START,Id,{passive:!1}),e.addEventListener(b.TOUCH_DRAG,kd,{passive:!1}),e.addEventListener(b.TOUCH_END,_d),e.addEventListener(b.TOUCH_START_ACTIVE,Cd),e.addEventListener(b.TOUCH_PRESS,Dd),e.addEventListener(b.DOUBLE_TAP,Sd),e.addEventListener(b.TOUCH_PINCH,Pd),e.addEventListener(b.TOUCH_ROTATE,Od),e.addEventListener(b.MULTI_TOUCH_DRAG,Td)},Rd=function(e){e.removeEventListener(b.TAP,wd),e.removeEventListener(b.TOUCH_START,Id),e.removeEventListener(b.TOUCH_DRAG,kd),e.removeEventListener(b.TOUCH_END,_d),e.removeEventListener(b.TOUCH_START_ACTIVE,Cd),e.removeEventListener(b.TOUCH_PRESS,Dd),e.removeEventListener(b.DOUBLE_TAP,Sd),e.removeEventListener(b.TOUCH_PINCH,Pd),e.removeEventListener(b.TOUCH_ROTATE,Od),e.removeEventListener(b.MULTI_TOUCH_DRAG,Td)},Ad=B("addTool"),Hd=function(e,t,n){var a=new t(n);Ct(e,a.name)?Ad.warn("%s has already been added to the target element",a.name):(a.element=e,bt.state.tools.push(a))},Ud=function(e,t){Bd(e,t),bt.state.enabledElements.forEach((function(n){Hd(n,e,t)}))},Bd=function(e,t){if(Tt("globalConfiguration").configuration.globalToolSyncEnabled){var n=new e(t);void 0!==bt.state.globalTools[n.name]?Ad.warn("%s has already been added globally",n.name):bt.state.globalTools[n.name]={tool:e,props:t,activeBindings:[]}}},Nd=B("internals:addEnabledElement"),Fd=function(e){Nd.log("EVENT:ELEMENT_ENABLED");var t=e.detail.element;ed(t),yd(t);var n=Tt("globalConfiguration").configuration;n.mouseEnabled&&(nu.enable(t),lu.enable(t),gd(t)),n.touchEnabled&&(Ru.enable(t),Ld(t)),Vd(t)},Vd=function(e){bt.state.enabledElements.push(e),bt.modules&&function(e){var t=bt.modules;Object.keys(t).forEach((function(n){"function"==typeof t[n].enabledElementCallback&&t[n].enabledElementCallback(e)}))}(e),function(e){if(!Tt("globalConfiguration").configuration.globalToolSyncEnabled)return;Object.keys(bt.state.globalTools).forEach((function(t){var n=bt.state.globalTools[t],a=n.tool,o=n.props;Hd(e,a,o)}))}(e),function(e){if(!Tt("globalConfiguration").configuration.globalToolSyncEnabled)return;var t={active:_t,passive:At,enabled:Lt,disabled:Dt};bt.state.globalToolChangeHistory.forEach((function(n){var a=n.args.slice(0);a.unshift(e),t[n.mode].apply(null,a)}))}(e)};var qd=B("internals:removeEnabledElement"),jd=function(e){qd.log("EVENT:ELEMENT_DISABLED");var t=e.detail.element,n=Tt("globalConfiguration").configuration;td(t),xd(t),n.mouseEnabled&&(nu.disable(t),lu.disable(t),md(t)),n.touchEnabled&&(Ru.disable(t),Rd(t)),zd(t),Wd(t),Gd(t)},zd=function(e){bt.state.tools.forEach((function(t){t.element===e&&Dt(t.element,t.name)})),bt.state.tools=bt.state.tools.filter((function(t){return t.element!==e}))},Wd=function(e){bt.modules&&function(e){var t=bt.modules;Object.keys(t).forEach((function(n){"function"==typeof t[n].removeEnabledElementCallback&&t[n].removeEnabledElementCallback(e)}))}(e);var t=bt.state.enabledElements.findIndex((function(t){return t===e}));t>-1?bt.state.enabledElements.splice(t,1):qd.warn("unable to remove element")},Gd=function(e){ls.removeHandlers(e)};var Yd,Xd=function(){window.removeEventListener("resize",Kd,!1)};function Kd(){Yd||(Yd=setTimeout((function(){Yd=null,Zd()}),66))}var Zd=function(){pt.enabledElements.forEach((function(e){y.cornerstone.resize(e)}))},$d=function(){Xd(),window.addEventListener("resize",Kd,!1)},Jd=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Qd(),ef();var t=Tt("globalConfiguration");Array.isArray(e)?e.forEach((function(e){var t=e.moduleName,n=e.configuration,a=Tt(t);a&&(a.configuration=Object.assign({},a.configuration,n))})):t.configuration=Object.assign({},t.configuration,e),t.configuration.autoResizeViewports&&$d()};function Qd(){!function(){var e=y.cornerstone,t=e.EVENTS.ELEMENT_ENABLED,n=e.EVENTS.ELEMENT_DISABLED;e.events.removeEventListener(t,Fd),e.events.removeEventListener(n,jd)}();var e=y.cornerstone,t=e.EVENTS.ELEMENT_ENABLED,n=e.EVENTS.ELEMENT_DISABLED;e.events.addEventListener(t,Fd),e.events.addEventListener(n,jd)}function ef(){var e=bt.modules;Object.keys(e).forEach((function(t){"function"==typeof e[t].onRegisterCallback&&e[t].onRegisterCallback()}))}var tf,nf=B("stackTools:stackPrefetch"),af={maxImagesToPrefetch:1/0,preserveExistingPool:!1};function of(e,t){e=Math.round(e)||0;var n=[],a=(t=Math.round(t)||0)-e+1;if(a<=0)return n;for(;a--;)n[a]=t--;return n}function rf(e){var t=O(e,"stack");if(t&&t.data&&t.data.length){var n=t.data[0],a=O(e,"stackPrefetch");if(a){var o=a.data[0]||{};if(o.indicesToRequest&&o.indicesToRequest.length||(o.enabled=!1),!1!==o.enabled)if(a.data[0].indicesToRequest.sort((function(e,t){return e-t})),o.indicesToRequest.slice().forEach((function(e){var t=n.imageIds[e];t&&(y.cornerstone.imageCache.getImageLoadObject(t)&&b(e))})),o.indicesToRequest.length){af.preserveExistingPool||y.cornerstone.imageLoadPoolManager.clearRequestStack("prefetch");for(var r,i,l,s,c,u,d,f=(r=o.indicesToRequest,i=n.currentImageIdIndex,l=0,s=r.length-1,r.forEach((function(e,t){e<i?l=Math.max(t,l):e>i&&(s=Math.min(t,s))})),{low:l,high:s}),h=(ls.getErrorLoadingHandler(e),f.low),v=f.high,g=[];h>=0||v<o.indicesToRequest.length;){var m=n.currentImageIdIndex,p=!(m-o.indicesToRequest[h]>af.maxImagesToPrefetch)&&h>=0,x=!(o.indicesToRequest[v]-m>af.maxImagesToPrefetch)&&v<o.indicesToRequest.length;if(!x&&!p)break;p&&(u=o.indicesToRequest[h--],c=n.imageIds[u],g.push(c)),x&&(u=o.indicesToRequest[v++],c=n.imageIds[u],g.push(c))}var T={addToBeginning:!0,priority:0,requestType:"prefetch"};d=function(e){return y.cornerstone.loadAndCacheImage(e,T)},g.reverse().forEach((function(e){y.cornerstone.imageLoadPoolManager.addRequest(d.bind(null,e),"prefetch",{imageId:e},0,!0)}))}}}function b(e){var t=o.indicesToRequest.indexOf(e);t>-1&&o.indicesToRequest.splice(t,1)}}function lf(e){return function(t){var n,a=t.detail;try{n=O(e,"stack")}catch(e){return}if(n&&n.data&&n.data.length){var o=n.data[0].imageIds.indexOf(a.imageId);if(!(o<0)){var r=O(e,"stackPrefetch");r&&r.data&&r.data.length&&r.data[0].indicesToRequest.push(o)}}}}function sf(e){clearTimeout(tf),tf=setTimeout((function(){var t=e.target;try{rf(t)}catch(e){return}}),10)}var cf={enable:function(e){O(e,"stackPrefetch").data=[];var t=O(e,"stack");if(t&&t.data&&t.data.length){var n=t.data[0];if(!0!==n.preventCache){var a={indicesToRequest:of(0,n.imageIds.length-1),enabled:!0,direction:1},o=a.indicesToRequest.indexOf(n.currentImageIdIndex);a.indicesToRequest.splice(o,1),D(e,"stackPrefetch",a),rf(e),e.removeEventListener(y.cornerstone.EVENTS.NEW_IMAGE,sf),e.addEventListener(y.cornerstone.EVENTS.NEW_IMAGE,sf);var r=lf(e);y.cornerstone.events.removeEventListener(y.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,r),y.cornerstone.events.addEventListener(y.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,r)}else nf.warn("A stack that should not be cached was given the stackPrefetch")}},disable:function(e){clearTimeout(tf),e.removeEventListener(y.cornerstone.EVENTS.NEW_IMAGE,sf);var t=lf(e);y.cornerstone.events.removeEventListener(y.cornerstone.EVENTS.IMAGE_CACHE_PROMISE_REMOVED,t);var n=O(e,"stackPrefetch");n&&n.data.length&&(n.data[0].enabled=!1,y.cornerstone.imageLoadPoolManager.clearRequestStack("prefetch"))},getConfiguration:function(){return af},setConfiguration:function(e){af=e}},uf=function(){function e(){i()(this,e),this.currentImageIdIndex=0,this.layerIds=[],this.findImageFn=void 0}return s()(e,[{key:"render",value:function(e,t){var n=this;if(!Number.isInteger(this.currentImageIdIndex))throw new Error("FusionRenderer: render - Image ID Index is not an integer");if(!this.findImageFn)throw new Error("No findImage function has been defined");t||(t=O(e,"stack").data);var a=y.cornerstone,o=t[0],r=o.imageIds[this.currentImageIdIndex],i=t.slice(1,t.length);a.loadAndCacheImage(r).then((function(t){var l=n.layerIds[0];l?a.setLayerImage(e,t,l):(l=a.addLayer(e,t,o.options),n.layerIds.push(l)),a.displayImage(e,t),i.forEach((function(t,o){var i=n.findImageFn(t.imageIds,r),s=o+1,c=n.layerIds[s];c||(c=a.addLayer(e,void 0,t.options),n.layerIds.push(c)),i?a.loadAndCacheImage(i).then((function(t){a.setLayerImage(e,t,c),a.updateImage(e)})):(a.setLayerImage(e,void 0,c),a.setActiveLayer(e,l),a.updateImage(e))}))}))}}]),e}(),df={};df.FusionRenderer=uf;var ff=df;function hf(e){var t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}function vf(e,t){var n,a;if(void 0===e)throw new Error("playClip: element must not be undefined");var o=O(e,"stack");if(o&&o.data&&o.data.length){var r,i=y.cornerstone;if(o.data.length>1){var l=O(e,"stackRenderer");l&&l.data&&l.data.length&&(r=l.data[0])}var s=o.data[0],c=O(e,"playClip");c&&c.data&&c.data.length?hf(n=c.data[0]):D(e,"playClip",n={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,frameRate:0,frameTimeVector:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,speed:1,reverse:!1,loop:!0}),(t<0||t>0)&&(n.framesPerSecond=Number(t),n.reverse=n.framesPerSecond<0,n.ignoreFrameTimeVector=!0),!0!==n.ignoreFrameTimeVector&&n.frameTimeVector&&n.frameTimeVector.length===s.imageIds.length&&(a=function(e,t){var n,a,o,r=0,i=e.length,l=[];for(l.isTimeVarying=!1,("number"!=typeof t||t<=0)&&(t=1),n=1;n<i;n++)o=Number(e[n])/t|0,l.push(o),1===n?a=o:o!==a&&(l.isTimeVarying=!0),r+=o;return l.length>0&&(o=l.isTimeVarying?r/l.length|0:l[0],l.push(o)),l}(n.frameTimeVector,n.speed));var u=function(){var t,a,l,c=s.currentImageIdIndex,u=s.imageIds.length;if(n.reverse?c--:c++,!n.loop&&(c<0||c>=u))return hf(n),void function(e){var t={element:e};C(e,b.CLIP_STOPPED,t)}(e);c>=u&&(c=0),c<0&&(c=u-1),c!==s.currentImageIdIndex&&(t=ls.getStartLoadHandler(e),a=ls.getEndLoadHandler(e),l=ls.getErrorLoadingHandler(e),t&&t(e),(!0===s.preventCache?i.loadImage(s.imageIds[c]):i.loadAndCacheImage(s.imageIds[c])).then((function(t){try{s.currentImageIdIndex=c,r?(r.currentImageIdIndex=c,r.render(e,o.data)):i.displayImage(e,t),a&&a(e,t)}catch(e){return}}),(function(t){var n=s.imageIds[c];l&&l(e,n,t)})))};a&&a.length>0&&a.isTimeVarying?(n.usingFrameTimeVector=!0,n.intervalId=setTimeout((function e(){n.intervalId=setTimeout(e,a[s.currentImageIdIndex]),u()}),0)):(n.usingFrameTimeVector=!1,n.intervalId=setInterval(u,1e3/Math.abs(n.framesPerSecond)))}}function gf(e){var t=O(e,"playClip");t&&t.data&&t.data.length&&hf(t.data[0])}var mf=function(e,t){var n=bt.state.tools.findIndex((function(n){return n.element===e&&n.name===t}));n>=0&&bt.state.tools.splice(n,1)},pf=function(e){yf(e),bt.state.enabledElements.forEach((function(t){mf(t,e)}))},yf=function(e){Tt("globalConfiguration").configuration.globalToolSyncEnabled&&bt.state.globalTools[e]&&delete bt.state.globalTools[e]},xf=function(e,t,n){var a=Ct(e,t);a&&a.mergeOptions(n)},Tf=function(e,t){pt.enabledElements.forEach((function(n){xf(n,e,t)}))};function bf(e,t){var n={};return{get:function(a,o){return e.indexOf(o)>=0?(!1===n.hasOwnProperty(o)&&(n[o]={data:[]}),n[o]):t.get(a,o)},add:function(a,o,r){if(!(e.indexOf(o)>=0))return t.add(a,o,r);!1===n.hasOwnProperty(o)&&(n[o]={data:[]}),n[o].data.push(r)},saveToolState:function(){return n},restoreToolState:function(e){n=e},toolState:n}}var Cf=[];function Mf(e,t){var n=P(e);n||(n=_);var a=["stack","stackPrefetch","playClip","volume","slab","referenceLines","crosshairs","stackRenderer"];t&&(a=a.concat(t));var o=bf(a,n);Cf.push(o),A(e,o)}var Ef={newStackSpecificToolStateManager:bf,addStackStateManager:Mf};function wf(){var e={};return{get:function(t,n){if(!1!==e.hasOwnProperty(t)){var a=e[t];if(!1!==a.hasOwnProperty(n))return a[n]}},add:function(t,n,a){!1===e.hasOwnProperty(t)&&(e[t]={});var o=e[t];!1===o.hasOwnProperty(n)&&(o[n]={data:[]}),o[n].data.push(a)},remove:function(t,n,a){if(!1!==e.hasOwnProperty(t)){var o=e[t];if(!1!==o.hasOwnProperty(n)){for(var r=o[n],i=-1,l=0;l<r.data.length;l++)r.data[l]===a&&(i=l);-1!==i&&r.data.splice(i,1)}}}}}var If=wf(),Sf=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"image/png",a=e.querySelector("canvas");if(a.msToBlob){var o=a.msToBlob();return window.navigator.msSaveBlob(o,t)}var r=document.createElement("a");if(r.download=t,r.href=a.toDataURL(n,1),document.createEvent){var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(i)}else r.fireEvent&&r.fireEvent("onclick")},kf=B("thirdParty:registerModule"),_f=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=Pf(e);!a||n?(a&&kf.warn("Overwriting module %s",e),xt[e]=t,"function"==typeof xt[e].onRegisterCallback&&xt[e].onRegisterCallback()):kf.warn("A module with the name %s is already registered",e)};function Pf(e){return void 0!==xt[e]}function Df(){var e,t=navigator.userAgent,n=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(e=/\brv[ :]+(\d+)/g.exec(t)||[],"IE ".concat(e[1]||"")):"Chrome"===n[1]&&null!==(e=t.match(/\b(OPR|Edge)\/(\d+)/))?e.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(e=t.match(/version\/(\d+)/i))&&n.splice(1,1,e[1]),n.join(" "))}var Of={"base/BaseTool":va,"base/BaseAnnotationTool":po,"base/BaseBrushTool":_a,"tools/cursors/MouseCursor":bo,"tools/cursors":o,"manipulators/anyHandlesOutsideImage":ba,"manipulators/getHandleNearImagePoint":pa,"manipulators/getHandlePixelPosition":Ca,"manipulators/handleActivator":ya,"manipulators/moveAllHandles":Ha,"manipulators/moveHandle":Ga,"manipulators/moveNewHandle":no,"manipulators/moveHandleNearImagePoint":fo,"manipulators/findHandleDataNearImagePoint":ho,"manipulators/moveAnnotation":vo,"mixins/activeOrDisabledBinaryTool":ra.activeOrDisabledBinaryTool,"mixins/enabledOrDisabledBinaryTool":ra.enabledOrDisabledBinaryTool,"drawing/getNewContext":_n,"drawing/draw":Wt,"drawing/path":Kt,"drawing/setShadow":Dn,"drawing/drawLine":Zt,"drawing/drawLines":fn,"drawing/drawJoinedLines":$t,"drawing/drawCircle":Qt,"drawing/drawEllipse":rn,"drawing/drawRect":kn,"drawing/fillOutsideRect":function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"pixel";if("pixel"===r){var i=y.cornerstone;n=i.pixelToCanvas(t,n),a=i.pixelToCanvas(t,a)}var l=Math.min(n.x,a.x),s=Math.min(n.y,a.y),c=Math.abs(n.x-a.x),u=Math.abs(n.y-a.y);Kt(e,o,(function(e){e.rect(0,0,e.canvas.clientWidth,e.canvas.clientHeight),e.rect(l+c,s,-c,u)}))},"drawing/drawTextBox":bn,"drawing/drawArrow":Jt,"drawing/fillBox":xn,"drawing/fillTextLines":yn,"drawing/drawLink":hn,"drawing/drawLinkedTextBox":Sn,"drawing/drawHandles":dn,"drawing/textBoxWidth":Tn,"util/getActiveTool":Da,"util/getLuminance":Tc,"util/getROITextBoxCoords":li,"util/copyPoints":zc,"util/calculateSUV":ni,"util/setContextToDisplayFontSize":function(e,t,n){return y.cornerstone.setToPixelCoordinateSystem(e,t,.1),{fontSize:n/e.viewport.scale/.1,lineHeight:n/e.viewport.scale/.1,fontScale:.1}},"util/scrollToIndex":dc,"util/scroll":fc,"util/roundToDecimal":xo,"util/projectPatientPointToImagePlane":tn,"util/imagePointToPatientPoint":nn,"util/planePlaneIntersection":an,"util/pointInsideBoundingBox":ga,"util/makeUnselectable":function(e,t){e.style.webkitUserSelect="none",e.style.webkitTouchCallout="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.oUserSelect="none",e.style.khtmlUserSelect="none",e.style.userSelect="none",e.unselectable="on",e.oncontextmenu=function(){return!1},!0===t&&(e.style.pointerEvents="none")},"util/getRGBPixels":Ji,"util/getBrowserInfo":Df,"util/isMobileDevice":function(){return new RegExp("Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini").test(navigator.userAgent)},"util/angleBetweenPoints":$s,"util/numbersWithCommas":si,"util/lineSegDistance":yo,"util/triggerEvent":C,"util/convertToVector3":en,"util/clip":Cn,"util/clipToBox":Mn,"util/clipBoxToDisplayedArea":wn,"util/debounce":cr,"util/deepmerge":da,"util/getDefault":Pn,"util/getProximityThreshold":so,"util/getPixelSpacing":lr,"util/isEmptyObject":On,"util/isObject":sr,"util/isPointInImage":Ge,"util/isPointInPolygon":El,"util/getLogger":B,"util/throttle":ur,"util/wait":Gs,"util/waitForEnabledElementImageToLoad":Ys,"util/getKeyPressData":function(e){var t=y.cornerstone,n=e.currentTarget,a=t.getEnabledElement(n);if(a&&a.image){var o=bt.state.mousePositionImage;return{event:window.event||e,element:n,viewport:t.getViewport(n),image:a.image,currentPoints:{image:o,canvas:t.pixelToCanvas(n,o)},keyCode:e.keyCode,which:e.which}}},"util/ellipseUtils":ii,"util/freehandUtils":Ni,"util/segmentationUtils":a,"util/zoomUtils":Pc},Lf=B("thirdParty:registerMixin"),Rf=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=Af(e);!a||n?(a&&Lf.warn("Overwriting mixins/%s",e),ra[e]=t,Of["mixins/".concat(e)]=ra[e]):Lf.warn("mixins/%s is already registered",e)};function Af(e){return void 0!==ra[e]}var Hf=B("thirdParty:registerType"),Uf=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o="".concat(e,"/").concat(t),r=Bf(o);!r||a?(r&&Hf.warn("Overwriting %s",o),Of[o]=n):Hf.warn("%s is already registered",o)};function Bf(e){return void 0!==Of[e]}var Nf=B("thirdParty:register"),Ff=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(Vf(e,t,n))switch(e){case"module":_f(t,n,a);break;case"mixin":Rf(t,n,a);break;default:Uf(e,t,n,a)}};function Vf(e,t,n){return e?t?"object"===T()(n)||"function"==typeof n||(Nf.warn("The %s is a %s, it should be an Object or a function.",n,T()(n)),!1):(Nf.warn("The %s must have a name in order to register.",e),!1):(Nf.warn("The type must be given in order to register."),!1)}var qf=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.forEach((function(e){var n=e.type,a=e.name,o=e.item;Ff(n,a,o,t)}))},jf=function(e,t,n){if(n!==t){var a=y.cornerstone,o=a.getViewport(t),r=a.getViewport(n);r.voi.windowWidth===o.voi.windowWidth&&r.voi.windowCenter===o.voi.windowCenter&&r.invert===o.invert||(r.voi.windowWidth=o.voi.windowWidth,r.voi.windowCenter=o.voi.windowCenter,r.invert=o.invert,e.setViewport(n,r))}},zf=function(e,t,n){n!==t&&y.cornerstone.updateImage(n)};function Wf(e){return e.filter((function(e,t,n){return n.indexOf(e)===t}))}var Gf=function(e,t){y.cornerstone;var n=this,a=[],o=[],r=!1,i={},l=t;function s(e){var t=e.detail.element;n.remove(t),function(e){for(var t in ss)ss[t]=ss[t].filter((function(t){return t.element!==e}))}(t)}this.enabled=!0,this.setHandler=function(e){l=e},this.getHandler=function(){return l},this.getDistances=function(){if(a.length&&o.length){var e=y.cornerstone;i.distances={},i.imageIds={sourceElements:[],targetElements:[]},a.forEach((function(t){var n=e.getEnabledElement(t);if(n&&n.image){var a=n.image.imageId,r=e.metaData.get("imagePlaneModule",a);if(r&&r.imagePositionPatient){var l=en(r.imagePositionPatient);i.hasOwnProperty(n)||(i.distances[a]={},i.imageIds.sourceElements.push(a),o.forEach((function(n){var o=e.getEnabledElement(n);if(o&&o.image){var r=o.image.imageId;if(i.imageIds.targetElements.push(r),t!==n&&a!==r&&!i.distances[a].hasOwnProperty(r)){var s=e.metaData.get("imagePlaneModule",r);if(s&&s.imagePositionPatient){var c=en(s.imagePositionPatient);i.distances[a][r]=c.clone().sub(l)}}}})),Object.keys(i.distances[a]).length||delete i.distances[a])}}}))}},this.fireEvent=function(e,t){var s=!n.enabled,c=!a.length||!o.length;s||c||(r=!0,o.forEach((function(r){var s=o.indexOf(r);if(-1!==s){var c=i.imageIds.targetElements[s],u=a.indexOf(e);if(-1!==u){var d,f=i.imageIds.sourceElements[u];f===c?d=0:void 0!==i.distances[f]&&(d=i.distances[f][c]),l(n,e,r,t,d)}}})),r=!1)},this.onEvent=function(e){var t=e.detail;!0!==r&&n.fireEvent(e.currentTarget,t)},this.addSource=function(t){-1===a.indexOf(t)&&(a.push(t),e.split(" ").forEach((function(e){t.addEventListener(e,n.onEvent)})),n.getDistances(),n.updateDisableHandlers())},this.addTarget=function(e){-1===o.indexOf(e)&&(o.push(e),n.getDistances(),l(n,e,e,0),n.updateDisableHandlers())},this.add=function(e){n.addSource(e),n.addTarget(e)},this.removeSource=function(t){var o=a.indexOf(t);-1!==o&&(a.splice(o,1),e.split(" ").forEach((function(e){t.removeEventListener(e,n.onEvent)})),n.getDistances(),n.fireEvent(t),n.updateDisableHandlers())},this.removeTarget=function(e){var t=o.indexOf(e);-1!==t&&(o.splice(t,1),n.getDistances(),l(n,e,e,0),n.updateDisableHandlers())},this.remove=function(e){n.removeTarget(e),n.removeSource(e)},this.getSourceElements=function(){return a},this.getTargetElements=function(){return o},this.displayImage=function(e,t,n){r=!0,y.cornerstone.displayImage(e,t,n),r=!1},this.setViewport=function(e,t){r=!0,y.cornerstone.setViewport(e,t),r=!1},this.updateDisableHandlers=function(){Wf(a.concat(o)).forEach((function(e){e.removeEventListener(y.cornerstone.EVENTS.ELEMENT_DISABLED,s),e.addEventListener(y.cornerstone.EVENTS.ELEMENT_DISABLED,s)}))},this.destroy=function(){Wf(a.concat(o)).forEach((function(e){n.remove(e)}))}},Yf=function(e,t,n,a){if(t!==n&&a&&a.direction){var o=y.cornerstone,r=O(n,"stack").data[0],i=r.currentImageIdIndex+a.direction;if(i=In(i,0,r.imageIds.length-1),r.currentImageIdIndex!==i){var l=ls.getStartLoadHandler(n),s=ls.getEndLoadHandler(n),c=ls.getErrorLoadingHandler(n);r.currentImageIdIndex=i;var u=r.imageIds[i];l&&l(n),(!0===r.preventCache?o.loadImage(u):o.loadAndCacheImage(u)).then((function(t){var a=o.getViewport(n);r.currentImageIdIndex===i&&(e.displayImage(n,t,a),s&&s(n,t))}),(function(e){var t=r.imageIds[i];c&&c(n,t,e)}))}}},Xf=function(e,t,n){if(n!==t){var a=y.cornerstone,o=O(t,"stack").data[0],r=o.imageIds[o.currentImageIdIndex],i=a.metaData.get("imagePlaneModule",r);if(void 0!==i&&void 0!==i.imagePositionPatient){var l=en(i.imagePositionPatient),s=O(n,"stack").data[0],c=Number.MAX_VALUE,u=-1;if(s.imageIds.forEach((function(e,t){var n=a.metaData.get("imagePlaneModule",e);if(void 0!==n&&void 0!==n.imagePositionPatient){var o=en(n.imagePositionPatient).distanceToSquared(l);o<c&&(c=o,u=t)}})),u!==s.currentImageIdIndex){var d=ls.getStartLoadHandler(n),f=ls.getEndLoadHandler(n),h=ls.getErrorLoadingHandler(n);s.currentImageIdIndex=u;var v=s.imageIds[u];if(d&&d(n),-1!==u)(!0===s.preventCache?a.loadImage(v):a.loadAndCacheImage(v)).then((function(t){var o=a.getViewport(n);s.currentImageIdIndex===u&&(e.displayImage(n,t,o),f&&f(n,t))}),(function(e){var t=s.imageIds[u];h&&h(n,t,e)}))}}}},Kf=function(e,t,n,a,o){if(n!==t){var r=y.cornerstone,i=O(t,"stack").data[0],l=i.imageIds[i.currentImageIdIndex],s=r.metaData.get("imagePlaneModule",l);if(void 0!==s&&void 0!==s.imagePositionPatient){var c=en(s.imagePositionPatient),u=O(n,"stack").data[0],d=Number.MAX_VALUE,f=-1;if(o){var h=c.clone().add(o);if(u.imageIds.forEach((function(e,t){var n=r.metaData.get("imagePlaneModule",e);if(void 0!==n&&void 0!==n.imagePositionPatient){var a=en(n.imagePositionPatient),o=h.distanceToSquared(a);o<d&&(d=o,f=t)}})),f!==u.currentImageIdIndex&&-1!==f){var v=ls.getStartLoadHandler(n),g=ls.getEndLoadHandler(n),m=ls.getErrorLoadingHandler(n);u.currentImageIdIndex=f;var p=u.imageIds[f];v&&v(n),(!0===u.preventCache?r.loadImage(p):r.loadAndCacheImage(p)).then((function(t){var a=r.getViewport(n);u.currentImageIdIndex===f&&(e.displayImage(n,t,a),g&&g(n,t))}),(function(e){var t=u.imageIds[f];m&&m(n,t,e)}))}}}}},Zf=function(e,t,n){if(n!==t){var a=y.cornerstone,o=O(t,"stack").data[0],r=O(n,"stack").data[0],i=o.currentImageIdIndex;if((i=In(i,0,r.imageIds.length-1))!==r.currentImageIdIndex){var l=ls.getStartLoadHandler(n),s=ls.getEndLoadHandler(n),c=ls.getErrorLoadingHandler(n);l&&l(n),(!0===r.preventCache?a.loadImage(r.imageIds[i]):a.loadAndCacheImage(r.imageIds[i])).then((function(t){var o=a.getViewport(n);r.currentImageIdIndex=i,e.displayImage(n,t,o),s&&s(n,t)}),(function(e){var t=r.imageIds[i];c&&c(n,t,e)}))}}},$f=function(e,t,n){if(n!==t){var a=y.cornerstone,o=a.getViewport(t),r=a.getViewport(n);r.scale===o.scale&&r.translation.x===o.translation.x&&r.translation.y===o.translation.y||(r.scale=o.scale,r.translation.x=o.translation.x,r.translation.y=o.translation.y,e.setViewport(n,r))}},Jf="6.0.6-a",Qf=function(e){return Of[e]},eh={AngleTool:fr,ArrowAnnotateTool:mr,BidirectionalTool:ti,CircleRoiTool:di,CobbAngleTool:mi,EllipticalRoiTool:xi,FreehandRoiTool:Yi,LengthTool:$i,ProbeTool:tl,RectangleRoiTool:ol,TextMarkerTool:ul,BrushTool:vl,SphericalBrushTool:yl,RectangleScissorsTool:Jl,FreehandScissorsTool:Zl,CircleScissorsTool:es,CorrectionScissorsTool:ns,CrosshairsTool:fs,DoubleTapFitToWindowTool:vs,DragProbeTool:ms,EraserTool:Ts,FreehandRoiSculptorTool:Ms,MagnifyTool:Is,OverlayTool:_s,OrientationMarkersTool:Os,PanMultiTouchTool:Bs,PanTool:Fs,ReferenceLinesTool:Zs,RotateTool:Qs,RotateTouchTool:oc,ScaleOverlayTool:lc,StackScrollMouseWheelTool:gc,StackScrollMultiTouchTool:pc,StackScrollTool:xc,WwwcRegionTool:Cc,WwwcTool:Sc,ZoomMouseWheelTool:Oc,ZoomTool:Hc,ZoomTouchPinchTool:jc,init:Jd,stackPrefetch:cf,stackRenderers:ff,playClip:vf,stopClip:gf,store:bt,getModule:Tt,getToolForElement:Ct,addTool:Ud,addToolForElement:Hd,removeTool:pf,removeToolForElement:mf,setToolOptions:Tf,setToolOptionsForElement:xf,isToolActiveForElement:Ia,setToolActive:Pt,setToolActiveForElement:_t,setToolEnabled:Rt,setToolEnabledForElement:Lt,setToolDisabled:Ot,setToolDisabledForElement:Dt,setToolPassive:Ht,setToolPassiveForElement:At,addToolState:D,getToolState:O,removeToolState:L,clearToolState:R,setElementToolStateManager:A,getElementToolStateManager:P,textStyle:pn,toolStyle:Xt,toolColors:un,toolCoordinates:Pr,stackSpecificStateManager:Ef,newStackSpecificToolStateManager:bf,addStackStateManager:Mf,loadHandlerManager:ls,newImageIdSpecificToolStateManager:k,globalImageIdSpecificToolStateManager:_,newFrameOfReferenceSpecificToolStateManager:wf,globalFrameOfReferenceSpecificToolStateManager:If,forceEnabledElementResize:Zd,orientation:Ps,SaveAs:Sf,enableLogger:N,disableLogger:F,importInternal:Qf,import:Qf,register:Ff,registerSome:qf,wwwcSynchronizer:jf,updateImageSynchronizer:zf,Synchronizer:Gf,stackScrollSynchronizer:Yf,stackImagePositionSynchronizer:Xf,stackImagePositionOffsetSynchronizer:Kf,stackImageIndexSynchronizer:Zf,panZoomSynchronizer:$f,external:y,EVENTS:b,version:Jf};t.default=eh}])}));
//# sourceMappingURL=cornerstoneTools.min.js.map