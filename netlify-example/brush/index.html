<!DOCTYPE html>
<html>
  <head>
    <!-- support for mobile touch devices -->
    <meta
      name="viewport"
      content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="stylesheet" href="../reset.css" />
    <link rel="stylesheet" href="../app.css" />
    <link rel="stylesheet" href="../icon-classes.css" />
    <link rel="stylesheet" href="../tool-help.css" />
  </head>

  <body>
    <div id="app">
      <div class="wrapper">
        <!-- Select Tool Category -->
        <ul class="tool-category-list">
          <li><a class="tools" data-category="brush" href="#">Brush</a></li>
          <li>
            <a class="tools" data-category="scissors" href="#">Scissors</a>
          </li>
          <li>
            <a class="tools" data-category="stack" href="#">Stack</a>
          </li>
        </ul>

        <!-- Select Active Tool -->
        <ul class="tool-category active" data-tool-category="brush">
          <li><a href="#" data-tool="Brush">Brush</a></li>
          <li><a href="#" data-tool="SphericalBrush">SphericalBrush</a></li>
        </ul>

        <ul class="tool-category" data-tool-category="scissors">
          <li>
            <a href="#" data-tool="FreehandScissors">FreehandScissors</a>
          </li>
          <li>
            <a href="#" data-tool="RectangleScissors">RectangleScissors</a>
          </li>
          <li>
            <a href="#" data-tool="CircleScissors">CircleScissors</a>
          </li>
          <li>
            <a href="#" data-tool="CorrectionScissors">CorrectionScissors</a>
          </li>
          <li>
            <select
              id="change-scissor-strategy"
              onchange="changeScissorStrategy(this.value)"
            >
              <option value="fillInside">Fill Inside</option>
              <option value="fillOutside">Fill Outside</option>
              <option value="eraseInside">Erase Inside</option>
              <option value="eraseOutside">Erase Outside</option>
            </select>
          </li>
        </ul>

        <ul class="tool-category" data-tool-category="stack">
          <li><a href="#" data-tool="StackScroll">StackScroll</a></li>
          <li><a href="#" data-tool="Pan">Pan</a></li>
          <li><a href="#" data-tool="Zoom">Zoom</a></li>
          <li><a href="#" data-tool="Rotate">Rotate</a></li>
        </ul>

        <!-- Our beautiful element targets -->
        <div class="cornerstone-element-wrapper-help">
          <div
            class="cornerstone-element-help"
            data-index="0"
            oncontextmenu="return false"
          ></div>
          <div class="tool-help">
            <h2>Renderers</h2>
            <table>
              <tr>
                <td>Segmentation Outline</td>
                <td>
                  <input
                    id="display-outline"
                    type="checkbox"
                    name="display-outline"
                    checked
                  />
                </td>
              </tr>
              <tr>
                <td>Segmentation Fill</td>
                <td>
                  <input
                    id="display-fill"
                    type="checkbox"
                    name="display-fill"
                    checked
                  />
                </td>
              </tr>
              <tr>
                <td>Inactive Labelmaps</td>
                <td>
                  <input
                    id="display-inactive"
                    type="checkbox"
                    name="display-inactive"
                    checked
                  />
                </td>
              </tr>
            </table>

            <h2>Active Segmentation</h2>
            <table>
              <tr>
                <th>
                  <button type="button" api-call="next-segment">
                    Next Segment
                  </button>
                </th>
                <td>
                  Switch to the next segment index.
                </td>
              </tr>
              <tr>
                <th>
                  <button type="button" api-call="previous-segment">
                    Previous Segment
                  </button>
                </th>
                <td>
                  Switch to the previous segment index.
                </td>
              </tr>
              <tr>
                <th>
                  <button type="button" api-call="switch-labelmap">
                    Switch Labelmap
                  </button>
                </th>
                <td id="active-label-map-label">
                  Active labelmap: 0
                </td>
              </tr>
              <tr>
                <th>
                  <button type="button" api-call="toggle-segment-1">
                    Toggle Segment 1 visibility
                  </button>
                </th>
                <td id="toggle-segment-1-label">
                  visible
                </td>
              </tr>
            </table>

            <h2>Active Labelmap</h2>
            <table>
              <tr>
                <td>
                  <input type="range" id="fill-alpha" min="0" max="255" />
                </td>
                <td>
                  fillAlpha - Opacity of the active segmentation.
                </td>
              </tr>
              <tr>
                <td>
                  <input type="range" id="outline-alpha" min="0" max="255" />
                </td>
                <td>
                  outlineAlpha - Opacity of the active segmentation outline.
                </td>
              </tr>
            </table>

            <h2>
              Inactive Labelmap
            </h2>

            <table>
              <tr>
                <td>
                  <input
                    type="range"
                    id="fill-alpha-inactive"
                    min="0"
                    max="255"
                  />
                </td>
                <td>
                  fillAlphaInactive - Opacity of inactive segmentations.
                </td>
              </tr>
              <tr>
                <td>
                  <input
                    type="range"
                    id="outline-alpha-inactive"
                    min="0"
                    max="255"
                  />
                </td>
                <td>
                  outlineAlphaInactive - Opacity of inactive segmentation
                  outlines.
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- include the hammer.js library for touch gestures-->
  <script src="https://unpkg.com/hammerjs@2.0.8/hammer.js"></script>
  <!-- include Mousetrap to demo keyboard functionality -->
  <script src="https://unpkg.com/mousetrap@1.6.2/mousetrap.js"></script>

  <!-- include the cornerstone library -->
  <script src="https://unpkg.com/cornerstone-core@2.2.6/dist/cornerstone.js"></script>
  <script src="https://unpkg.com/cornerstone-math@0.1.6/dist/cornerstoneMath.js"></script>
  <script src="https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoader.js"></script>
  <script src="https://unpkg.com/dicom-parser@1.8.3/dist/dicomParser.js"></script>
  <script src="../../dist/cornerstoneTools.js"></script>
  <script>
    window.cornerstoneTools ||
      document.write(
        '<script src="https://unpkg.com/cornerstone-tools">\x3C/script>'
      );
  </script>

  <!-- include special code for these examples which provides images -->
  <script src="../imageLoader.js"></script>
  <script src="../metaDataProvider.js"></script>

  <script>
    cornerstoneTools.init({ showSVGCursors: true });

    cornerstoneWADOImageLoader.external.cornerstone = cornerstone;

    //const baseUrl = window.location.origin;
    //const imageId = `dicomweb:${baseUrl}/examples/assets/dicom/exotic/1.dcm`;
    //const imageId = 'example://1';

    const imageIds = ['example://1', 'example://2'];
    const stack = {
      currentImageIdIndex: 0,
      imageIds: imageIds,
    };

    // Enable & Setup all of our elements
    const element = document.querySelector('.cornerstone-element-help');

    cornerstone.enable(element);

    const enabledElement = cornerstone.getEnabledElement(element);

    element.tabIndex = 0;
    element.focus();

    cornerstone.loadImage(imageIds[0]).then(function(image) {
      cornerstoneTools.addStackStateManager(element, ['stack']);
      cornerstoneTools.addToolState(element, 'stack', stack);
      cornerstone.displayImage(element, image);

      console.log(enabledElement);

      enabledElement.viewport.pixelReplication = true;
    });

    function setAllToolsPassive() {
      cornerstoneTools.store.state.tools.forEach(tool => {
        cornerstoneTools.setToolPassive(tool.name);
      });
    }

    // Iterate over all tool-category links
    const toolCategoryLinks = document.querySelectorAll(
      'ul.tool-category-list a'
    );
    const toolCategorySections = document.querySelectorAll('ul.tool-category');
    Array.from(toolCategoryLinks).forEach(link => {
      //
      const categoryName = link.getAttribute('data-category');
      const categoryElement = document.querySelector(
        `section[data-tool-category="${categoryName}"]`
      );

      // Setup listener
      link.addEventListener('click', evt => {
        evt.preventDefault();
        setToolCategoryActive(categoryName);
      });
    });

    // API calls
    const apiButtons = document.querySelectorAll('button[api-call]');
    Array.from(apiButtons).forEach(apiBtn => {
      const apiCall = apiBtn.getAttribute('api-call');

      apiBtn.addEventListener('mousedown', evt => {
        brushApiCall(apiCall);
      });
    });

    // Iterate over all tool buttons
    const toolButtons = document.querySelectorAll('a[data-tool]');
    Array.from(toolButtons).forEach(toolBtn => {
      // Add the tool
      const toolName = toolBtn.getAttribute('data-tool');
      const apiTool = cornerstoneTools[`${toolName}Tool`];

      console.log(apiTool);

      if (apiTool) {
        cornerstoneTools.addTool(apiTool);
      } else {
        console.warn(`unable to add tool with name ${toolName}Tool`);
        console.log(cornerstoneTools);
      }

      // Setup button listener
      // Prevent right click context menu for our menu buttons
      toolBtn.addEventListener(
        'contextmenu',
        event => event.preventDefault(),
        true
      );
      // Prevent middle click opening a new tab on Chrome & FF
      toolBtn.addEventListener(
        'auxclick',
        event => {
          if (event.button && event.button === 1) {
            event.preventDefault();
          }
        },
        false
      );
      toolBtn.addEventListener('mousedown', evt => {
        const mouseButtonMask = evt.buttons
          ? evt.buttons
          : convertMouseEventWhichToButtons(evt.which);
        // TODO: Let's make this happen automagically for mask/touch conflicts?
        setAllToolsPassive();
        const toolType = evt.target.getAttribute('data-tool-type');
        setButtonActive(toolName, mouseButtonMask, toolType);
        cornerstoneTools.setToolActive(toolName, { mouseButtonMask });

        evt.preventDefault();
        evt.stopPropagation();
        evt.stopImmediatePropagation();
        return false;
      });
    });

    // Activate first tool
    cornerstoneTools.setToolActive(cornerstoneTools.store.state.tools[0].name, {
      mouseButtonMask: 1,
    });

    const setToolCategoryActive = categoryName => {
      Array.from(toolCategoryLinks).forEach(toolLink => {
        if (categoryName === toolLink.getAttribute('data-category')) {
          toolLink.classList.remove('active');
          toolLink.classList.add('active');
        } else {
          toolLink.classList.remove('active');
        }
      });

      Array.from(toolCategorySections).forEach(toolCategorySection => {
        if (
          categoryName ===
          toolCategorySection.getAttribute('data-tool-category')
        ) {
          toolCategorySection.classList.remove('active');
          toolCategorySection.classList.add('active');
        } else {
          toolCategorySection.classList.remove('active');
        }
      });
    };

    const setButtonActive = (toolName, mouseButtonMask, toolType) => {
      Array.from(toolButtons).forEach(toolBtn => {
        // Classes we need to set & remove
        let mouseButtonIcon = `mousebutton-${mouseButtonMask}`;
        let touchIcon = `touch-1`;

        // Update classes depending on the toolType we clicked
        if (toolType === 'none') {
          return;
        } else if (toolType === 'multitouch') {
          mouseButtonIcon = null;
          touchIcon = 'touch-2';
        } else if (toolType === 'pinch') {
          mouseButtonIcon = null;
          touchIcon = 'touch-pinch';
        } else if (toolType === 'wheel') {
          mouseButtonIcon = 'mousebutton-wheel';
          touchIcon = null;
        }

        // Update our target button
        if (toolName === toolBtn.getAttribute('data-tool')) {
          toolBtn.className = '';
          toolBtn.classList.add('active');
          if (mouseButtonIcon) {
            toolBtn.classList.add(mouseButtonIcon);
          }
          if (touchIcon) {
            toolBtn.classList.add(touchIcon);
          }
          // Remove relevant classes from other buttons
        } else {
          if (mouseButtonIcon && toolBtn.classList.contains(mouseButtonIcon)) {
            toolBtn.classList.remove(mouseButtonIcon);
          }
          if (touchIcon && toolBtn.classList.contains(touchIcon)) {
            toolBtn.classList.remove(touchIcon);
          }
          if (
            toolBtn.classList.length === 1 &&
            toolBtn.classList[0] === 'active'
          ) {
            toolBtn.classList.remove('active');
          }
        }
      });
    };

    const convertMouseEventWhichToButtons = which => {
      switch (which) {
        // no button
        case 0:
          return 0;
        // left
        case 1:
          return 1;
        // middle
        case 2:
          return 4;
        // right
        case 3:
          return 2;
      }
      return 0;
    };

    // BRUSH TOOL API //

    const brushTool = cornerstoneTools.getToolForElement(element, 'Brush');

    let activeLabelmap = 0;

    function brushApiCall(opperation) {
      switch (opperation) {
        case 'next-segment':
          brushTool.nextSegment();
          break;
        case 'previous-segment':
          brushTool.previousSegment();
          break;
        case 'switch-labelmap':
          if (activeLabelmap === 0) {
            activeLabelmap = 1;
          } else {
            activeLabelmap = 0;
          }

          cornerstoneTools.store.modules.segmentation.setters.activeLabelmap(
            element,
            activeLabelmap
          );

          const label = document.getElementById('active-label-map-label');
          label.innerHTML = 'Active Labelmap: ' + activeLabelmap;

          cornerstone.updateImage(element);

          break;

        case 'toggle-segment-1':
          const visible = cornerstoneTools.store.modules.segmentation.setters.toggleSegmentVisibility(
            element,
            1
          );

          console.log(visible);

          const visibilityLabel = document.getElementById(
            'toggle-segment-1-label'
          );
          visibilityLabel.innerHTML = visible ? 'visible' : 'hidden';

          cornerstone.updateImage(element);
          break;
        default:
          return;
      }
    }

    const configuration =
      cornerstoneTools.store.modules.segmentation.configuration;

    // Display Outline
    const outlineDisplay = document.getElementById('display-outline');

    outlineDisplay.addEventListener('input', event => {
      configuration.renderOutline = event.target.checked;
      cornerstone.updateImage(element);
    });

    // Display Fill
    const fillDisplay = document.getElementById('display-fill');

    fillDisplay.addEventListener('input', event => {
      configuration.renderFill = event.target.checked;
      cornerstone.updateImage(element);
    });

    // Display Inactive
    const inactiveDisplay = document.getElementById('display-inactive');

    inactiveDisplay.addEventListener('input', event => {
      configuration.renderInactiveLabelmaps = event.target.checked;
      cornerstone.updateImage(element);
    });

    // API Sliders
    // Active Fill
    const alphaSlider = document.getElementById('fill-alpha');

    alphaSlider.defaultValue = Math.floor(configuration.fillAlpha * 255);
    alphaSlider.addEventListener('input', event => {
      const normalisedAlpha = event.target.value / 255.0;

      brushTool.setFillAlpha(normalisedAlpha);
    });

    // Active Outline
    const outlineAlphaSlider = document.getElementById('outline-alpha');

    outlineAlphaSlider.defaultValue = Math.floor(
      configuration.outlineAlpha * 255
    );
    outlineAlphaSlider.addEventListener('input', event => {
      const normalisedAlpha = event.target.value / 255.0;

      brushTool.setOutlineAlpha(normalisedAlpha);
    });

    // Inactive Fill
    const inactiveAlphaSlider = document.getElementById('fill-alpha-inactive');

    inactiveAlphaSlider.defaultValue = Math.floor(
      configuration.fillAlphaInactive * 255
    );
    inactiveAlphaSlider.addEventListener('input', event => {
      const normalisedAlpha = event.target.value / 255.0;

      brushTool.setFillAlphaInactive(normalisedAlpha);
    });

    // Inactive Outline
    const inactiveOutlineAlphaSlider = document.getElementById(
      'outline-alpha-inactive'
    );

    inactiveOutlineAlphaSlider.defaultValue = Math.floor(
      configuration.outlineAlphaInactive * 255
    );
    inactiveOutlineAlphaSlider.addEventListener('input', event => {
      const normalisedAlpha = event.target.value / 255.0;

      brushTool.setOutlineAlphaInactive(normalisedAlpha);
    });

    // Segmentation Tool API
    const freehandScissorsTool = cornerstoneTools.getToolForElement(
      element,
      'FreehandScissors'
    );
    const rectangleScissorsTool = cornerstoneTools.getToolForElement(
      element,
      'RectangleScissors'
    );
    const circleScissorsTool = cornerstoneTools.getToolForElement(
      element,
      'CircleScissors'
    );

    const changeScissorStrategyElement = document.getElementById(
      'change-scissor-strategy'
    );

    changeScissorStrategyElement.value = 'fillInside';

    function changeScissorStrategy(value) {
      console.log(value);
      switch (value) {
        case 'fillInside':
          freehandScissorsTool.changeStrategy('FILL_INSIDE');
          rectangleScissorsTool.changeStrategy('FILL_INSIDE');
          circleScissorsTool.changeStrategy('FILL_INSIDE');
          break;
        case 'eraseInside':
          freehandScissorsTool.changeStrategy('ERASE_INSIDE');
          rectangleScissorsTool.changeStrategy('ERASE_INSIDE');
          circleScissorsTool.changeStrategy('ERASE_INSIDE');
          break;
        case 'fillOutside':
          freehandScissorsTool.changeStrategy('FILL_OUTSIDE');
          rectangleScissorsTool.changeStrategy('FILL_OUTSIDE');
          circleScissorsTool.changeStrategy('FILL_OUTSIDE');
          break;
        case 'eraseOutside':
          freehandScissorsTool.changeStrategy('ERASE_OUTSIDE');
          rectangleScissorsTool.changeStrategy('ERASE_OUTSIDE');
          circleScissorsTool.changeStrategy('ERASE_OUTSIDE');
          break;
      }
    }
  </script>
</html>
